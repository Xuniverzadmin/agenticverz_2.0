# Pre-commit hooks for Agenticverz 2.0
# Install: pip install pre-commit && pre-commit install
#
# GOVERNANCE-SAFE COMMIT MODE (PIN-284)
# =====================================
# Pre-commit hooks must NEVER mutate files.
# All mutation happens EXPLICITLY before staging via `make lint-fix`.
#
# Why: Constitutional code requires audit-clean diffs. Auto-fix during
# commit causes stash conflicts and corrupts governance commits.
#
# Workflow:
#   1. Write code
#   2. Run: make lint-fix (explicit mutation)
#   3. Stage: git add <files>
#   4. Commit: git commit (check-only hooks verify)
#
# Reference: PIN-284 Phase-1 Closure Note, platform-health-v1 tag

repos:
  # Standard Python linting (CHECK-ONLY - no auto-fix)
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.6
    hooks:
      - id: ruff
        args: [--no-fix]  # CHECK ONLY - run `make lint-fix` to fix
      - id: ruff-format
        args: [--check]   # CHECK ONLY - run `make lint-fix` to format

  # Type checking
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.7.1
    hooks:
      - id: mypy
        additional_dependencies: [sqlmodel, fastapi, pydantic]
        args: [--ignore-missing-imports, --no-strict-optional]
        files: ^backend/app/

  # Custom SQLModel pattern linting
  # PIN-269: Pre-commit hooks run in STAGED mode (delta validation only)
  - repo: local
    hooks:
      - id: preflight-routes
        name: Preflight Route Check
        entry: python scripts/ops/preflight.py --routes
        language: python
        types: [python]
        pass_filenames: false
        stages: [pre-commit]

      - id: sqlmodel-patterns
        name: SQLModel Pattern Linter (Staged)
        # PIN-269: CHECK_SCOPE=staged enables delta validation
        # - Only checks staged files (pass_filenames: true)
        # - Skips CI-only rules (DETACH002, SCOPE001, etc.)
        # Full validation runs in CI with CHECK_SCOPE=full
        entry: env CHECK_SCOPE=staged DB_AUTHORITY=local python scripts/ops/lint_sqlmodel_patterns.py
        language: python
        types: [python]
        pass_filenames: true
        files: ^backend/

      - id: api-endpoint-check
        name: API Endpoint Wiring Check
        entry: python scripts/ops/check_api_wiring.py
        language: python
        types: [python]
        pass_filenames: false

  # Prevent secrets in commits
  # Baseline regeneration: pipx run detect-secrets scan --update .secrets.baseline
  # Audit false positives: pipx run detect-secrets audit .secrets.baseline
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        args: ['--baseline', '.secrets.baseline']
        exclude: |
          (?x)^(
            # Lock files
            package-lock\.json|yarn\.lock|.*\.lock|
            # Config examples and backups
            .*\.baseline|.*\.example|.*\.bak\.\d+|\.env.*|
            # Documentation (may contain example credentials)
            docs/.*|memory-pins/.*|agentiverz_mn/.*|.*\.md$|
            # Test files (contain mock credentials)
            .*test.*\.py|.*conftest\.py|.*_test\.py|
            # SDKs and tools (contain examples)
            sdk/.*|tools/.*|helm/.*|k8s/.*|
            # CI/CD and monitoring
            \.github/.*|monitoring/.*|
            # Scripts (contain test API keys)
            scripts/smoke/.*|scripts/stress/.*|scripts/ops/canary/.*|
            # Website/frontend
            website/.*|node_modules/.*
          )$

  # Standard pre-commit hooks (CHECK-ONLY - no auto-fix)
  # PIN-290: Non-Mutating Tooling Invariant
  # Auto-fix hooks (trailing-whitespace, end-of-file-fixer) are REMOVED.
  # Use: make lint-fix for explicit mutation.
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      # REMOVED: trailing-whitespace (auto-fixes)
      # REMOVED: end-of-file-fixer (auto-fixes)
      - id: check-yaml
      - id: check-json
      - id: check-merge-conflict
      - id: check-added-large-files
        args: ['--maxkb=1000']

  # Check-only hooks for whitespace/EOF (replaces auto-fix versions)
  # PIN-290: Non-Mutating Tooling Invariant
  - repo: local
    hooks:
      - id: check-trailing-whitespace
        name: Check trailing whitespace (no auto-fix)
        entry: >-
          bash -c 'files=$(git diff --cached --name-only --diff-filter=ACM |
          grep -E "\.(py|ts|tsx|js|jsx|md|yaml|yml|json|sh)$" |
          xargs -I{} grep -l "[[:blank:]]$" {} 2>/dev/null || true);
          if [ -n "$files" ]; then
          echo "Trailing whitespace found in:"; echo "$files";
          echo "Fix with: make lint-fix"; exit 1; fi'
        language: system
        pass_filenames: false

      - id: check-eof-newline
        name: Check EOF newline (no auto-fix)
        entry: >-
          bash -c 'files=$(git diff --cached --name-only --diff-filter=ACM |
          grep -E "\.(py|ts|tsx|js|jsx|md|yaml|yml|json|sh)$");
          for f in $files; do
          if [ -f "$f" ] && [ -s "$f" ] && [ "$(tail -c1 "$f" | wc -l)" -eq 0 ]; then
          echo "Missing newline at EOF: $f"; exit 1; fi; done'
        language: system
        pass_filenames: false

      # Scope Diff Guard — L8 Enforcement for Closure Commits
      # PIN-290: Prevents closure-tagged commits from mutating frozen scope
      # Reference: POST_CLOSURE_HYGIENE_NOTE.md
      - id: scope-diff-guard
        name: Scope Diff Guard (Closure Commits)
        entry: python scripts/ops/scope_diff_guard.py --verbose
        language: python
        pass_filenames: false
        stages: [pre-commit]
        always_run: true

      # Intent-Aware Worktree Sanity Check
      # PIN-319: Clean Push By Construction governance fix
      # Validates staged files against INTENT_DECLARATION.yaml scope
      # Reference: SESSION_PLAYBOOK.yaml Section 35 (Intent Lock System)
      - id: worktree-sanity
        name: Worktree Sanity Check (Intent Scope)
        entry: python scripts/ops/worktree_sanity_check.py --staged --quiet
        language: python
        pass_filenames: false
        stages: [pre-commit]
        always_run: true

      # Surface-Slot Coverage Guard
      # PIN-365: STEP 2A — Prevents "silent invisibility" bugs
      # Every STEP 1B surface must map to ≥1 UI slot or be marked non-UI
      - id: surface-slot-coverage
        name: Surface-Slot Coverage Guard (PIN-365)
        entry: python scripts/ci/surface_slot_coverage_guard.py
        language: python
        additional_dependencies: [pandas, openpyxl]
        pass_filenames: false
        stages: [pre-commit]
        files: |
          (?x)^(
            design/l2_1/step_2a/.*|
            docs/capabilities/l21_bounded/.*|
            scripts/ci/surface_slot_coverage_guard\.py
          )$

      # Auth Invariant Scanner
      # AUTH_DESIGN.md enforcement — Blocks commits with forbidden auth patterns
      # Reference: docs/AUTH_DESIGN.md
      - id: auth-invariant-scanner
        name: Auth Invariant Scanner
        entry: python scripts/ops/auth_invariant_scanner.py --files
        language: python
        pass_filenames: true
        stages: [pre-commit]
        files: |
          (?x)^(
            backend/app/auth/.*|
            backend/app/api/.*|
            backend/app/services/.*
          )$
