# =============================================================================
# RBAC_RULES.yaml — Canonical Authorization Rules
# =============================================================================
#
# Layer: L4 — Domain Engines (Authorization)
# Product: system-wide
# Reference: PIN-391
#
# INVARIANT: Authorization is declared, not inferred.
#            Code may mirror rules temporarily, but must not invent them.
#
# This file is the SINGLE SOURCE OF TRUTH for RBAC rules.
# All authorization decisions must be derivable from this file.
#
# =============================================================================

# -----------------------------------------------------------------------------
# SCHEMA METADATA (MACHINE-READABLE AUTHORITY)
# -----------------------------------------------------------------------------
_meta:
  schema: RBAC_RULES
  version: "1.0"
  authority: CANONICAL
  enforcement: BLOCKING
  interpretation:
    - "If a rule is missing, access is DENIED"
    - "No fallback inference is permitted"
    - "Temporary rules MUST have expiry"
    - "Claude MUST read this file before any RBAC change"
  stop_file: design/auth/RBAC_READ_BEFORE_EDITING.md
  ci_guard: scripts/ci/check_rbac_alignment.py
  pin: PIN-391

version: "1.0"
schema_version: "2026-01-11"

# -----------------------------------------------------------------------------
# ACCESS TIER DEFINITIONS
# -----------------------------------------------------------------------------
#
# PUBLIC     - Unauthenticated access. Extremely rare. Must have explicit PIN.
# SESSION    - Authenticated user session required.
# PRIVILEGED - Specific permission or role required.
# SYSTEM     - Engine / SDSR / control-plane only. Never user-accessible.
#
# -----------------------------------------------------------------------------

access_tiers:
  PUBLIC:
    description: "Unauthenticated access. Extremely rare."
    requires_auth: false
    requires_permissions: false
  SESSION:
    description: "Authenticated user session required."
    requires_auth: true
    requires_permissions: false
  PRIVILEGED:
    description: "Permission or role required."
    requires_auth: true
    requires_permissions: true
  MACHINE:
    description: "SDK / programmatic access only. No console/browser."
    requires_auth: true
    requires_permissions: true
    console_blocked: true
  SYSTEM:
    description: "Engine / SDSR / control-plane only."
    requires_auth: true
    requires_permissions: true
    system_only: true

# -----------------------------------------------------------------------------
# DIMENSION DEFINITIONS
# -----------------------------------------------------------------------------

dimensions:
  console_kind:
    - customer
    - founder
  environment:
    - preflight
    - production

# -----------------------------------------------------------------------------
# QUERY AUTHORITY DEFAULTS (PIN-392)
# -----------------------------------------------------------------------------
#
# Query authority controls WHAT KIND OF DATA a request may ask for.
# This is orthogonal to route access (WHO may touch WHAT).
#
# INVARIANT: Data queries are privileges.
#            They must be declared, authorized, constrained — not inferred.
#
# -----------------------------------------------------------------------------

query_authority_defaults:
  version: 1
  include_synthetic: false
  include_deleted: false
  include_internal: false
  max_rows: 100
  max_time_range_days: 7
  aggregation: "NONE"       # NONE | BASIC | FULL
  export_allowed: false

# Aggregation levels:
#   NONE  - No aggregation, raw records only
#   BASIC - Count, sum, avg on non-sensitive fields
#   FULL  - All aggregations including sensitive metrics

# -----------------------------------------------------------------------------
# RULES
# -----------------------------------------------------------------------------
#
# Each rule MUST have:
#   - rule_id: Unique identifier
#   - path_prefix: URL path prefix to match
#   - methods: HTTP methods this rule applies to
#   - access_tier: One of PUBLIC, SESSION, PRIVILEGED, SYSTEM
#   - allow_console: Which console kinds can access
#   - allow_environment: Which environments can access
#
# Optional:
#   - pin: Reference PIN for governance traceability
#   - required_permissions: List of permissions (for PRIVILEGED tier)
#   - required_roles: List of roles (for PRIVILEGED tier)
#   - description: Human-readable explanation
#   - temporary: true if this is a tactical exception
#   - expires: Date when temporary rules should be reviewed
#
# -----------------------------------------------------------------------------

rules:

  # ===========================================================================
  # INFRASTRUCTURE / HEALTH
  # ===========================================================================

  - rule_id: HEALTH_CHECK
    path_prefix: /health
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "Health check endpoint for load balancers and monitoring."

  - rule_id: METRICS_ENDPOINT
    path_prefix: /metrics
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "Prometheus metrics endpoint."

  # ===========================================================================
  # DOCUMENTATION
  # ===========================================================================

  - rule_id: OPENAPI_DOCS
    path_prefix: /docs
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "Swagger UI documentation."

  - rule_id: OPENAPI_JSON
    path_prefix: /openapi.json
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "OpenAPI schema JSON."

  - rule_id: REDOC_DOCS
    path_prefix: /redoc
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "ReDoc documentation."

  # ===========================================================================
  # CUS PUBLICATION SURFACES (PIN-306/CAP-011)
  # ===========================================================================
  # Read-only grouped ledger + swagger metadata endpoints.
  # No sensitive data — returns API operation inventories and OpenAPI fragments.

  - rule_id: CUS_PUBLICATION_LEDGER
    path_prefix: /apis/ledger/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "CUS grouped API ledger — read-only operation inventory per domain."

  - rule_id: CUS_PUBLICATION_SWAGGER
    path_prefix: /apis/swagger/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "CUS grouped OpenAPI/swagger — read-only API schema per domain."

  # ===========================================================================
  # DEBUG ENDPOINTS (PIN-444)
  # ===========================================================================
  # OpenAPI health monitoring endpoints for diagnosing schema generation issues.
  # These are PUBLIC for operational debugging but do not expose sensitive data.

  - rule_id: DEBUG_OPENAPI_NOCACHE
    path_prefix: /__debug/openapi_nocache
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "PIN-444: Cache-free OpenAPI generation for debugging schema hangs."
    pin: PIN-444

  - rule_id: DEBUG_OPENAPI_INSPECT
    path_prefix: /__debug/openapi_inspect
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "PIN-444: Inspect OpenAPI schema for problematic patterns."
    pin: PIN-444

  # ===========================================================================
  # AUTHENTICATION
  # ===========================================================================

  - rule_id: AUTH_ENDPOINTS
    path_prefix: /api/v1/auth/
    methods: [GET, POST]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "Authentication endpoints (login, token refresh, etc.)."

  # ===========================================================================
  # SDSR PREFLIGHT VALIDATION (TEMPORARY)
  # ===========================================================================
  #
  # These rules exist for SDSR preflight validation.
  # They allow unauthenticated reads in preflight environment only.
  # MUST be removed or tightened post-SDSR hardening.
  #

  - rule_id: C2_PREDICTIONS_PREFLIGHT
    pin: PIN-370
    path_prefix: /api/v1/c2/predictions/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "C2 predictions for UI rendering."

  - rule_id: ACTIVITY_READ_PREFLIGHT
    pin: PIN-370
    path_prefix: /api/v1/activity/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      max_time_range_days: 30
      aggregation: "BASIC"
    description: >
      SDSR Activity API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: POLICY_PROPOSALS_READ_PREFLIGHT
    pin: PIN-373
    path_prefix: /api/v1/policy-proposals/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      max_time_range_days: 30
      aggregation: "BASIC"
    description: >
      SDSR Policy Proposals API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: INCIDENTS_READ_PREFLIGHT
    pin: PIN-370
    path_prefix: /api/v1/incidents/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      max_time_range_days: 30
      aggregation: "BASIC"
    description: >
      SDSR Incidents API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  # ===========================================================================
  # SDSR FULL SWEEP RULES (PIN-427)
  # ===========================================================================
  #
  # These rules enable HISAR/SDSR full sweep capability verification.
  # They allow unauthenticated reads in preflight environment only.
  #
  # ===========================================================================

  - rule_id: COST_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /cost/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Cost Intelligence API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: POLICY_LAYER_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /api/v1/policy-layer/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Policy Layer API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: FEEDBACK_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /api/v1/feedback/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Feedback API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: PREDICTIONS_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /api/v1/predictions/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Predictions API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: RECOVERY_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /api/v1/recovery/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Recovery API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: DISCOVERY_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /api/v1/discovery/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Discovery API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: TENANTS_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /api/v1/tenants/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Tenants API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: TRACES_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /api/v1/traces/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Traces API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: RUNTIME_TRACES_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /api/v1/runtime/traces/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Runtime Traces API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: GUARD_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /api/v1/guard/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Guard API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: GUARD_LOGS_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /guard/logs/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Guard Logs API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: AGENTS_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /api/v1/agents/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Agents API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: OPS_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /api/v1/ops/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Ops API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: OPS_ACTIONS_AUDIT_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /ops/actions/audit/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Ops Audit API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: STATUS_HISTORY_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /status_history/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Status History API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: INTEGRATION_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /integration/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Integration API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: BILLING_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /billing/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Billing API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: RBAC_AUDIT_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /api/v1/rbac/audit/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR RBAC Audit API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  - rule_id: CUSTOMER_READ_PREFLIGHT
    pin: PIN-427
    path_prefix: /api/v1/customer/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      aggregation: "BASIC"
    description: >
      SDSR Customer API for preflight validation.
      TEMPORARY - must be SESSION tier in production.

  # CUS_ACTIVITY_RUNS_SCAFFOLD_PREFLIGHT removed — PR2: CUS runs require auth (PIN-578)
  # Was: path_prefix: /cus/activity/runs, access_tier: PUBLIC, temporary: true

  # ===========================================================================
  # LOGS DOMAIN V2 (LOGS_DOMAIN_V2_CONTRACT.md)
  # ===========================================================================
  #
  # Unified LOGS facade: /api/v1/logs/*
  # Topics: LLM_RUNS, SYSTEM_LOGS, AUDIT
  # All endpoints are GET-only (no mutations).
  # Export URLs include time-bound signed tokens.
  #
  # ===========================================================================

  - rule_id: LOGS_READ_PREFLIGHT
    pin: LOGS_DOMAIN_V2
    path_prefix: /api/v1/logs/
    methods: [GET]
    access_tier: PUBLIC
    allow_console: [customer]
    allow_environment: [preflight]
    temporary: true
    expires: "2026-03-01"
    query_authority:
      include_synthetic: true
      max_rows: 500
      max_time_range_days: 30
      aggregation: "BASIC"
      export_allowed: true
    description: >
      LOGS Domain V2 unified facade for preflight SDSR validation.
      Covers LLM_RUNS, SYSTEM_LOGS, and AUDIT topics.
      All endpoints are GET-only (immutable records).
      TEMPORARY - must be SESSION tier in production.

  - rule_id: LOGS_READ_PRODUCTION
    pin: LOGS_DOMAIN_V2
    path_prefix: /api/v1/logs/
    methods: [GET]
    access_tier: SESSION
    allow_console: [customer, founder]
    allow_environment: [production]
    required_permissions: [logs.read]
    query_authority:
      include_synthetic: false
      max_rows: 100
      max_time_range_days: 7
      aggregation: "NONE"
      export_allowed: true
    description: >
      LOGS Domain V2 production endpoints.
      Requires authentication. Tenant-scoped access only.

  # ===========================================================================
  # FOUNDER CONSOLE
  # ===========================================================================

  - rule_id: FOUNDER_ENDPOINTS
    path_prefix: /founder/
    methods: [GET, POST, PUT, DELETE]
    access_tier: PUBLIC
    allow_console: [founder]
    allow_environment: [preflight, production]
    description: "Founder console endpoints. Auth handled by console boundary."

  - rule_id: PLATFORM_ENDPOINTS
    path_prefix: /platform/
    methods: [GET, POST, PUT, DELETE]
    access_tier: PUBLIC
    allow_console: [founder]
    allow_environment: [preflight, production]
    description: "Platform endpoints. Auth handled by console boundary."

  # ===========================================================================
  # SDK ENDPOINTS (PIN-399)
  # ===========================================================================

  - rule_id: SDK_ENDPOINTS
    path_prefix: /sdk/
    methods: [GET, POST]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "SDK handshake and registration. Auth handled by API key gateway."

  # ===========================================================================
  # ONBOARDING ENDPOINTS (PIN-399)
  # ===========================================================================

  - rule_id: ONBOARDING_STATUS
    path_prefix: /api/v1/onboarding/
    methods: [GET, POST]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "Onboarding status and progression. Auth handled by gateway."

  # ===========================================================================
  # LEGACY ROUTES (410 GONE)
  # PIN-153: Legacy routes must be public so they can return 410 before auth
  # ===========================================================================

  - rule_id: LEGACY_DASHBOARD
    path_prefix: /dashboard
    methods: [GET, POST]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "Legacy route - returns 410 Gone."

  - rule_id: LEGACY_OPERATOR
    path_prefix: /operator
    methods: [GET, POST]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "Legacy route - returns 410 Gone."

  - rule_id: LEGACY_DEMO
    path_prefix: /demo
    methods: [GET, POST]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "Legacy route - returns 410 Gone."

  - rule_id: LEGACY_SIMULATION
    path_prefix: /simulation
    methods: [GET, POST]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "Legacy route - returns 410 Gone."

  - rule_id: LEGACY_API_OPERATOR
    path_prefix: /api/v1/operator
    methods: [GET, POST]
    access_tier: PUBLIC
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: "Legacy route - returns 410 Gone."

  # ===========================================================================
  # PRODUCTION AUTHENTICATED ENDPOINTS
  # ===========================================================================

  - rule_id: ACTIVITY_READ_PRODUCTION
    path_prefix: /api/v1/activity/
    methods: [GET]
    access_tier: SESSION
    allow_console: [customer, founder]
    allow_environment: [production]
    required_permissions: [activity.read]
    query_authority:
      include_synthetic: false
      max_rows: 100
      max_time_range_days: 7
      aggregation: "NONE"
    description: "Activity API for production - requires authentication."

  - rule_id: INCIDENTS_READ_PRODUCTION
    path_prefix: /api/v1/incidents/
    methods: [GET]
    access_tier: SESSION
    allow_console: [customer, founder]
    allow_environment: [production]
    required_permissions: [incident.read]
    query_authority:
      include_synthetic: false
      max_rows: 100
      max_time_range_days: 7
      aggregation: "NONE"
    description: "Incidents API for production - requires authentication."

  - rule_id: POLICY_PROPOSALS_READ_PRODUCTION
    path_prefix: /api/v1/policy-proposals/
    methods: [GET]
    access_tier: SESSION
    allow_console: [customer, founder]
    allow_environment: [production]
    required_permissions: [policy.read]
    query_authority:
      include_synthetic: false
      max_rows: 100
      max_time_range_days: 7
      aggregation: "NONE"
    description: "Policy Proposals API for production - requires authentication."

  - rule_id: API_KEYS_MANAGE
    pin: PIN-397
    path_prefix: /api/v1/api-keys
    methods: [GET, POST, PUT, DELETE]
    access_tier: SESSION
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    description: >
      API key management endpoints. Tenant from JWT context (AUTH-001).
      Users can list, create, rotate, and revoke their own API keys.

  - rule_id: RUNS_READ
    path_prefix: /api/v1/runs/
    methods: [GET]
    access_tier: SESSION
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    required_permissions: [run.read]
    query_authority:
      include_synthetic: false
      max_rows: 100
      max_time_range_days: 7
      aggregation: "NONE"
    description: "Runs API - requires authentication."

  - rule_id: RUNS_CREATE
    path_prefix: /api/v1/runs/
    methods: [POST]
    access_tier: PRIVILEGED
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    required_permissions: [run.create]
    description: "Create runs - requires run.create permission."

  - rule_id: AGENTS_READ
    path_prefix: /api/v1/agents/
    methods: [GET]
    access_tier: SESSION
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    required_permissions: [agent.read]
    query_authority:
      include_synthetic: false
      max_rows: 100
      max_time_range_days: 30
      aggregation: "NONE"
    description: "Agents API - requires authentication."

  - rule_id: AGENTS_WRITE
    path_prefix: /api/v1/agents/
    methods: [POST, PUT, DELETE]
    access_tier: PRIVILEGED
    allow_console: [customer, founder]
    allow_environment: [preflight, production]
    required_permissions: [agent.write]
    description: "Agent mutations - requires agent.write permission."

  # ===========================================================================
  # CUSTOMER INTEGRATIONS (PIN-440)
  # ===========================================================================
  # Customer LLM integration management APIs. Supports three-mode authority:
  # - LOCAL: Sandbox auth (X-AOS-Customer-Key) with local DB
  # - TEST: Sandbox or JWT auth against Neon test
  # - PROD: JWT only against Neon prod
  #
  # Shared conventions:
  #   access_tier: SESSION (requires authenticated principal)
  #   allow_console: [customer] (never callable by operator implicitly)
  #   allow_environment: [local, preflight, production]
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # Integrations — List & Read
  # ---------------------------------------------------------------------------

  - rule_id: CUS_INTEGRATIONS_LIST
    pin: PIN-440
    path_prefix: /api/v1/cus/integrations
    methods: [GET]
    access_tier: SESSION
    allow_console: [customer]
    allow_environment: [local, preflight, production]
    required_permissions: [customer:integrations:read]
    query_authority:
      include_synthetic: false
      max_rows: 100
      max_time_range_days: 30
      aggregation: "BASIC"
    description: "List customer LLM integrations."

  - rule_id: CUS_INTEGRATIONS_GET
    pin: PIN-440
    path_prefix: /api/v1/cus/integrations/
    methods: [GET]
    access_tier: SESSION
    allow_console: [customer]
    allow_environment: [local, preflight, production]
    required_permissions: [customer:integrations:read]
    description: "Get details of a customer LLM integration."

  # ---------------------------------------------------------------------------
  # Integrations — Create / Update / Delete
  # ---------------------------------------------------------------------------

  - rule_id: CUS_INTEGRATIONS_CREATE
    pin: PIN-440
    path_prefix: /api/v1/cus/integrations
    methods: [POST]
    access_tier: SESSION
    allow_console: [customer]
    allow_environment: [local, preflight, production]
    required_permissions: [customer:integrations:write]
    description: "Create a new customer LLM integration."

  - rule_id: CUS_INTEGRATIONS_UPDATE
    pin: PIN-440
    path_prefix: /api/v1/cus/integrations/
    methods: [PUT]
    access_tier: SESSION
    allow_console: [customer]
    allow_environment: [local, preflight, production]
    required_permissions: [customer:integrations:write]
    description: "Update an existing customer LLM integration."

  - rule_id: CUS_INTEGRATIONS_DELETE
    pin: PIN-440
    path_prefix: /api/v1/cus/integrations/
    methods: [DELETE]
    access_tier: SESSION
    allow_console: [customer]
    allow_environment: [local, preflight, production]
    required_permissions: [customer:integrations:write]
    description: "Soft delete a customer LLM integration."

  # ---------------------------------------------------------------------------
  # Integrations — Lifecycle Control
  # ---------------------------------------------------------------------------

  - rule_id: CUS_INTEGRATIONS_ENABLE
    pin: PIN-440
    path_prefix: /api/v1/cus/integrations/
    path_suffix: /enable
    methods: [POST]
    access_tier: SESSION
    allow_console: [customer]
    allow_environment: [local, preflight, production]
    required_permissions: [customer:integrations:control]
    description: "Enable a customer LLM integration."

  - rule_id: CUS_INTEGRATIONS_DISABLE
    pin: PIN-440
    path_prefix: /api/v1/cus/integrations/
    path_suffix: /disable
    methods: [POST]
    access_tier: SESSION
    allow_console: [customer]
    allow_environment: [local, preflight, production]
    required_permissions: [customer:integrations:control]
    description: "Disable a customer LLM integration."

  # ---------------------------------------------------------------------------
  # Integrations — Health & Validation
  # ---------------------------------------------------------------------------

  - rule_id: CUS_INTEGRATIONS_HEALTH_GET
    pin: PIN-440
    path_prefix: /api/v1/cus/integrations/
    path_suffix: /health
    methods: [GET]
    access_tier: SESSION
    allow_console: [customer]
    allow_environment: [local, preflight, production]
    required_permissions: [customer:integrations:read]
    description: "Get cached health state of an integration."

  - rule_id: CUS_INTEGRATIONS_HEALTH_TEST
    pin: PIN-440
    path_prefix: /api/v1/cus/integrations/
    path_suffix: /test
    methods: [POST]
    access_tier: SESSION
    allow_console: [customer]
    allow_environment: [local, preflight, production]
    required_permissions: [customer:integrations:control]
    description: "Actively test credentials for a customer integration."

  # ---------------------------------------------------------------------------
  # Integrations — Limits & Usage
  # ---------------------------------------------------------------------------

  - rule_id: CUS_INTEGRATIONS_LIMITS_GET
    pin: PIN-440
    path_prefix: /api/v1/cus/integrations/
    path_suffix: /limits
    methods: [GET]
    access_tier: SESSION
    allow_console: [customer]
    allow_environment: [local, preflight, production]
    required_permissions: [customer:integrations:read]
    description: "Get usage and limit status for an integration."

  # ===========================================================================
  # CUSTOMER TELEMETRY (PIN-440) — Read-Only for Customers
  # ===========================================================================
  # Write paths are SDK-only and authenticated separately (MACHINE tier).

  - rule_id: CUS_TELEMETRY_SUMMARY
    pin: PIN-440
    path_prefix: /api/v1/telemetry/usage-summary
    methods: [GET]
    access_tier: SESSION
    allow_console: [customer]
    allow_environment: [local, preflight, production]
    required_permissions: [customer:telemetry:read]
    query_authority:
      include_synthetic: false
      max_rows: 100
      max_time_range_days: 30
      aggregation: "FULL"
    description: "Get aggregated LLM usage summary."

  - rule_id: CUS_TELEMETRY_HISTORY
    pin: PIN-440
    path_prefix: /api/v1/telemetry/usage-history
    methods: [GET]
    access_tier: SESSION
    allow_console: [customer]
    allow_environment: [local, preflight, production]
    required_permissions: [customer:telemetry:read]
    query_authority:
      include_synthetic: false
      max_rows: 1000
      max_time_range_days: 30
      aggregation: "FULL"
    description: "Get detailed LLM usage history."

  - rule_id: CUS_TELEMETRY_DAILY
    pin: PIN-440
    path_prefix: /api/v1/telemetry/daily-aggregates
    methods: [GET]
    access_tier: SESSION
    allow_console: [customer]
    allow_environment: [local, preflight, production]
    required_permissions: [customer:telemetry:read]
    query_authority:
      include_synthetic: false
      max_rows: 365
      max_time_range_days: 365
      aggregation: "FULL"
    description: "Get daily aggregated LLM usage."

  # ===========================================================================
  # CUSTOMER ENFORCEMENT (PIN-440) — Preflight & Status
  # ===========================================================================

  - rule_id: CUS_ENFORCEMENT_CHECK
    pin: PIN-440
    path_prefix: /api/v1/enforcement/check
    methods: [POST]
    access_tier: SESSION
    allow_console: [customer]
    allow_environment: [local, preflight, production]
    required_permissions: [customer:enforcement:check]
    description: "Run a preflight enforcement check."

  - rule_id: CUS_ENFORCEMENT_STATUS
    pin: PIN-440
    path_prefix: /api/v1/enforcement/status
    methods: [GET]
    access_tier: SESSION
    allow_console: [customer]
    allow_environment: [local, preflight, production]
    required_permissions: [customer:enforcement:read]
    query_authority:
      include_synthetic: false
      max_rows: 100
      max_time_range_days: 7
      aggregation: "BASIC"
    description: "Get current enforcement and limit status."

  - rule_id: CUS_ENFORCEMENT_BATCH
    pin: PIN-440
    path_prefix: /api/v1/enforcement/batch
    methods: [POST]
    access_tier: SESSION
    allow_console: [customer]
    allow_environment: [local, preflight, production]
    required_permissions: [customer:enforcement:check]
    description: "Batch preflight enforcement checks."

  # ===========================================================================
  # CUSTOMER VISIBILITY (PIN-440)
  # ===========================================================================

  - rule_id: CUS_VISIBILITY_READ
    pin: PIN-440
    path_prefix: /api/v1/cus/visibility
    methods: [GET]
    access_tier: SESSION
    allow_console: [customer]
    allow_environment: [local, preflight, production]
    required_permissions: [customer:visibility:read]
    query_authority:
      include_synthetic: false
      max_rows: 100
      max_time_range_days: 7
      aggregation: "BASIC"
    description: "Read customer visibility settings and status."

  # ===========================================================================
  # MACHINE-ONLY RULES (SDK Telemetry & Signals)
  # ===========================================================================
  # Scope: SDK → Backend (programmatic only)
  # Caller Type: Machine / SDK
  # Guarantee: Write-only, append-only, no visibility
  #
  # INVARIANT: Machines report truth; humans decide.
  # INVARIANT: Machines may report facts and request decisions,
  #            but they must never observe governance state.
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # Machine Telemetry Ingest
  # ---------------------------------------------------------------------------

  - rule_id: MACHINE_CUS_TELEMETRY_INGEST
    pin: PIN-440
    path_prefix: /api/v1/telemetry/llm-usage
    methods: [POST]
    access_tier: MACHINE
    allow_console: []
    allow_environment: [local, preflight, production]
    required_permissions: [machine:telemetry:write]
    description: "SDK telemetry ingest (single LLM call). Write-only."

  - rule_id: MACHINE_CUS_TELEMETRY_BATCH_INGEST
    pin: PIN-440
    path_prefix: /api/v1/telemetry/llm-usage/batch
    methods: [POST]
    access_tier: MACHINE
    allow_console: []
    allow_environment: [local, preflight, production]
    required_permissions: [machine:telemetry:write]
    description: "SDK telemetry ingest (batch). Write-only."

  # ---------------------------------------------------------------------------
  # Machine Enforcement Checks
  # ---------------------------------------------------------------------------

  - rule_id: MACHINE_CUS_ENFORCEMENT_PREFLIGHT
    pin: PIN-440
    path_prefix: /api/v1/enforcement/check
    methods: [POST]
    access_tier: MACHINE
    allow_console: []
    allow_environment: [local, preflight, production]
    required_permissions: [machine:enforcement:check]
    description: "SDK preflight enforcement check. Decision-only."

  - rule_id: MACHINE_CUS_ENFORCEMENT_BATCH
    pin: PIN-440
    path_prefix: /api/v1/enforcement/batch
    methods: [POST]
    access_tier: MACHINE
    allow_console: []
    allow_environment: [local, preflight, production]
    required_permissions: [machine:enforcement:check]
    description: "SDK batch preflight enforcement checks."

# =============================================================================
# PERMISSION VOCABULARY (CANONICAL)
# =============================================================================
#
# Customer permissions:
#   customer:integrations:read
#   customer:integrations:write
#   customer:integrations:control
#   customer:telemetry:read
#   customer:enforcement:read
#   customer:enforcement:check
#   customer:visibility:read
#
# Machine permissions (distinct from customer):
#   machine:telemetry:write
#   machine:enforcement:check
#
# No overlap between customer:* and machine:*
#
# =============================================================================

# =============================================================================
# END OF RULES
# =============================================================================
