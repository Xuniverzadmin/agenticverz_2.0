# Docker Compose for staging webhook receiver
#
# Usage:
#   docker-compose -f docker-compose.staging.yml up -d
#
# Services:
#   - webhook-db: PostgreSQL database for webhooks
#   - webhook: FastAPI webhook receiver
#
# Endpoints:
#   - POST http://localhost:8081/webhook - Receive webhooks
#   - GET http://localhost:8081/webhooks - List webhooks
#   - GET http://localhost:8081/stats - Statistics
#   - GET http://localhost:8081/health - Health check

version: '3.8'

services:
  webhook-db:
    image: postgres:15-alpine
    container_name: aos_webhook_db
    environment:
      POSTGRES_USER: webhook
      POSTGRES_PASSWORD: webhook
      POSTGRES_DB: webhook
    volumes:
      - webhook_db_data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U webhook -d webhook"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aos_staging

  webhook:
    build:
      context: ./tools/webhook_receiver
      dockerfile: Dockerfile
    container_name: aos_webhook_receiver
    environment:
      DATABASE_URL: postgresql://webhook:webhook@webhook-db:5432/webhook
      WEBHOOK_TOKEN: ${WEBHOOK_TOKEN:-aos-staging-token}
      WEBHOOK_SECRET: ${WEBHOOK_SECRET:-}
      RETENTION_DAYS: ${RETENTION_DAYS:-30}
      MAX_BODY_SIZE: ${MAX_BODY_SIZE:-1048576}
    ports:
      - "8081:8080"
    depends_on:
      webhook-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - aos_staging

volumes:
  webhook_db_data:
    driver: local

networks:
  aos_staging:
    driver: bridge
