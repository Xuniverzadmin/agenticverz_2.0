# C1 Telemetry Plane Guard
# Blocks merge if C1 invariants are violated
#
# Reference: PIN-210, docs/certification/C1_CERTIFICATION_STATEMENT.md
#
# C1 Invariants (must ALL hold):
#   I1: Traces/Incidents persist correctly
#   I2: Replay output identical (hash-stable)
#   I3: No telemetry-caused incidents
#   I4: No blocking of execution
#   I5: O1 endpoints unaffected
#   I6: Telemetry may be lost without consequence

name: C1 Telemetry Guard

on:
  push:
    branches: [main, develop, 'feature/*']
    paths:
      - 'backend/alembic/versions/**'
      - 'backend/app/telemetry/**'
      - 'scripts/verification/c1_telemetry_probes.py'
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/alembic/versions/**'
      - 'backend/app/telemetry/**'
      - 'scripts/verification/c1_telemetry_probes.py'
  workflow_dispatch:
    inputs:
      run_full_matrix:
        description: 'Run full failure injection matrix'
        required: false
        default: 'false'

env:
  PYTHONPATH: backend

jobs:
  # ============================================================================
  # C1 TELEMETRY PROBES - SQL Verification (MANDATORY)
  # ============================================================================
  c1-sql-probes:
    name: C1 SQL Probes
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: nova
          POSTGRES_PASSWORD: novapass
          POSTGRES_DB: nova_aos
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://nova:novapass@localhost:5433/nova_aos

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install psycopg2-binary

      - name: Wait for PostgreSQL
        run: |
          echo "Waiting for PostgreSQL..."
          for i in {1..30}; do
            if PGPASSWORD=novapass psql -h localhost -p 5433 -U nova -d nova_aos -c "SELECT 1" > /dev/null 2>&1; then
              echo "PostgreSQL is ready!"
              exit 0
            fi
            sleep 2
          done
          echo "PostgreSQL failed to become ready"
          exit 1

      - name: Run Alembic migrations
        run: |
          cd backend
          alembic upgrade head
          echo "=== Current migration state ==="
          alembic current

      - name: Verify telemetry_event table exists
        run: |
          PGPASSWORD=novapass psql -h localhost -p 5433 -U nova -d nova_aos -c "
            SELECT table_name FROM information_schema.tables
            WHERE table_name = 'telemetry_event'
          " | grep -q telemetry_event || {
            echo "::error::telemetry_event table not found after migrations"
            exit 1
          }
          echo "âœ… telemetry_event table exists"

      - name: Verify CHECK constraint exists
        run: |
          PGPASSWORD=novapass psql -h localhost -p 5433 -U nova -d nova_aos -c "
            SELECT constraint_name FROM information_schema.check_constraints
            WHERE constraint_name = 'chk_never_authoritative'
          " | grep -q chk_never_authoritative || {
            echo "::error::chk_never_authoritative constraint not found"
            exit 1
          }
          echo "âœ… chk_never_authoritative constraint exists"

      - name: Run C1 SQL Probes
        id: probes
        run: |
          echo "======================================"
          echo "C1 TELEMETRY PLANE - SQL PROBES"
          echo "======================================"
          echo ""

          cd backend
          python3 ../scripts/verification/c1_telemetry_probes.py --sql-probes --json > /tmp/c1_probes.json 2>&1
          EXIT_CODE=$?

          # Parse results
          PASSED=$(jq '[.[] | select(.passed == true)] | length' /tmp/c1_probes.json)
          FAILED=$(jq '[.[] | select(.passed == false)] | length' /tmp/c1_probes.json)
          TOTAL=$(jq 'length' /tmp/c1_probes.json)

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          echo ""
          echo "=== Results ==="
          echo "Passed: $PASSED"
          echo "Failed: $FAILED"
          echo "Total: $TOTAL"

          if [ "$FAILED" -gt 0 ]; then
            echo "::error::C1 INVARIANT VIOLATION: $FAILED probe(s) failed"
            jq -r '.[] | select(.passed == false) | "  âŒ \(.name): \(.actual)"' /tmp/c1_probes.json
            exit 1
          fi

          echo "âœ… All C1 invariants verified"

      - name: Generate C1 Summary
        if: always()
        run: |
          echo "## ðŸ”’ C1 Telemetry Guard" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Probes Passed | ${{ steps.probes.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Probes Failed | ${{ steps.probes.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total | ${{ steps.probes.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.probes.outputs.failed }}" == "0" ]; then
            echo "âœ… **C1 Telemetry Plane: ALL INVARIANTS HOLD**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **C1 INVARIANT VIOLATION - MERGE BLOCKED**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Reference: PIN-210, C1_CERTIFICATION_STATEMENT.md" >> $GITHUB_STEP_SUMMARY

      - name: Upload probe results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: c1-probe-results
          path: /tmp/c1_probes.json
          if-no-files-found: ignore

  # ============================================================================
  # C1 SCHEMA GUARD - Prevents forbidden changes
  # ============================================================================
  c1-schema-guard:
    name: C1 Schema Guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for forbidden telemetry changes
        run: |
          echo "======================================"
          echo "C1 SCHEMA GUARD"
          echo "======================================"
          echo ""
          echo "Checking for forbidden changes per C1 certification..."
          echo ""

          # Get changed files
          CHANGED=$(git diff --name-only origin/main...HEAD 2>/dev/null || git diff --name-only HEAD~1 HEAD)

          # Check for forbidden patterns
          VIOLATIONS=""

          # Check for FK constraints being added to telemetry
          for file in $(echo "$CHANGED" | grep "alembic/versions"); do
            if [ -f "$file" ]; then
              # Check for ForeignKey to telemetry_event
              if grep -l "ForeignKey.*telemetry_event" "$file" 2>/dev/null; then
                VIOLATIONS="${VIOLATIONS}âŒ $file: Adds FK to telemetry_event (BLOCKED by C1)\n"
              fi

              # Check for telemetry_event FK to truth tables
              if grep -l "telemetry_event.*ForeignKey" "$file" 2>/dev/null; then
                VIOLATIONS="${VIOLATIONS}âŒ $file: Adds FK from telemetry_event (BLOCKED by C1)\n"
              fi
            fi
          done

          # Check for telemetry imports in truth paths
          TRUTH_PATHS=("app/worker/runtime" "app/workflow" "app/api/v1/runs.py" "app/api/v1/traces.py")
          for path in "${TRUTH_PATHS[@]}"; do
            for file in $(echo "$CHANGED" | grep "$path"); do
              if [ -f "$file" ]; then
                if grep -l "from.*telemetry\|import.*telemetry" "$file" 2>/dev/null; then
                  VIOLATIONS="${VIOLATIONS}âš ï¸ $file: Imports telemetry module (review required)\n"
                fi
              fi
            done
          done

          if [ -n "$VIOLATIONS" ]; then
            echo "::error::C1 Schema Guard violations detected!"
            echo ""
            echo "Violations:"
            echo -e "$VIOLATIONS"
            echo ""
            echo "These changes violate C1 certification requirements."
            echo "See: docs/certification/C1_CERTIFICATION_STATEMENT.md"
            exit 1
          fi

          echo "âœ… No C1 schema violations detected"

      - name: Check for telemetry migration changes
        run: |
          # If 060_c1_telemetry_plane.py is modified, require re-certification
          CHANGED=$(git diff --name-only origin/main...HEAD 2>/dev/null || git diff --name-only HEAD~1 HEAD)

          if echo "$CHANGED" | grep -q "060_c1_telemetry_plane"; then
            echo "::warning::Migration 060_c1_telemetry_plane.py modified - C1 re-certification required"
            echo ""
            echo "If this change is intentional:"
            echo "  1. Run full C1 verification locally"
            echo "  2. Update C1_CERTIFICATION_STATEMENT.md"
            echo "  3. Get human approval"
          fi

  # ============================================================================
  # C1 DELETE-SAFETY TEST (Quick verification)
  # ============================================================================
  c1-delete-safety:
    name: C1 Delete-Safety
    runs-on: ubuntu-latest
    needs: c1-sql-probes
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: nova
          POSTGRES_PASSWORD: novapass
          POSTGRES_DB: nova_aos
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://nova:novapass@localhost:5433/nova_aos

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install psycopg2-binary

      - name: Wait for PostgreSQL
        run: |
          for i in {1..30}; do
            if PGPASSWORD=novapass psql -h localhost -p 5433 -U nova -d nova_aos -c "SELECT 1" > /dev/null 2>&1; then
              exit 0
            fi
            sleep 2
          done
          exit 1

      - name: Run migrations
        run: |
          cd backend
          alembic upgrade head

      - name: Seed test data
        run: |
          PGPASSWORD=novapass psql -h localhost -p 5433 -U nova -d nova_aos << 'EOF'
          -- Create a test run and incident
          INSERT INTO runs (id, tenant_id, agent_id, status, created_at)
          VALUES ('11111111-1111-1111-1111-111111111111', 'test-tenant', 'test-agent', 'completed', NOW())
          ON CONFLICT DO NOTHING;

          INSERT INTO costsim_cb_incidents (run_id, tenant_hash, reason, severity, created_at)
          VALUES ('11111111-1111-1111-1111-111111111111', 'test-hash', 'test incident', 'low', NOW())
          ON CONFLICT DO NOTHING;

          -- Insert telemetry (will be deleted)
          INSERT INTO telemetry_event (tenant_hash, source_module, signal_type, signal_payload, authoritative)
          VALUES ('test-hash', 'test', 'test', '{}', FALSE);
          EOF
          echo "âœ… Test data seeded"

      - name: Drop telemetry table (W3 injection)
        run: |
          PGPASSWORD=novapass psql -h localhost -p 5433 -U nova -d nova_aos -c "
            DROP TABLE IF EXISTS telemetry_event CASCADE;
          "
          echo "âœ… telemetry_event table dropped"

      - name: Verify truth tables still accessible (I1)
        run: |
          echo "Verifying truth tables are accessible after telemetry deletion..."

          # Check runs table
          RUNS=$(PGPASSWORD=novapass psql -h localhost -p 5433 -U nova -d nova_aos -t -c "SELECT COUNT(*) FROM runs")
          echo "Runs accessible: $RUNS rows"

          # Check incidents table
          INCIDENTS=$(PGPASSWORD=novapass psql -h localhost -p 5433 -U nova -d nova_aos -t -c "SELECT COUNT(*) FROM costsim_cb_incidents")
          echo "Incidents accessible: $INCIDENTS rows"

          if [ "$RUNS" -lt 0 ] || [ "$INCIDENTS" -lt 0 ]; then
            echo "::error::Truth tables not accessible after telemetry deletion"
            exit 1
          fi

          echo "âœ… I1 VERIFIED: Truth tables independent of telemetry"

      - name: Verify no telemetry-caused incidents (I3)
        run: |
          TELEMETRY_INCIDENTS=$(PGPASSWORD=novapass psql -h localhost -p 5433 -U nova -d nova_aos -t -c "
            SELECT COUNT(*) FROM costsim_cb_incidents
            WHERE reason ILIKE '%telemetry%'
          ")

          if [ "$TELEMETRY_INCIDENTS" -gt 0 ]; then
            echo "::error::Telemetry-caused incidents exist: $TELEMETRY_INCIDENTS"
            exit 1
          fi

          echo "âœ… I3 VERIFIED: No telemetry-caused incidents"

      - name: Summary
        run: |
          echo "======================================"
          echo "C1 DELETE-SAFETY: VERIFIED"
          echo "======================================"
          echo ""
          echo "âœ… I1: Truth tables persist after telemetry deletion"
          echo "âœ… I3: No telemetry-caused incidents"
          echo "âœ… I6: Telemetry deletable without consequence"
