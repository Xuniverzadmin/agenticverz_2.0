# CI Preflight Check - Runs consistency check before main CI
# This catches configuration issues early before wasting CI minutes
#
# Checks:
# 1. CI consistency check (files, patterns)
# 2. Route conflict detection (preflight.py)
# 3. Code hygiene check (postflight.py)

name: CI Preflight

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  preflight:
    name: Consistency Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run CI consistency check
        run: |
          chmod +x ./scripts/ops/ci_consistency_check.sh
          ./scripts/ops/ci_consistency_check.sh --quick
        env:
          # Skip git checks in CI (already clean checkout)
          CI: true

      # ========================================================================
      # Route Conflict Detection
      # ========================================================================
      - name: Check for route conflicts
        id: route-check
        run: |
          echo "ðŸ” Checking for FastAPI route conflicts..."
          chmod +x ./scripts/ops/preflight.py

          # Run route check and capture output
          OUTPUT=$(python3 ./scripts/ops/preflight.py --routes 2>&1)
          echo "$OUTPUT"

          # Check for conflicts (errors)
          if echo "$OUTPUT" | grep -q "Route conflict:"; then
            echo "::error::Route conflicts detected! Static routes must come before parameter routes."
            echo "route_conflicts=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… No route conflicts detected"
            echo "route_conflicts=false" >> $GITHUB_OUTPUT
          fi

      # ========================================================================
      # Code Hygiene Check (Quick)
      # ========================================================================
      - name: Run code hygiene check
        id: hygiene-check
        run: |
          echo "ðŸ” Running quick code hygiene check..."
          chmod +x ./scripts/ops/postflight.py

          # Run quick check (syntax, imports, security)
          python3 ./scripts/ops/postflight.py --quick --json > /tmp/hygiene.json 2>&1 || true

          # Parse results
          ERRORS=$(python3 -c "import json; d=json.load(open('/tmp/hygiene.json')); print(d.get('summary',{}).get('errors',0))" 2>/dev/null || echo "0")
          WARNINGS=$(python3 -c "import json; d=json.load(open('/tmp/hygiene.json')); print(d.get('summary',{}).get('warnings',0))" 2>/dev/null || echo "0")

          echo "hygiene_errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "hygiene_warnings=$WARNINGS" >> $GITHUB_OUTPUT

          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Code hygiene check found $ERRORS error(s)"
            python3 ./scripts/ops/postflight.py --quick
            exit 1
          else
            echo "âœ… Code hygiene check passed (errors: $ERRORS, warnings: $WARNINGS)"
          fi

      # ========================================================================
      # Security Scan
      # ========================================================================
      - name: Security scan
        run: |
          echo "ðŸ”’ Scanning for security issues..."

          # Check for hardcoded secrets (basic patterns)
          FOUND_SECRETS=0

          # Check for patterns that look like real API keys (long alphanumeric strings in non-test files)
          if grep -r --include="*.py" -E "(api_key|secret|password)\s*=\s*['\"][a-zA-Z0-9\-_]{32,}['\"]" backend/app/ 2>/dev/null | grep -v "test_" | grep -v "os\.getenv" | grep -v "environ" | head -5; then
            echo "::warning::Potential hardcoded secrets found - please review"
            FOUND_SECRETS=1
          fi

          if [ "$FOUND_SECRETS" -eq 0 ]; then
            echo "âœ… No obvious hardcoded secrets found"
          fi

      - name: Verify required files exist
        run: |
          echo "Checking required files..."

          # CI workflow
          test -f .github/workflows/ci.yml || { echo "ERROR: ci.yml missing"; exit 1; }

          # Core application
          test -f backend/app/main.py || { echo "ERROR: main.py missing"; exit 1; }

          # Test infrastructure
          test -f backend/tests/conftest.py || { echo "ERROR: conftest.py missing"; exit 1; }

          # Concurrency limiter (must have atomic operations)
          grep -q "ACQUIRE_SCRIPT\|Lua" backend/app/utils/concurrent_runs.py || {
            echo "ERROR: Concurrency limiter missing atomic operations"
            exit 1
          }

          echo "All required files present"

      - name: Verify pgvector infrastructure
        run: |
          echo "Checking pgvector infrastructure..."

          # Vector store must exist
          test -f backend/app/memory/vector_store.py || {
            echo "ERROR: vector_store.py missing"
            exit 1
          }

          # Must have HNSW index reference
          grep -q "hnsw\|HNSW" backend/app/memory/vector_store.py || {
            echo "WARNING: vector_store.py should reference HNSW index"
          }

          # Embedding metrics must exist
          test -f backend/app/memory/embedding_metrics.py || {
            echo "ERROR: embedding_metrics.py missing"
            exit 1
          }

          # Must have feature flags
          grep -q "VECTOR_SEARCH_ENABLED" backend/app/memory/embedding_metrics.py || {
            echo "ERROR: VECTOR_SEARCH_ENABLED flag missing"
            exit 1
          }

          # Backfill script should exist
          test -f backend/scripts/backfill_memory_embeddings.py || {
            echo "WARNING: backfill script missing - embeddings may need manual backfill"
          }

          echo "pgvector infrastructure verified"

      - name: Check for common CI anti-patterns
        run: |
          echo "Checking for anti-patterns..."

          # Check for || true on pytest (silent failures)
          if grep -r "pytest.*|| *true" .github/workflows/; then
            echo "WARNING: Found '|| true' on pytest - failures may be silently ignored"
          fi

          # Check for missing PYTHONUNBUFFERED on worker processes
          if grep -q "python.*worker" .github/workflows/ci.yml; then
            if ! grep -q "PYTHONUNBUFFERED" .github/workflows/ci.yml; then
              echo "WARNING: Worker processes should have PYTHONUNBUFFERED=1"
            fi
          fi

          echo "Anti-pattern check complete"

  # Gate for main CI - only runs if preflight passes
  ci-gate:
    name: CI Gate
    needs: preflight
    runs-on: ubuntu-latest
    steps:
      - run: echo "Preflight passed, CI can proceed"
