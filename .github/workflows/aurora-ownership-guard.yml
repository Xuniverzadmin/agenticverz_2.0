name: AURORA L2 Ownership Guard

on:
  pull_request:
    paths:
      - 'backend/AURORA_L2_CAPABILITY_REGISTRY/**'
      - 'design/l2_1/ui_contract/**'
      - 'backend/scripts/sdsr/observations/**'
      - 'design/l2_1/intents/**'

jobs:
  ownership-guard:
    name: Verify Machine-Owned Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Capability Registry Changes
        id: check-capability
        run: |
          echo "Checking capability registry changes..."

          # Get changed files in capability registry
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- 'backend/AURORA_L2_CAPABILITY_REGISTRY/*.yaml' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No capability registry changes"
            exit 0
          fi

          echo "Changed capability files:"
          echo "$CHANGED_FILES"

          # Check each changed file for forbidden manual edits
          VIOLATIONS=""
          for FILE in $CHANGED_FILES; do
            if [ -f "$FILE" ]; then
              # Check if status field was changed manually
              # Get the diff for this file
              DIFF=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- "$FILE")

              # Check for status changes that aren't from automation
              if echo "$DIFF" | grep -E "^\+status:" | grep -v "DECLARED" > /dev/null; then
                # Only automation can set OBSERVED/TRUSTED
                if ! echo "$DIFF" | grep "Updated By: aurora" > /dev/null; then
                  VIOLATIONS="$VIOLATIONS\n- $FILE: Manual status change detected"
                fi
              fi
            fi
          done

          if [ -n "$VIOLATIONS" ]; then
            echo "::error::AURORA OWNERSHIP VIOLATION"
            echo "::error::Capability status is machine-owned. Do not edit manually."
            echo "::error::Use SDSR automation to change capability status."
            echo -e "Violations:$VIOLATIONS"
            exit 1
          fi

          echo "✅ Capability registry changes are valid"

      - name: Check Projection Lock Changes
        id: check-projection
        run: |
          echo "Checking projection lock changes..."

          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- 'design/l2_1/ui_contract/ui_projection_lock.json' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No projection lock changes"
            exit 0
          fi

          echo "::warning::Projection lock was modified"
          echo "Projection should only be modified by the compiler."
          echo "Verify this change came from: run_aurora_l2_pipeline.sh"

      - name: Check Observation Changes
        id: check-observations
        run: |
          echo "Checking observation changes..."

          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- 'backend/scripts/sdsr/observations/*.json' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No observation changes"
            exit 0
          fi

          echo "Changed observation files:"
          echo "$CHANGED_FILES"

          # Observations should only be created by aurora_sdsr_runner.py
          for FILE in $CHANGED_FILES; do
            if [ -f "$FILE" ]; then
              echo "Verifying $FILE..."
              # Check it's valid JSON
              if ! python3 -c "import json; json.load(open('$FILE'))" 2>/dev/null; then
                echo "::error::Invalid JSON in observation file: $FILE"
                exit 1
              fi
            fi
          done

          echo "✅ Observation files are valid"

      - name: Check Intent YAML SDSR Fields
        id: check-intent-sdsr
        run: |
          echo "Checking intent YAML SDSR fields..."

          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- 'design/l2_1/intents/*.yaml' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No intent changes"
            exit 0
          fi

          # Check for manual sdsr.verified changes
          for FILE in $CHANGED_FILES; do
            if [ -f "$FILE" ]; then
              DIFF=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- "$FILE")

              # Check if sdsr.verified was changed to true manually
              if echo "$DIFF" | grep -E "^\+.*verified: true" > /dev/null; then
                # This should only come from automation
                if ! echo "$DIFF" | grep "aurora_apply_observation" > /dev/null; then
                  echo "::warning::Intent $FILE has sdsr.verified changed"
                  echo "This should only be set by SDSR automation"
                fi
              fi
            fi
          done

          echo "✅ Intent YAML changes verified"

  coherency-check:
    name: Run Coherency Gate
    runs-on: ubuntu-latest
    needs: ownership-guard

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml requests

      - name: Run Coherency Check on Changed Intents
        run: |
          # Get changed intent files
          CHANGED_INTENTS=$(git diff --name-only origin/main -- 'design/l2_1/intents/*.yaml' 2>/dev/null || true)

          if [ -z "$CHANGED_INTENTS" ]; then
            echo "No intent changes to check"
            exit 0
          fi

          # Extract panel IDs
          for FILE in $CHANGED_INTENTS; do
            PANEL_ID=$(basename "$FILE" .yaml)
            echo "Checking coherency for: $PANEL_ID"

            python3 backend/aurora_l2/tools/aurora_coherency_check.py --panel "$PANEL_ID" --refresh-routes || true
          done

      - name: Summary
        run: |
          echo "## AURORA L2 Ownership Guard Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Machine-Owned Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Capability Registry: Status transitions are machine-only" >> $GITHUB_STEP_SUMMARY
          echo "- Projection Lock: Compiler output only" >> $GITHUB_STEP_SUMMARY
          echo "- Observations: SDSR runner output only" >> $GITHUB_STEP_SUMMARY
          echo "- Intent SDSR fields: Automation output only" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Human-Owned Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- ui_plan.yaml: UI surface constraint" >> $GITHUB_STEP_SUMMARY
          echo "- Intent display/notes: Semantic content" >> $GITHUB_STEP_SUMMARY
          echo "- Intent registry approval: DRAFT → APPROVED" >> $GITHUB_STEP_SUMMARY
