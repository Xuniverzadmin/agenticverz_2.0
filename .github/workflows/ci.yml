# AOS CI Pipeline
# Runs on every push and PR
# Enforces quality gates before merge

name: CI

on:
  push:
    branches: [main, develop, 'feature/*']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      skip_slow_tests:
        description: 'Skip slow tests'
        required: false
        default: 'false'

env:
  PYTHONPATH: backend
  # Use Neon if available (via secret), otherwise fall back to local Docker Postgres
  # Set NEON_DATABASE_URL in GitHub Secrets for managed DB testing
  DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
  REDIS_URL: ${{ secrets.UPSTASH_REDIS_URL || 'redis://localhost:6379/0' }}

jobs:
  # Migration drift guard - verifies all migrations are committed
  migration-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for uncommitted migrations
        run: |
          echo "=== Migration Drift Guard ==="
          ALEMBIC_DIR="backend/alembic/versions"

          # Check for uncommitted migration files
          UNCOMMITTED=$(git ls-files --others --exclude-standard "$ALEMBIC_DIR" 2>/dev/null | grep -v "__pycache__" || true)
          MODIFIED=$(git diff --name-only "$ALEMBIC_DIR" 2>/dev/null | grep -v "__pycache__" || true)

          if [[ -n "$UNCOMMITTED" ]]; then
            echo "::error::Uncommitted migration files found!"
            echo "$UNCOMMITTED"
            exit 1
          fi

          if [[ -n "$MODIFIED" ]]; then
            echo "::error::Modified migration files not staged!"
            echo "$MODIFIED"
            exit 1
          fi

          # List committed migrations
          echo "Migration files in repository:"
          ls -1 "$ALEMBIC_DIR"/*.py 2>/dev/null | grep -v "__pycache__" | xargs -I {} basename {} | sort
          echo ""
          echo "OK: All migrations committed"

  # Fast unit tests (no external deps)
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
          
      - name: Run unit tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/schemas -v -m "not slow" --maxfail=3
          
      - name: Run skill tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/skills -v --maxfail=3

  # Determinism certification (critical)
  determinism:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run replay certification
        run: |
          cd backend
          PYTHONPATH=. pytest tests/workflow/test_replay_certification.py -v

      - name: Run registry snapshot test
        run: |
          cd backend
          PYTHONPATH=. pytest tests/integration/test_registry_snapshot.py -v

  # M4: Workflow Engine tests (critical for determinism)
  workflow-engine:
    runs-on: ubuntu-latest
    needs: determinism
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run workflow engine smoke tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/workflow/test_engine_smoke.py -v

      - name: Run checkpoint store tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/workflow/test_checkpoint_store.py -v

      - name: Run golden-file pipeline tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/workflow/test_workflow_golden_pipeline.py -v

  # M4: Golden-file replay check (blocks merge on diff)
  workflow-golden-check:
    runs-on: ubuntu-latest
    needs: workflow-engine
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run golden replay verification
        env:
          GOLDEN_SECRET: ${{ secrets.GOLDEN_SECRET }}
        run: |
          cd backend
          PYTHONPATH=. pytest tests/workflow/test_workflow_golden_pipeline.py -v -k "compare"

      - name: Upload golden artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: golden-diff
          path: backend/artifacts/golden-diff/

  # Integration tests (require services)
  # Uses Neon if NEON_DATABASE_URL secret is set, otherwise Docker Postgres
  integration:
    runs-on: ubuntu-latest
    needs: determinism
    services:
      # Docker Postgres - only used when NEON_DATABASE_URL is not set
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: nova
          POSTGRES_PASSWORD: novapass
          POSTGRES_DB: nova_aos
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      # Docker Redis - only used when UPSTASH_REDIS_URL is not set
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Check database source
        run: |
          if [ -n "${{ secrets.NEON_DATABASE_URL }}" ]; then
            echo "Using Neon PostgreSQL (managed)"
          else
            echo "Using Docker PostgreSQL (ephemeral)"
          fi

      - name: Verify Redis connectivity
        run: |
          # Test Docker Redis is accessible
          timeout 5 bash -c 'until echo PING | nc -q 1 localhost 6379 | grep -q PONG; do sleep 1; done' || {
            echo "Docker Redis not responding on localhost:6379"
            exit 1
          }
          echo "Docker Redis is accessible"

      - name: Run integration tests
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
          # Use Docker Redis for integration tests (more reliable in CI)
          # Upstash is used only for e2e-tests that need production-like setup
          REDIS_URL: redis://localhost:6379/0
        run: |
          cd backend
          PYTHONPATH=. pytest tests/test_integration.py -v -m "not slow"

  # Chaos tests (nightly or on demand)
  chaos:
    runs-on: ubuntu-latest
    needs: integration
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[chaos]')
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
          
      - name: Run chaos tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/chaos -v -m chaos

  # Legacy tests (nightly only, warn on failure)
  legacy:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
          
      - name: Run legacy tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/legacy -v || echo "::warning::Legacy tests failed - scheduled for removal"

  # M6: CostSim V2 Circuit Breaker tests (critical)
  costsim:
    runs-on: ubuntu-latest
    needs: unit-tests
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: nova
          POSTGRES_PASSWORD: novapass
          POSTGRES_DB: nova_aos
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx asyncpg

      - name: Run Alembic migrations
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
        run: |
          cd backend
          alembic upgrade head

      - name: Debug - Check environment
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
        run: |
          echo "DATABASE_URL set: $(if [ -n "$DATABASE_URL" ]; then echo 'YES (hidden)'; else echo 'NO'; fi)"
          echo "Python version: $(python --version)"
          cd backend
          python -c "import os; print('DB URL prefix:', os.environ.get('DATABASE_URL', 'NOT SET')[:30] + '...')"

      - name: Run circuit breaker tests
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
          # Override default /var/lib/aos paths for CI (no write perms)
          COSTSIM_DISABLE_FILE: /tmp/aos/costsim_v2_disabled
          COSTSIM_INCIDENT_DIR: /tmp/aos/costsim_incidents
          COSTSIM_ARTIFACTS_DIR: /tmp/aos/costsim_artifacts
        run: |
          cd backend
          PYTHONPATH=. pytest tests/costsim/test_circuit_breaker.py -v --tb=long

      - name: Run async circuit breaker tests
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
          COSTSIM_DISABLE_FILE: /tmp/aos/costsim_v2_disabled
          COSTSIM_INCIDENT_DIR: /tmp/aos/costsim_incidents
          COSTSIM_ARTIFACTS_DIR: /tmp/aos/costsim_artifacts
        run: |
          cd backend
          PYTHONPATH=. pytest tests/costsim/test_circuit_breaker_async.py -v

      - name: Run leader election tests
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
          COSTSIM_DISABLE_FILE: /tmp/aos/costsim_v2_disabled
          COSTSIM_INCIDENT_DIR: /tmp/aos/costsim_incidents
          COSTSIM_ARTIFACTS_DIR: /tmp/aos/costsim_artifacts
        run: |
          cd backend
          PYTHONPATH=. pytest tests/costsim/test_leader.py -v

      - name: Run canary tests
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
          COSTSIM_V2_SANDBOX: "true"
          # Override default /var/lib/aos paths for CI (no write perms)
          COSTSIM_DISABLE_FILE: /tmp/aos/costsim_v2_disabled
          COSTSIM_INCIDENT_DIR: /tmp/aos/costsim_incidents
          COSTSIM_ARTIFACTS_DIR: /tmp/aos/costsim_artifacts
        run: |
          cd backend
          PYTHONPATH=. pytest tests/costsim/test_canary.py -v

      - name: Run alert worker tests
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
          COSTSIM_DISABLE_FILE: /tmp/aos/costsim_v2_disabled
          COSTSIM_INCIDENT_DIR: /tmp/aos/costsim_incidents
          COSTSIM_ARTIFACTS_DIR: /tmp/aos/costsim_artifacts
        run: |
          cd backend
          PYTHONPATH=. pytest tests/costsim/test_alert_worker.py -v

      - name: Run all costsim tests (comprehensive)
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
          COSTSIM_V2_SANDBOX: "true"
          COSTSIM_DISABLE_FILE: /tmp/aos/costsim_v2_disabled
          COSTSIM_INCIDENT_DIR: /tmp/aos/costsim_incidents
          COSTSIM_ARTIFACTS_DIR: /tmp/aos/costsim_artifacts
        run: |
          cd backend
          # Exclude test_integration_real_db.py - it has async lifecycle issues
          # Run those separately with: pytest -m integration
          PYTHONPATH=. pytest tests/costsim/ -v --tb=short --ignore=tests/costsim/test_integration_real_db.py

  # M6: CostSim Integration Tests with real DB + Alertmanager
  costsim-integration:
    runs-on: ubuntu-latest
    needs: costsim
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: nova
          POSTGRES_PASSWORD: novapass
          POSTGRES_DB: nova_aos
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      alertmanager:
        image: prom/alertmanager:latest
        ports:
          - 9093:9093
        options: >-
          --health-cmd "wget -q --spider http://localhost:9093/-/healthy || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx asyncpg

      - name: Run Alembic migrations
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
        run: |
          cd backend
          alembic upgrade head

      - name: Run CB integration tests
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
          ALERTMANAGER_URL: http://localhost:9093
          COSTSIM_V2_SANDBOX: "true"
          COSTSIM_DISABLE_FILE: /tmp/aos/costsim_v2_disabled
          COSTSIM_INCIDENT_DIR: /tmp/aos/costsim_incidents
          COSTSIM_ARTIFACTS_DIR: /tmp/aos/costsim_artifacts
        run: |
          cd backend
          # Exclude test_integration_real_db.py - it has async lifecycle issues
          PYTHONPATH=. pytest tests/costsim/ -v --tb=short --ignore=tests/costsim/test_integration_real_db.py

      # Note: Table verification steps removed - they require direct psql access
      # which doesn't work with Neon. Tests themselves verify functionality.

  # M6: CostSim Tests with WireMock (faster, no real Alertmanager)
  costsim-wiremock:
    runs-on: ubuntu-latest
    needs: unit-tests
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: nova
          POSTGRES_PASSWORD: novapass
          POSTGRES_DB: nova_aos
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U nova -d nova_aos"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx asyncpg

      - name: Start WireMock with mounted mappings
        run: |
          # Start WireMock with mappings from repo
          docker run -d --name wiremock \
            -p 8080:8080 \
            -v ${{ github.workspace }}/tools/wiremock/mappings:/home/wiremock/mappings:ro \
            -v ${{ github.workspace }}/tools/wiremock/__files:/home/wiremock/__files:ro \
            wiremock/wiremock:3.3.1 \
            --verbose --global-response-templating

          # Wait for WireMock to be ready
          echo "Waiting for WireMock to start..."
          for i in {1..30}; do
            if curl -sf http://localhost:8080/__admin/health > /dev/null 2>&1; then
              echo "WireMock is ready!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 1
          done

          # Verify mappings loaded from files
          echo "WireMock mappings loaded:"
          curl -s http://localhost:8080/__admin/mappings | jq '.mappings | length'
          curl -s http://localhost:8080/__admin/mappings | jq '.mappings[].request.urlPattern' || true

      - name: Run Alembic migrations
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
        run: |
          cd backend
          alembic upgrade head

      - name: Run circuit breaker integration tests
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
          ALERTMANAGER_URL: http://localhost:8080/api/v2/alerts
          COSTSIM_V2_SANDBOX: "true"
          COSTSIM_DISABLE_FILE: /tmp/aos/costsim_v2_disabled
          COSTSIM_INCIDENT_DIR: /tmp/aos/costsim_incidents
          COSTSIM_ARTIFACTS_DIR: /tmp/aos/costsim_artifacts
        run: |
          cd backend
          PYTHONPATH=. pytest tests/integration/test_circuit_breaker.py -v --tb=short

      - name: Run all costsim tests
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
          ALERTMANAGER_URL: http://localhost:8080/api/v2/alerts
          COSTSIM_V2_SANDBOX: "true"
          COSTSIM_DISABLE_FILE: /tmp/aos/costsim_v2_disabled
          COSTSIM_INCIDENT_DIR: /tmp/aos/costsim_incidents
          COSTSIM_ARTIFACTS_DIR: /tmp/aos/costsim_artifacts
        run: |
          cd backend
          # Exclude test_integration_real_db.py - it has async lifecycle issues
          PYTHONPATH=. pytest tests/costsim/ -v --tb=short --ignore=tests/costsim/test_integration_real_db.py

      - name: Verify WireMock received requests
        run: |
          echo "=== WireMock Request Log ==="
          REQUESTS=$(curl -s http://localhost:8080/__admin/requests)
          echo "$REQUESTS" | jq '.requests | length'
          echo "$REQUESTS" | jq '.requests[] | {method: .request.method, url: .request.url}' || true

      - name: Cleanup WireMock
        if: always()
        run: docker stop wiremock || true

  # E2E tests (full stack with running server)
  e2e-tests:
    runs-on: ubuntu-latest
    needs: [unit-tests]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: nova
          POSTGRES_PASSWORD: novapass
          POSTGRES_DB: nova_aos
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U nova -d nova_aos"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Check secrets availability
        run: |
          echo "=== Secrets Check ==="
          if [ -n "${{ secrets.NEON_DATABASE_URL }}" ]; then
            echo "✓ NEON_DATABASE_URL is set"
          else
            echo "⚠ NEON_DATABASE_URL not set (using Docker Postgres fallback)"
          fi
          if [ -n "${{ secrets.UPSTASH_REDIS_URL }}" ]; then
            echo "✓ UPSTASH_REDIS_URL is set"
          else
            echo "⚠ UPSTASH_REDIS_URL not set (using Docker Redis fallback)"
          fi
          if [ -n "${{ secrets.AOS_API_KEY }}" ]; then
            echo "✓ AOS_API_KEY is set"
          else
            echo "⚠ AOS_API_KEY not set (using test-e2e-key fallback)"
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -U pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-asyncio httpx asyncpg

      - name: Run Alembic migrations
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
        run: |
          cd backend
          alembic upgrade head

      - name: Start application server
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
          REDIS_URL: ${{ secrets.UPSTASH_REDIS_URL || 'redis://localhost:6379/0' }}
          AOS_API_KEY: ${{ secrets.AOS_API_KEY || 'test-e2e-key' }}
          # Fail-open for non-critical services in CI
          MEMORY_FAIL_OPEN_OVERRIDE: "true"
          COSTSIM_DISABLE_FILE: /tmp/aos/costsim_v2_disabled
          COSTSIM_INCIDENT_DIR: /tmp/aos/costsim_incidents
          COSTSIM_ARTIFACTS_DIR: /tmp/aos/costsim_artifacts
        run: |
          cd backend
          nohup python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
              echo "Server is ready!"
              exit 0
            fi
            # Show server logs if startup is taking too long
            if [ $i -eq 15 ]; then
              echo "=== Server startup logs (debugging slow startup) ==="
              cat server.log 2>/dev/null || true
            fi
            echo "Attempt $i/30..."
            sleep 2
          done
          echo "=== Final server logs ==="
          cat server.log 2>/dev/null || true
          echo "Server failed to start"
          exit 1

      - name: Start worker (required for run execution)
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
          REDIS_URL: ${{ secrets.UPSTASH_REDIS_URL || 'redis://localhost:6379/0' }}
          AOS_API_KEY: ${{ secrets.AOS_API_KEY || 'test-e2e-key' }}
          MEMORY_FAIL_OPEN_OVERRIDE: "true"
          COSTSIM_DISABLE_FILE: /tmp/aos/costsim_v2_disabled
          COSTSIM_INCIDENT_DIR: /tmp/aos/costsim_incidents
          COSTSIM_ARTIFACTS_DIR: /tmp/aos/costsim_artifacts
          PYTHONPATH: .
        run: |
          cd backend
          nohup python -m app.worker.pool > worker.log 2>&1 &
          echo "Worker started (PID: $!)"
          sleep 3
          if ps aux | grep -v grep | grep "app.worker.pool" > /dev/null; then
            echo "Worker is running"
          else
            echo "=== Worker logs ==="
            cat worker.log 2>/dev/null || true
            echo "WARNING: Worker may not have started correctly"
          fi

      - name: Run E2E tests
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL || 'postgresql://nova:novapass@localhost:5433/nova_aos' }}
          REDIS_URL: ${{ secrets.UPSTASH_REDIS_URL || 'redis://localhost:6379/0' }}
          AOS_API_KEY: ${{ secrets.AOS_API_KEY || 'test-e2e-key' }}
          COSTSIM_DISABLE_FILE: /tmp/aos/costsim_v2_disabled
          COSTSIM_INCIDENT_DIR: /tmp/aos/costsim_incidents
          COSTSIM_ARTIFACTS_DIR: /tmp/aos/costsim_artifacts
          RUN_E2E_TESTS: "1"
        run: |
          cd backend
          PYTHONPATH=. pytest tests/test_phase4_e2e.py -v --tb=short -m e2e

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: |
            backend/server.log
            backend/worker.log
          if-no-files-found: ignore

  # Lint Prometheus rules
  lint-alerts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate Prometheus rules
        run: |
          if [ -f ops/prometheus_rules/alerts.yml ]; then
            echo "Prometheus rules file exists"
            # Add promtool check when available
            # promtool check rules ops/prometheus_rules/alerts.yml
          else
            echo "::error::Prometheus rules file missing"
            exit 1
          fi
