# AOS CI Pipeline
# Runs on every push and PR
# Enforces quality gates before merge
#
# Database Strategy:
# - If NEON_API_KEY + NEON_PROJECT_ID secrets are set: Creates ephemeral Neon branch per run (fully isolated)
# - Otherwise: Falls back to Docker Postgres (for forks/external PRs)

name: CI

on:
  push:
    branches: [main, develop, 'feature/*']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      skip_slow_tests:
        description: 'Skip slow tests'
        required: false
        default: 'false'

env:
  PYTHONPATH: backend

jobs:
  # ============================================================================
  # SETUP: Create ephemeral Neon branch for isolated testing
  # ============================================================================
  setup-neon-branch:
    runs-on: ubuntu-latest
    outputs:
      # Note: database_url cannot be passed as output because GitHub blocks secrets
      # Each job must construct its own connection string using neonctl
      branch_name: ${{ steps.set-outputs.outputs.branch_name }}
      use_neon: ${{ steps.set-outputs.outputs.use_neon }}
    steps:
      - name: Check if Neon secrets are available
        id: check-secrets
        run: |
          if [ -n "${{ secrets.NEON_API_KEY }}" ] && [ -n "${{ secrets.NEON_PROJECT_ID }}" ]; then
            echo "use_neon=true" >> $GITHUB_OUTPUT
            echo "✅ Neon secrets available - will create ephemeral branch"
          else
            echo "use_neon=false" >> $GITHUB_OUTPUT
            echo "⚠️ Neon secrets not available - jobs will use Docker Postgres"
          fi

      - name: Setup Neon CLI
        if: steps.check-secrets.outputs.use_neon == 'true'
        uses: nhedger/setup-neon@v1
        with:
          version: latest

      - name: Create ephemeral Neon branch
        if: steps.check-secrets.outputs.use_neon == 'true'
        id: create-branch
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
        run: |
          BRANCH_NAME="ci-${{ github.run_id }}-${{ github.run_attempt }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Creating Neon branch: $BRANCH_NAME"

          # Create branch from default branch (parent)
          neonctl branches create \
            --project-id ${{ secrets.NEON_PROJECT_ID }} \
            --name "$BRANCH_NAME" \
            --parent "Agenticverz-AOS" \
            --api-key $NEON_API_KEY \
            || {
              # Branch might exist from failed previous run, try to delete and recreate
              echo "Branch creation failed, attempting cleanup..."
              neonctl branches delete "$BRANCH_NAME" \
                --project-id ${{ secrets.NEON_PROJECT_ID }} \
                --api-key $NEON_API_KEY 2>/dev/null || true
              sleep 2
              neonctl branches create \
                --project-id ${{ secrets.NEON_PROJECT_ID }} \
                --name "$BRANCH_NAME" \
                --parent "Agenticverz-AOS" \
                --api-key $NEON_API_KEY
            }

          echo "✅ Branch created: $BRANCH_NAME"

      - name: Verify Neon branch is ready
        if: steps.check-secrets.outputs.use_neon == 'true'
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
        run: |
          BRANCH_NAME="ci-${{ github.run_id }}-${{ github.run_attempt }}"
          echo "Waiting for branch endpoint to be ready..."
          sleep 5

          # Verify we can get a connection string
          CONN=$(neonctl connection-string "$BRANCH_NAME" \
            --project-id ${{ secrets.NEON_PROJECT_ID }} \
            --api-key $NEON_API_KEY \
            --database-name neondb \
            --role-name neondb_owner 2>&1)

          if [[ ! "$CONN" =~ ^postgresql:// ]]; then
            echo "::error::Failed to get valid connection string"
            exit 1
          fi

          echo "✅ Branch is ready for connections"

      - name: Set final outputs
        id: set-outputs
        run: |
          USE_NEON="${{ steps.check-secrets.outputs.use_neon }}"

          if [ "$USE_NEON" == "true" ]; then
            echo "branch_name=${{ steps.create-branch.outputs.branch_name }}" >> $GITHUB_OUTPUT
            echo "use_neon=true" >> $GITHUB_OUTPUT
            echo "✅ Neon ephemeral branch ready: ${{ steps.create-branch.outputs.branch_name }}"
          else
            echo "branch_name=" >> $GITHUB_OUTPUT
            echo "use_neon=false" >> $GITHUB_OUTPUT
            echo "⚠️ Using Docker PostgreSQL fallback"
          fi

  # ============================================================================
  # FAST JOBS (No DB required)
  # ============================================================================

  # Migration drift guard - verifies all migrations are committed
  migration-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for uncommitted migrations
        run: |
          echo "=== Migration Drift Guard ==="
          ALEMBIC_DIR="backend/alembic/versions"

          # Check for uncommitted migration files
          UNCOMMITTED=$(git ls-files --others --exclude-standard "$ALEMBIC_DIR" 2>/dev/null | grep -v "__pycache__" || true)
          MODIFIED=$(git diff --name-only "$ALEMBIC_DIR" 2>/dev/null | grep -v "__pycache__" || true)

          if [[ -n "$UNCOMMITTED" ]]; then
            echo "::error::Uncommitted migration files found!"
            echo "$UNCOMMITTED"
            exit 1
          fi

          if [[ -n "$MODIFIED" ]]; then
            echo "::error::Modified migration files not staged!"
            echo "$MODIFIED"
            exit 1
          fi

          # List committed migrations
          echo "Migration files in repository:"
          ls -1 "$ALEMBIC_DIR"/*.py 2>/dev/null | grep -v "__pycache__" | xargs -I {} basename {} | sort
          echo ""
          echo "OK: All migrations committed"

  # Fast unit tests (no external deps)
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run unit tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/schemas -v -m "not slow" --maxfail=3

      - name: Run skill tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/skills -v --maxfail=3

  # Determinism certification (critical)
  determinism:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run replay certification
        run: |
          cd backend
          PYTHONPATH=. pytest tests/workflow/test_replay_certification.py -v

      - name: Run registry snapshot test
        run: |
          cd backend
          PYTHONPATH=. pytest tests/integration/test_registry_snapshot.py -v

  # M4: Workflow Engine tests (critical for determinism)
  workflow-engine:
    runs-on: ubuntu-latest
    needs: determinism
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run workflow engine smoke tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/workflow/test_engine_smoke.py -v

      - name: Run checkpoint store tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/workflow/test_checkpoint_store.py -v

      - name: Run golden-file pipeline tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/workflow/test_workflow_golden_pipeline.py -v

  # M4: Golden-file replay check (blocks merge on diff)
  workflow-golden-check:
    runs-on: ubuntu-latest
    needs: workflow-engine
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run golden replay verification
        env:
          GOLDEN_SECRET: ${{ secrets.GOLDEN_SECRET }}
        run: |
          cd backend
          PYTHONPATH=. pytest tests/workflow/test_workflow_golden_pipeline.py -v -k "compare"

      - name: Upload golden artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: golden-diff
          path: backend/artifacts/golden-diff/

  # Lint Prometheus rules
  lint-alerts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate Prometheus rules
        run: |
          if [ -f ops/prometheus_rules/alerts.yml ]; then
            echo "Prometheus rules file exists"
          else
            echo "::error::Prometheus rules file missing"
            exit 1
          fi

  # ============================================================================
  # DB-DEPENDENT JOBS (Use ephemeral Neon branch or Docker fallback)
  # ============================================================================

  # Integration tests
  integration:
    runs-on: ubuntu-latest
    needs: [setup-neon-branch, determinism]
    services:
      # Docker Postgres - only used when Neon is not available
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: nova
          POSTGRES_PASSWORD: novapass
          POSTGRES_DB: nova_aos
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      REDIS_URL: redis://localhost:6379/0
    steps:
      - uses: actions/checkout@v4

      - name: Setup Neon CLI
        if: needs.setup-neon-branch.outputs.use_neon == 'true'
        uses: nhedger/setup-neon@v1
        with:
          version: latest

      - name: Configure database connection
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
        run: |
          if [ "${{ needs.setup-neon-branch.outputs.use_neon }}" == "true" ]; then
            echo "✅ Using Neon PostgreSQL (ephemeral branch)"
            BRANCH_NAME="${{ needs.setup-neon-branch.outputs.branch_name }}"
            CONN=$(neonctl connection-string "$BRANCH_NAME" \
              --project-id ${{ secrets.NEON_PROJECT_ID }} \
              --api-key $NEON_API_KEY \
              --database-name neondb \
              --role-name neondb_owner)
            # Ensure sslmode=require is present
            if [[ "$CONN" != *"sslmode="* ]]; then
              CONN="${CONN}?sslmode=require"
            fi
            echo "DATABASE_URL=$CONN" >> $GITHUB_ENV
          else
            echo "⚠️ Using Docker PostgreSQL (fallback mode)"
            echo "DATABASE_URL=postgresql://nova:novapass@localhost:5433/nova_aos" >> $GITHUB_ENV
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Wait for PostgreSQL (Docker fallback only)
        if: needs.setup-neon-branch.outputs.use_neon != 'true'
        run: |
          echo "Waiting for Docker PostgreSQL to accept connections..."
          for i in {1..30}; do
            if PGPASSWORD=novapass psql -h localhost -p 5433 -U nova -d nova_aos -c "SELECT 1" > /dev/null 2>&1; then
              echo "PostgreSQL is ready!"
              exit 0
            fi
            echo "Attempt $i/30 - PostgreSQL not ready yet..."
            sleep 2
          done
          echo "PostgreSQL failed to become ready"
          exit 1

      - name: Run Alembic migrations
        run: |
          cd backend
          alembic upgrade head

      - name: Run integration tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/test_integration.py -v -m "not slow"

  # M6: CostSim V2 Circuit Breaker tests
  costsim:
    runs-on: ubuntu-latest
    needs: [setup-neon-branch, unit-tests]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: nova
          POSTGRES_PASSWORD: novapass
          POSTGRES_DB: nova_aos
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      COSTSIM_DISABLE_FILE: /tmp/aos/costsim_v2_disabled
      COSTSIM_INCIDENT_DIR: /tmp/aos/costsim_incidents
      COSTSIM_ARTIFACTS_DIR: /tmp/aos/costsim_artifacts
    steps:
      - uses: actions/checkout@v4

      - name: Setup Neon CLI
        if: needs.setup-neon-branch.outputs.use_neon == 'true'
        uses: nhedger/setup-neon@v1
        with:
          version: latest

      - name: Configure database connection
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
        run: |
          if [ "${{ needs.setup-neon-branch.outputs.use_neon }}" == "true" ]; then
            echo "✅ Using Neon PostgreSQL (ephemeral branch)"
            BRANCH_NAME="${{ needs.setup-neon-branch.outputs.branch_name }}"
            CONN=$(neonctl connection-string "$BRANCH_NAME" \
              --project-id ${{ secrets.NEON_PROJECT_ID }} \
              --api-key $NEON_API_KEY \
              --database-name neondb \
              --role-name neondb_owner)
            if [[ "$CONN" != *"sslmode="* ]]; then
              CONN="${CONN}?sslmode=require"
            fi
            echo "DATABASE_URL=$CONN" >> $GITHUB_ENV
          else
            echo "⚠️ Using Docker PostgreSQL (fallback mode)"
            echo "DATABASE_URL=postgresql://nova:novapass@localhost:5433/nova_aos" >> $GITHUB_ENV
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx asyncpg

      - name: Wait for PostgreSQL (Docker fallback only)
        if: needs.setup-neon-branch.outputs.use_neon != 'true'
        run: |
          echo "Waiting for Docker PostgreSQL to accept connections..."
          for i in {1..30}; do
            if PGPASSWORD=novapass psql -h localhost -p 5433 -U nova -d nova_aos -c "SELECT 1" > /dev/null 2>&1; then
              echo "PostgreSQL is ready!"
              exit 0
            fi
            echo "Attempt $i/30 - PostgreSQL not ready yet..."
            sleep 2
          done
          echo "PostgreSQL failed to become ready"
          exit 1

      - name: Run Alembic migrations
        run: |
          cd backend
          alembic upgrade head

      - name: Run circuit breaker tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/costsim/test_circuit_breaker.py -v --tb=long

      - name: Run async circuit breaker tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/costsim/test_circuit_breaker_async.py -v

      - name: Run leader election tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/costsim/test_leader.py -v

      - name: Run canary tests
        env:
          COSTSIM_V2_SANDBOX: "true"
        run: |
          cd backend
          PYTHONPATH=. pytest tests/costsim/test_canary.py -v

      - name: Run alert worker tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/costsim/test_alert_worker.py -v

      - name: Run all costsim tests (comprehensive)
        env:
          COSTSIM_V2_SANDBOX: "true"
        run: |
          cd backend
          PYTHONPATH=. pytest tests/costsim/ -v --tb=short --ignore=tests/costsim/test_integration_real_db.py

  # M6: CostSim Integration Tests with real DB + Alertmanager
  costsim-integration:
    runs-on: ubuntu-latest
    needs: [setup-neon-branch, costsim]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: nova
          POSTGRES_PASSWORD: novapass
          POSTGRES_DB: nova_aos
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      alertmanager:
        image: prom/alertmanager:latest
        ports:
          - 9093:9093
        options: >-
          --health-cmd "wget -q --spider http://localhost:9093/-/healthy || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      ALERTMANAGER_URL: http://localhost:9093
      COSTSIM_V2_SANDBOX: "true"
      COSTSIM_DISABLE_FILE: /tmp/aos/costsim_v2_disabled
      COSTSIM_INCIDENT_DIR: /tmp/aos/costsim_incidents
      COSTSIM_ARTIFACTS_DIR: /tmp/aos/costsim_artifacts
    steps:
      - uses: actions/checkout@v4

      - name: Setup Neon CLI
        if: needs.setup-neon-branch.outputs.use_neon == 'true'
        uses: nhedger/setup-neon@v1
        with:
          version: latest

      - name: Configure database connection
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
        run: |
          if [ "${{ needs.setup-neon-branch.outputs.use_neon }}" == "true" ]; then
            echo "✅ Using Neon PostgreSQL (ephemeral branch)"
            BRANCH_NAME="${{ needs.setup-neon-branch.outputs.branch_name }}"
            CONN=$(neonctl connection-string "$BRANCH_NAME" \
              --project-id ${{ secrets.NEON_PROJECT_ID }} \
              --api-key $NEON_API_KEY \
              --database-name neondb \
              --role-name neondb_owner)
            if [[ "$CONN" != *"sslmode="* ]]; then
              CONN="${CONN}?sslmode=require"
            fi
            echo "DATABASE_URL=$CONN" >> $GITHUB_ENV
          else
            echo "⚠️ Using Docker PostgreSQL (fallback mode)"
            echo "DATABASE_URL=postgresql://nova:novapass@localhost:5433/nova_aos" >> $GITHUB_ENV
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx asyncpg

      - name: Wait for PostgreSQL (Docker fallback only)
        if: needs.setup-neon-branch.outputs.use_neon != 'true'
        run: |
          echo "Waiting for Docker PostgreSQL to accept connections..."
          for i in {1..30}; do
            if PGPASSWORD=novapass psql -h localhost -p 5433 -U nova -d nova_aos -c "SELECT 1" > /dev/null 2>&1; then
              echo "PostgreSQL is ready!"
              exit 0
            fi
            echo "Attempt $i/30 - PostgreSQL not ready yet..."
            sleep 2
          done
          echo "PostgreSQL failed to become ready"
          exit 1

      - name: Run Alembic migrations
        run: |
          cd backend
          alembic upgrade head

      - name: Run CB integration tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/costsim/ -v --tb=short --ignore=tests/costsim/test_integration_real_db.py

  # M6: CostSim Tests with WireMock
  costsim-wiremock:
    runs-on: ubuntu-latest
    needs: [setup-neon-branch, unit-tests]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: nova
          POSTGRES_PASSWORD: novapass
          POSTGRES_DB: nova_aos
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U nova -d nova_aos"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      ALERTMANAGER_URL: http://localhost:8080/api/v2/alerts
      COSTSIM_V2_SANDBOX: "true"
      COSTSIM_DISABLE_FILE: /tmp/aos/costsim_v2_disabled
      COSTSIM_INCIDENT_DIR: /tmp/aos/costsim_incidents
      COSTSIM_ARTIFACTS_DIR: /tmp/aos/costsim_artifacts
    steps:
      - uses: actions/checkout@v4

      - name: Setup Neon CLI
        if: needs.setup-neon-branch.outputs.use_neon == 'true'
        uses: nhedger/setup-neon@v1
        with:
          version: latest

      - name: Configure database connection
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
        run: |
          if [ "${{ needs.setup-neon-branch.outputs.use_neon }}" == "true" ]; then
            echo "✅ Using Neon PostgreSQL (ephemeral branch)"
            BRANCH_NAME="${{ needs.setup-neon-branch.outputs.branch_name }}"
            CONN=$(neonctl connection-string "$BRANCH_NAME" \
              --project-id ${{ secrets.NEON_PROJECT_ID }} \
              --api-key $NEON_API_KEY \
              --database-name neondb \
              --role-name neondb_owner)
            if [[ "$CONN" != *"sslmode="* ]]; then
              CONN="${CONN}?sslmode=require"
            fi
            echo "DATABASE_URL=$CONN" >> $GITHUB_ENV
          else
            echo "⚠️ Using Docker PostgreSQL (fallback mode)"
            echo "DATABASE_URL=postgresql://nova:novapass@localhost:5433/nova_aos" >> $GITHUB_ENV
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx asyncpg

      - name: Start WireMock with mounted mappings
        run: |
          docker run -d --name wiremock \
            -p 8080:8080 \
            -v ${{ github.workspace }}/tools/wiremock/mappings:/home/wiremock/mappings:ro \
            -v ${{ github.workspace }}/tools/wiremock/__files:/home/wiremock/__files:ro \
            wiremock/wiremock:3.3.1 \
            --verbose --global-response-templating

          echo "Waiting for WireMock to start..."
          for i in {1..30}; do
            if curl -sf http://localhost:8080/__admin/health > /dev/null 2>&1; then
              echo "WireMock is ready!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 1
          done

          echo "WireMock mappings loaded:"
          curl -s http://localhost:8080/__admin/mappings | jq '.mappings | length'

      - name: Wait for PostgreSQL (Docker fallback only)
        if: needs.setup-neon-branch.outputs.use_neon != 'true'
        run: |
          echo "Waiting for Docker PostgreSQL to accept connections..."
          for i in {1..30}; do
            if PGPASSWORD=novapass psql -h localhost -p 5433 -U nova -d nova_aos -c "SELECT 1" > /dev/null 2>&1; then
              echo "PostgreSQL is ready!"
              exit 0
            fi
            echo "Attempt $i/30 - PostgreSQL not ready yet..."
            sleep 2
          done
          echo "PostgreSQL failed to become ready"
          exit 1

      - name: Run Alembic migrations
        run: |
          cd backend
          alembic upgrade head

      - name: Run circuit breaker integration tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/integration/test_circuit_breaker.py -v --tb=short

      - name: Run all costsim tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/costsim/ -v --tb=short --ignore=tests/costsim/test_integration_real_db.py

      - name: Verify WireMock received requests
        run: |
          echo "=== WireMock Request Log ==="
          REQUESTS=$(curl -s http://localhost:8080/__admin/requests)
          echo "$REQUESTS" | jq '.requests | length'

      - name: Cleanup WireMock
        if: always()
        run: docker stop wiremock || true

  # E2E tests (full stack with running server)
  e2e-tests:
    runs-on: ubuntu-latest
    needs: [setup-neon-branch, unit-tests]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: nova
          POSTGRES_PASSWORD: novapass
          POSTGRES_DB: nova_aos
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U nova -d nova_aos"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      REDIS_URL: redis://localhost:6379/0
      AOS_API_KEY: ${{ secrets.AOS_API_KEY || 'test-e2e-key' }}
      MEMORY_FAIL_OPEN_OVERRIDE: "true"
      COSTSIM_DISABLE_FILE: /tmp/aos/costsim_v2_disabled
      COSTSIM_INCIDENT_DIR: /tmp/aos/costsim_incidents
      COSTSIM_ARTIFACTS_DIR: /tmp/aos/costsim_artifacts
    steps:
      - uses: actions/checkout@v4

      - name: Setup Neon CLI
        if: needs.setup-neon-branch.outputs.use_neon == 'true'
        uses: nhedger/setup-neon@v1
        with:
          version: latest

      - name: Configure database connection
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
        run: |
          if [ "${{ needs.setup-neon-branch.outputs.use_neon }}" == "true" ]; then
            echo "✅ Using Neon PostgreSQL (ephemeral branch)"
            BRANCH_NAME="${{ needs.setup-neon-branch.outputs.branch_name }}"
            CONN=$(neonctl connection-string "$BRANCH_NAME" \
              --project-id ${{ secrets.NEON_PROJECT_ID }} \
              --api-key $NEON_API_KEY \
              --database-name neondb \
              --role-name neondb_owner)
            if [[ "$CONN" != *"sslmode="* ]]; then
              CONN="${CONN}?sslmode=require"
            fi
            echo "DATABASE_URL=$CONN" >> $GITHUB_ENV
          else
            echo "⚠️ Using Docker PostgreSQL (fallback mode)"
            echo "DATABASE_URL=postgresql://nova:novapass@localhost:5433/nova_aos" >> $GITHUB_ENV
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -U pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-asyncio httpx asyncpg

      - name: Wait for PostgreSQL (Docker fallback only)
        if: needs.setup-neon-branch.outputs.use_neon != 'true'
        run: |
          echo "Waiting for Docker PostgreSQL to accept connections..."
          for i in {1..30}; do
            if PGPASSWORD=novapass psql -h localhost -p 5433 -U nova -d nova_aos -c "SELECT 1" > /dev/null 2>&1; then
              echo "PostgreSQL is ready!"
              exit 0
            fi
            echo "Attempt $i/30 - PostgreSQL not ready yet..."
            sleep 2
          done
          echo "PostgreSQL failed to become ready"
          exit 1

      - name: Run Alembic migrations
        run: |
          cd backend
          alembic upgrade head

      - name: Start application server
        run: |
          cd backend
          nohup python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
              echo "Server is ready!"
              exit 0
            fi
            if [ $i -eq 15 ]; then
              echo "=== Server startup logs (debugging slow startup) ==="
              cat server.log 2>/dev/null || true
            fi
            echo "Attempt $i/30..."
            sleep 2
          done
          echo "=== Final server logs ==="
          cat server.log 2>/dev/null || true
          echo "Server failed to start"
          exit 1

      - name: Start worker (required for run execution)
        env:
          PYTHONPATH: .
          PYTHONUNBUFFERED: "1"
        run: |
          cd backend
          nohup python -u -m app.worker.pool > worker.log 2>&1 &
          WORKER_PID=$!
          echo "Worker started (PID: $WORKER_PID)"
          echo "WORKER_PID=$WORKER_PID" >> $GITHUB_ENV

          # Wait for worker to fully initialize (look for poll loop start)
          echo "Waiting for worker to start polling..."
          for i in {1..15}; do
            sleep 2
            if grep -q "worker_pool_starting\|poll_and_dispatch" worker.log 2>/dev/null; then
              echo "✅ Worker poll loop started"
              break
            fi
            if ! ps -p $WORKER_PID > /dev/null 2>&1; then
              echo "❌ Worker crashed during startup!"
              cat worker.log 2>/dev/null || true
              exit 1
            fi
            echo "  Attempt $i/15 - waiting..."
          done

          # Final verification
          if ps -p $WORKER_PID > /dev/null 2>&1; then
            echo "✅ Worker is running (PID: $WORKER_PID)"
            echo "=== Worker logs (last 50 lines) ==="
            tail -50 worker.log
          else
            echo "❌ Worker process is not running!"
            cat worker.log 2>/dev/null || true
            exit 1
          fi

      - name: Run E2E tests
        env:
          RUN_E2E_TESTS: "1"
        run: |
          cd backend
          PYTHONPATH=. pytest tests/test_phase4_e2e.py -v --tb=short -m e2e

      - name: Show worker logs (debug)
        if: always()
        run: |
          cd backend
          echo "=== Worker process status ==="
          ps aux | grep worker || echo "No worker process found"
          echo ""
          echo "=== Full worker.log ==="
          cat worker.log 2>/dev/null || echo "No worker.log found"
          echo ""
          echo "=== Checking for runs in DB ==="
          PYTHONPATH=. python -c "
          from app.db import engine
          from sqlmodel import Session, select
          from app.db import Run
          with Session(engine) as s:
              runs = s.exec(select(Run)).all()
              for r in runs:
                  print(f'Run {r.id}: status={r.status}, created={r.created_at}, started={r.started_at}')
          " 2>/dev/null || echo "Could not query runs"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: |
            backend/server.log
            backend/worker.log
          if-no-files-found: ignore

  # M10: Combined Tests
  m10-tests:
    runs-on: ubuntu-latest
    needs: [setup-neon-branch, integration]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: nova
          POSTGRES_PASSWORD: novapass
          POSTGRES_DB: nova_aos
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      REDIS_URL: redis://localhost:6379/0
    steps:
      - uses: actions/checkout@v4

      - name: Setup Neon CLI
        if: needs.setup-neon-branch.outputs.use_neon == 'true'
        uses: nhedger/setup-neon@v1
        with:
          version: latest

      - name: Configure database connection
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
        run: |
          if [ "${{ needs.setup-neon-branch.outputs.use_neon }}" == "true" ]; then
            echo "✅ Using Neon PostgreSQL (ephemeral branch)"
            BRANCH_NAME="${{ needs.setup-neon-branch.outputs.branch_name }}"
            CONN=$(neonctl connection-string "$BRANCH_NAME" \
              --project-id ${{ secrets.NEON_PROJECT_ID }} \
              --api-key $NEON_API_KEY \
              --database-name neondb \
              --role-name neondb_owner)
            if [[ "$CONN" != *"sslmode="* ]]; then
              CONN="${CONN}?sslmode=require"
            fi
            echo "DATABASE_URL=$CONN" >> $GITHUB_ENV
          else
            echo "⚠️ Using Docker PostgreSQL (fallback mode)"
            echo "DATABASE_URL=postgresql://nova:novapass@localhost:5433/nova_aos" >> $GITHUB_ENV
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Install redis-tools
        run: |
          sudo apt-get update
          sudo apt-get install -y redis-tools

      - name: Check Redis configuration
        run: |
          cd backend
          echo "=== M10 Redis Configuration Check ==="
          PYTHONPATH=. python -m scripts.ops.check_redis_config --json || true
          redis-cli XADD m10:ci:test '*' test_key test_value > /dev/null
          RESULT=$(redis-cli XLEN m10:ci:test)
          redis-cli DEL m10:ci:test > /dev/null
          if [ "$RESULT" -ge 1 ]; then
            echo "✓ Redis stream operations working"
          else
            echo "::error::Redis stream operations not working"
            exit 1
          fi

      - name: Wait for PostgreSQL (Docker fallback only)
        if: needs.setup-neon-branch.outputs.use_neon != 'true'
        run: |
          echo "Waiting for Docker PostgreSQL to accept connections..."
          for i in {1..30}; do
            if PGPASSWORD=novapass psql -h localhost -p 5433 -U nova -d nova_aos -c "SELECT 1" > /dev/null 2>&1; then
              echo "PostgreSQL is ready!"
              exit 0
            fi
            echo "Attempt $i/30 - PostgreSQL not ready yet..."
            sleep 2
          done
          echo "PostgreSQL failed to become ready"
          exit 1

      - name: Run Alembic migrations
        run: |
          cd backend
          alembic upgrade head

      - name: Run M10 leader election tests
        run: |
          cd backend
          echo "=== M10 Leader Election Tests ==="
          PYTHONPATH=. pytest tests/test_m10_leader_election.py -v --tb=short

      - name: Run M10 production hardening tests
        run: |
          cd backend
          echo "=== M10 Production Hardening Tests ==="
          PYTHONPATH=. pytest tests/test_m10_production_hardening.py -v --tb=short -k "not chaos and not high_volume"

      - name: Verify M10 metrics registered
        run: |
          cd backend
          echo "=== M10 Metrics Check ==="
          PYTHONPATH=. pytest tests/test_m10_metrics.py -v --tb=short -k "test_m10_metrics_defined or test_m10_metrics_in_registry"

      - name: Run outbox E2E tests
        if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[outbox]') || contains(github.event.head_commit.message, '[m10]')
        run: |
          cd backend
          echo "=== M10 Outbox E2E Tests ==="
          PYTHONPATH=. pytest tests/test_m10_outbox_e2e.py -v --tb=short

  # ============================================================================
  # CONDITIONAL JOBS
  # ============================================================================

  # Chaos tests (nightly or on demand)
  chaos:
    runs-on: ubuntu-latest
    needs: integration
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[chaos]')
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run chaos tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/chaos -v -m chaos

  # Legacy tests (nightly only, warn on failure)
  legacy:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run legacy tests
        run: |
          cd backend
          PYTHONPATH=. pytest tests/legacy -v || echo "::warning::Legacy tests failed - scheduled for removal"

  # ============================================================================
  # CLEANUP: Delete ephemeral Neon branch
  # ============================================================================
  cleanup-neon-branch:
    runs-on: ubuntu-latest
    needs: [setup-neon-branch, integration, costsim, costsim-integration, costsim-wiremock, e2e-tests, m10-tests]
    if: always() && needs.setup-neon-branch.outputs.use_neon == 'true'
    steps:
      - name: Setup Neon CLI
        uses: nhedger/setup-neon@v1
        with:
          version: latest

      - name: Delete ephemeral Neon branch
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
        run: |
          BRANCH_NAME="ci-${{ github.run_id }}-${{ github.run_attempt }}"
          echo "Deleting Neon branch: $BRANCH_NAME"

          neonctl branches delete "$BRANCH_NAME" \
            --project-id ${{ secrets.NEON_PROJECT_ID }} \
            --api-key $NEON_API_KEY \
            || echo "⚠️ Branch deletion failed (may already be deleted)"

          echo "✅ Cleanup complete"
