name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

env:
  PYTHON_VERSION: "3.11"
  DATABASE_URL: "postgresql://nova:novapass@localhost:5433/nova_aos"
  REDIS_URL: "redis://localhost:6379/0"
  AOS_API_KEY: "test-ci-key"
  ENFORCE_TENANCY: "false"

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy
          pip install -r backend/requirements.txt

      - name: Run ruff linter
        run: |
          ruff check backend/app --output-format=github || true
        continue-on-error: true

      - name: Run mypy type checker
        run: |
          mypy backend/app --ignore-missing-imports --no-error-summary || true
        continue-on-error: true

  unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-cov

      - name: Run unit tests
        run: |
          cd backend
          python -m pytest tests/schemas/ -v --tb=short -x
        env:
          PYTHONPATH: ${{ github.workspace }}/backend

  schema-validation:
    name: Schema Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema pydantic

      - name: Validate JSON schemas
        run: |
          python -c "
          import json
          import jsonschema
          from pathlib import Path

          schema_dir = Path('backend/app/schemas')
          errors = []

          for schema_file in schema_dir.glob('*.schema.json'):
              print(f'Validating {schema_file.name}...')
              try:
                  with open(schema_file) as f:
                      schema = json.load(f)
                  # Validate schema is valid JSON Schema draft-07
                  jsonschema.Draft7Validator.check_schema(schema)
                  print(f'  ✓ {schema_file.name} is valid')
              except Exception as e:
                  errors.append(f'{schema_file.name}: {e}')
                  print(f'  ✗ {schema_file.name}: {e}')

          if errors:
              print(f'\n{len(errors)} schema validation errors')
              exit(1)
          print('\nAll schemas valid!')
          "

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit, schema-validation]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: nova
          POSTGRES_PASSWORD: novapass
          POSTGRES_DB: nova_aos
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-cov httpx

      - name: Wait for services
        run: |
          sleep 5
          pg_isready -h localhost -p 5433 -U nova || true

      - name: Run integration tests (mocked)
        run: |
          cd backend
          python -m pytest tests/ -v --tb=short \
            -k "not test_get_run_status and not test_duplicate_idempotency" \
            --ignore=tests/test_phase4_e2e.py \
            --ignore=tests/test_phase5_security.py \
            -x
        env:
          PYTHONPATH: ${{ github.workspace }}/backend
          DATABASE_URL: postgresql://nova:novapass@localhost:5433/nova_aos
          REDIS_URL: redis://localhost:6379/0
        continue-on-error: true

  spec-check:
    name: Specification Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check required specs exist
        run: |
          echo "Checking required M0 specifications..."
          required_files=(
            "backend/app/specs/error_taxonomy.md"
            "backend/app/specs/determinism_and_replay.md"
            "backend/app/schemas/structured_outcome.schema.json"
            "backend/app/schemas/skill_metadata.schema.json"
            "backend/app/schemas/resource_contract.schema.json"
            "backend/app/schemas/agent_profile.schema.json"
          )

          missing=0
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "✓ $file exists"
            else
              echo "✗ $file MISSING"
              missing=$((missing + 1))
            fi
          done

          if [ $missing -gt 0 ]; then
            echo ""
            echo "ERROR: $missing required specification file(s) missing"
            exit 1
          fi

          echo ""
          echo "All required specifications present!"

  changelog-check:
    name: Changelog Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for schema changes without changelog
        run: |
          echo "Checking for schema changes..."

          # Get changed files
          changed=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          schema_changed=false
          for file in $changed; do
            if [[ $file == *.schema.json ]] || [[ $file == *error_taxonomy.md ]]; then
              echo "Schema change detected: $file"
              schema_changed=true
            fi
          done

          if [ "$schema_changed" = true ]; then
            # Check if changelog was updated
            if echo "$changed" | grep -q "CHANGELOG\|changelog"; then
              echo "✓ Changelog updated with schema changes"
            else
              echo "WARNING: Schema files changed but no changelog entry found"
              echo "Consider adding a changelog entry for schema changes"
            fi
          fi

  replay-smoke:
    name: Replay Smoke Test
    runs-on: ubuntu-latest
    needs: [unit]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema

      - name: Run replay smoke test
        run: |
          python -c "
          import json
          from pathlib import Path

          print('=== Replay Smoke Test ===')
          print('Verifying deterministic fields in golden files...')

          examples_dir = Path('backend/app/schemas/examples')
          if not examples_dir.exists():
              print('No examples directory found, skipping')
              exit(0)

          # Fields that MUST be deterministic
          deterministic_fields = ['status', 'code', 'cost_cents', 'retryable']
          # Fields that MUST NOT affect replay
          forbidden_fields = ['timestamp', 'latency_ms']

          errors = []

          for example_file in examples_dir.glob('structured_outcome*.json'):
              print(f'\nChecking {example_file.name}...')
              with open(example_file) as f:
                  data = json.load(f)

              # Verify deterministic fields present
              for field in deterministic_fields:
                  if field in data:
                      print(f'  ✓ {field} present: {data[field]}')
                  else:
                      errors.append(f'{example_file.name}: missing deterministic field {field}')

              # Verify forbidden fields documented
              for field in forbidden_fields:
                  if field in data:
                      print(f'  ℹ {field} present (non-deterministic, ignored in replay)')

              # Verify metadata contains skill info
              if 'metadata' in data:
                  if 'skill_id' in data['metadata']:
                      print(f'  ✓ metadata.skill_id: {data[\"metadata\"][\"skill_id\"]}')
                  if 'skill_version' in data['metadata']:
                      print(f'  ✓ metadata.skill_version: {data[\"metadata\"][\"skill_version\"]}')

          if errors:
              print(f'\n{len(errors)} errors found:')
              for e in errors:
                  print(f'  ✗ {e}')
              exit(1)

          print('\n✓ Replay smoke test passed!')
          "

  side-effect-order:
    name: Side-Effect Order Check
    runs-on: ubuntu-latest
    needs: [unit]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Check side-effect ordering rules
        run: |
          python -c "
          import json
          from pathlib import Path

          print('=== Side-Effect Order Check ===')
          print('Verifying side-effects follow ordering rules...')

          examples_dir = Path('backend/app/schemas/examples')
          if not examples_dir.exists():
              print('No examples directory found, skipping')
              exit(0)

          errors = []

          for example_file in examples_dir.glob('structured_outcome*.json'):
              with open(example_file) as f:
                  data = json.load(f)

              if 'side_effects' not in data:
                  continue

              side_effects = data['side_effects']
              print(f'\n{example_file.name}: {len(side_effects)} side-effects')

              # Check each side-effect has required fields
              for i, effect in enumerate(side_effects):
                  if 'type' not in effect:
                      errors.append(f'{example_file.name}[{i}]: missing type field')
                  else:
                      print(f'  [{i}] type: {effect[\"type\"]}')

          if errors:
              print(f'\n{len(errors)} errors:')
              for e in errors:
                  print(f'  ✗ {e}')
              exit(1)

          print('\n✓ Side-effect order check passed!')
          "

  metadata-drift:
    name: Metadata Version Drift Guard
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check skill metadata version drift
        run: |
          echo "=== Metadata Version Drift Guard ==="
          echo "Checking if skill_metadata changes include version bump..."

          # Get changed files
          changed=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null || echo "")

          if [ -z "$changed" ]; then
            echo "No base branch to compare, skipping"
            exit 0
          fi

          metadata_changed=false
          for file in $changed; do
            if [[ $file == *skill_metadata* ]] || [[ $file == */skills/*.py ]]; then
              echo "Skill file changed: $file"
              metadata_changed=true
            fi
          done

          if [ "$metadata_changed" = true ]; then
            echo ""
            echo "WARNING: Skill metadata or implementation changed"
            echo "Ensure skill version is bumped if behavior changed"
            echo "See: backend/app/specs/determinism_and_replay.md"
          fi

          echo ""
          echo "✓ Metadata drift check complete"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, unit, schema-validation, integration, spec-check]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## CI Summary"
          echo ""
          echo "| Job | Status |"
          echo "|-----|--------|"
          echo "| Lint | ${{ needs.lint.result }} |"
          echo "| Unit Tests | ${{ needs.unit.result }} |"
          echo "| Schema Validation | ${{ needs.schema-validation.result }} |"
          echo "| Integration Tests | ${{ needs.integration.result }} |"
          echo "| Spec Check | ${{ needs.spec-check.result }} |"

          # Fail if critical jobs failed
          if [ "${{ needs.unit.result }}" = "failure" ] || \
             [ "${{ needs.schema-validation.result }}" = "failure" ] || \
             [ "${{ needs.spec-check.result }}" = "failure" ]; then
            echo ""
            echo "Critical jobs failed!"
            exit 1
          fi
