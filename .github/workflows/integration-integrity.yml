# Integration Integrity CI Pipeline
# Reference: PIN-245 (Integration Integrity System)
#
# PURPOSE: Catch integration errors BEFORE manual browser checks
# SCOPE: Layer seams and browser console errors
#
# FAILURE RULE: Any integration error â†’ BUILD FAILS

name: Integration Integrity

on:
  push:
    branches: [main, develop, 'feature/*']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  PYTHONPATH: backend

jobs:
  # ============================================================================
  # LAYER INTEGRATION TESTS (LIT)
  # ============================================================================
  lit-tests:
    name: Layer Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx

      - name: Run LIT tests
        id: lit
        run: |
          cd backend
          echo "ðŸ” Running Layer Integration Tests..."
          echo ""
          echo "LIT validates layer seam contracts:"
          echo "  - L2 â†” L3: API to Adapter"
          echo "  - L2 â†” L6: API to Platform"
          echo "  - Response shapes, null safety, error formats"
          echo ""

          PYTHONPATH=. pytest tests/lit -v -m lit --tb=short 2>&1 | tee /tmp/lit-output.txt
          EXIT_CODE=${PIPESTATUS[0]}

          # Count results
          PASSED=$(grep -c "PASSED" /tmp/lit-output.txt || true)
          FAILED=$(grep -c "FAILED" /tmp/lit-output.txt || true)

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          exit $EXIT_CODE

      - name: LIT Summary
        if: always()
        run: |
          echo "## ðŸ”— Layer Integration Tests (LIT)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Passed | ${{ steps.lit.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | ${{ steps.lit.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.lit.outputs.failed }}" != "0" ]; then
            echo "âš ï¸ **Integration seam violations detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Fix layer boundary contracts before merge." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All layer integration contracts satisfied." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload LIT results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lit-results
          path: /tmp/lit-output.txt
          if-no-files-found: ignore

  # ============================================================================
  # BROWSER INTEGRATION TESTS (BIT)
  # ============================================================================
  bit-tests:
    name: Browser Integration Tests
    runs-on: ubuntu-latest
    needs: [lit-tests]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: nova
          POSTGRES_PASSWORD: novapass
          POSTGRES_DB: nova_aos
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://nova:novapass@localhost:5433/nova_aos
      REDIS_URL: redis://localhost:6379/0
      AOS_API_KEY: bit-test-key
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Install frontend dependencies
        run: |
          cd website/app-shell
          npm ci

      - name: Install Playwright
        run: |
          cd website/app-shell
          npx playwright install --with-deps chromium

      - name: Install js-yaml for BIT
        run: |
          cd website/app-shell
          npm install js-yaml @types/js-yaml

      - name: Wait for PostgreSQL
        run: |
          for i in {1..30}; do
            if PGPASSWORD=novapass psql -h localhost -p 5433 -U nova -d nova_aos -c "SELECT 1" > /dev/null 2>&1; then
              echo "PostgreSQL is ready!"
              exit 0
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 2
          done
          exit 1

      - name: Run migrations
        run: |
          cd backend
          alembic upgrade head

      - name: Start backend server
        run: |
          cd backend
          nohup python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &
          echo "Waiting for backend..."
          for i in {1..30}; do
            if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
              echo "Backend is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Build frontend
        run: |
          cd website/app-shell
          npm run build

      - name: Start frontend preview server
        run: |
          cd website/app-shell
          nohup npx vite preview --port 5173 > preview.log 2>&1 &
          echo "Waiting for frontend..."
          for i in {1..15}; do
            if curl -sf http://localhost:5173 > /dev/null 2>&1; then
              echo "Frontend is ready!"
              break
            fi
            echo "Waiting... ($i/15)"
            sleep 2
          done

      - name: Run BIT tests
        id: bit
        run: |
          cd website/app-shell
          echo "ðŸ” Running Browser Integration Tests..."
          echo ""
          echo "BIT validates:"
          echo "  - No console.error on page load"
          echo "  - No unhandled promise rejections"
          echo "  - No 5xx responses"
          echo ""

          BIT_BASE_URL=http://localhost:5173 npx playwright test tests/bit \
            --config=tests/bit/playwright.config.ts \
            --project=chromium 2>&1 | tee /tmp/bit-output.txt

          EXIT_CODE=${PIPESTATUS[0]}

          # Count results
          PASSED=$(grep -c "âœ“" /tmp/bit-output.txt || true)
          FAILED=$(grep -c "âœ˜" /tmp/bit-output.txt || true)

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          exit $EXIT_CODE

      - name: BIT Summary
        if: always()
        run: |
          echo "## ðŸŒ Browser Integration Tests (BIT)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Passed | ${{ steps.bit.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | ${{ steps.bit.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.bit.outputs.failed }}" != "0" ]; then
            echo "âš ï¸ **Browser console errors detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Fix console errors or add to allowlist with expiry." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All pages load without console errors." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload BIT results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bit-results
          path: |
            website/app-shell/tests/bit/bit-results.json
            website/app-shell/tests/bit/playwright-report/
            /tmp/bit-output.txt
          if-no-files-found: ignore

      - name: Upload server logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bit-server-logs
          path: |
            backend/server.log
            website/app-shell/preview.log
          if-no-files-found: ignore

  # ============================================================================
  # INTEGRATION GATE (Final check)
  # ============================================================================
  integration-gate:
    name: Integration Integrity Gate
    runs-on: ubuntu-latest
    needs: [lit-tests, bit-tests]
    if: always()
    steps:
      - name: Check integration status
        run: |
          echo "## ðŸš¦ Integration Integrity Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          LIT_STATUS="${{ needs.lit-tests.result }}"
          BIT_STATUS="${{ needs.bit-tests.result }}"

          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| LIT (Layer Integration) | $LIT_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| BIT (Browser Integration) | $BIT_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$LIT_STATUS" == "success" ] && [ "$BIT_STATUS" == "success" ]; then
            echo "âœ… **Integration Integrity Verified**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All layer seams and browser integrations are correct." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Integration Integrity FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Integration errors detected. See test output for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Fix the integration errors" >> $GITHUB_STEP_SUMMARY
            echo "2. OR add to allowlist with expiry date" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
