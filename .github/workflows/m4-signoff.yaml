name: M4.5 Signoff Generation

# Generates .m4_signoff artifact ONLY after shadow run passes objective checks
# This job should be triggered after shadow validation completes successfully

on:
  workflow_dispatch:
    inputs:
      shadow_run_id:
        description: 'Shadow run ID or artifact name'
        required: true
        type: string
      target_cycles:
        description: 'Required shadow run cycles'
        required: false
        default: '2880'
        type: string
      force:
        description: 'Skip shadow run check (emergency only)'
        required: false
        default: 'false'
        type: boolean

  workflow_run:
    workflows: ["Shadow Validation"]
    types:
      - completed

env:
  TARGET_CYCLES: ${{ github.event.inputs.target_cycles || '2880' }}
  PROMETHEUS_URL: "http://127.0.0.1:9090"

jobs:
  validate-shadow-run:
    runs-on: ubuntu-latest
    outputs:
      shadow_passed: ${{ steps.validate.outputs.passed }}
      mismatch_count: ${{ steps.validate.outputs.mismatches }}
      cycle_count: ${{ steps.validate.outputs.cycles }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download shadow report artifact
        uses: actions/download-artifact@v4
        with:
          name: shadow-report
          path: ./
        continue-on-error: true

      - name: Check for shadow report
        id: check-report
        run: |
          if [[ -f "shadow_report.json" ]]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Shadow report not found"
          fi

      - name: Validate shadow run results
        id: validate
        run: |
          if [[ "${{ github.event.inputs.force }}" == "true" ]]; then
            echo "::warning::Force mode enabled - skipping shadow run validation"
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "mismatches=0" >> $GITHUB_OUTPUT
            echo "cycles=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [[ ! -f "shadow_report.json" ]]; then
            echo "::error::Shadow report not found and force mode not enabled"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Parse shadow report
          CYCLES=$(jq -r '.total_cycles // 0' shadow_report.json)
          MISMATCHES=$(jq -r '.golden_mismatch_total // .mismatches // 0' shadow_report.json)

          echo "cycles=$CYCLES" >> $GITHUB_OUTPUT
          echo "mismatches=$MISMATCHES" >> $GITHUB_OUTPUT

          echo "Shadow run: $CYCLES cycles, $MISMATCHES mismatches"

          # Validate
          if [[ "$MISMATCHES" -ne 0 ]]; then
            echo "::error::Golden mismatches detected: $MISMATCHES"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [[ "$CYCLES" -lt "$TARGET_CYCLES" ]]; then
            echo "::error::Insufficient cycles: $CYCLES < $TARGET_CYCLES"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "::notice::Shadow run validation passed"
          echo "passed=true" >> $GITHUB_OUTPUT

  generate-signoff:
    needs: validate-shadow-run
    if: needs.validate-shadow-run.outputs.shadow_passed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate .m4_signoff artifact
        id: signoff
        run: |
          GIT_SHA="${{ github.sha }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          RUNNER="${{ github.actor }}"
          RUN_ID="${{ github.run_id }}"
          CYCLES="${{ needs.validate-shadow-run.outputs.cycle_count }}"
          MISMATCHES="${{ needs.validate-shadow-run.outputs.mismatch_count }}"

          cat > .m4_signoff << EOF
          ${GIT_SHA} ${TIMESTAMP}
          # M4.5 Failure Catalog Integration Signoff
          #
          # This artifact authorizes enabling the following feature flags:
          #   - failure_catalog_runtime_integration
          #   - cost_simulator_runtime_integration
          #
          # Generated by: CI (${RUNNER})
          # Run ID: ${RUN_ID}
          # Shadow run: ${CYCLES} cycles, ${MISMATCHES} mismatches
          #
          # DO NOT EDIT MANUALLY
          #
          # To run the canary:
          #   python scripts/ops/canary/canary_runner.py \\
          #     --config scripts/ops/canary/configs/m4_canary.yaml \\
          #     --watch 300
          #
          EOF

          echo "Signoff generated:"
          cat .m4_signoff

          echo "signoff_sha=${GIT_SHA:0:12}" >> $GITHUB_OUTPUT

      - name: Upload signoff artifact
        uses: actions/upload-artifact@v4
        with:
          name: m4-signoff
          path: .m4_signoff
          retention-days: 30

      - name: Commit signoff (optional)
        if: github.event.inputs.force != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .m4_signoff
          git commit -m "ci: generate m4 signoff at run ${{ github.run_id }}

          Shadow run: ${{ needs.validate-shadow-run.outputs.cycle_count }} cycles
          Golden mismatches: ${{ needs.validate-shadow-run.outputs.mismatch_count }}

          ü§ñ Generated by GitHub Actions" || echo "No changes to commit"

          # Push to current branch (not main)
          git push origin HEAD || echo "::warning::Could not push signoff commit"

  notify-success:
    needs: [validate-shadow-run, generate-signoff]
    runs-on: ubuntu-latest
    if: always() && needs.generate-signoff.result == 'success'

    steps:
      - name: Send success notification
        env:
          WEBHOOK_URL: ${{ secrets.CANARY_WEBHOOK_URL }}
        if: env.WEBHOOK_URL != ''
        run: |
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "text": "‚úÖ **M4.5 Signoff Generated**\n\nShadow run: ${{ needs.validate-shadow-run.outputs.cycle_count }} cycles\nMismatches: ${{ needs.validate-shadow-run.outputs.mismatch_count }}\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\nNext: Run M4.5 canary with --watch 300"
            }' || true

  notify-failure:
    needs: validate-shadow-run
    runs-on: ubuntu-latest
    if: always() && needs.validate-shadow-run.outputs.shadow_passed != 'true'

    steps:
      - name: Send failure notification
        env:
          WEBHOOK_URL: ${{ secrets.CANARY_WEBHOOK_URL }}
        if: env.WEBHOOK_URL != ''
        run: |
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "text": "‚ùå **M4.5 Signoff BLOCKED**\n\nShadow run validation failed.\nCycles: ${{ needs.validate-shadow-run.outputs.cycle_count }}\nMismatches: ${{ needs.validate-shadow-run.outputs.mismatch_count }}\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }' || true
