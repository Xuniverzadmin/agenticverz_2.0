# Preflight Console Promotion Checkpoint

**Status:** ACTIVE
**Effective:** 2026-01-07
**Scope:** L2.1 UI Projection Pipeline → Production Console

---

## Purpose

This document defines the governance gates that MUST pass before promoting
UI changes from `preflight-console.agenticverz.com` to `console.agenticverz.com`.

**Principle:**
> No UI change reaches production without explicit validation in preflight.
> Preflight is for testing. Production is for truth.

---

## Promotion Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      L2.1 UI PROMOTION FLOW                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   L2.1 Excel                                                            │
│       │                                                                 │
│       ▼                                                                 │
│   [A] Raw Intent Parser                                                 │
│       │                                                                 │
│       ▼                                                                 │
│   [B] Intent Normalizer                                                 │
│       │                                                                 │
│       ▼                                                                 │
│   [C] Intent Compiler (HOSTILE validation)                              │
│       │                                                                 │
│       ▼                                                                 │
│   [D] Projection Builder                                                │
│       │                                                                 │
│       ▼                                                                 │
│   ui_projection_lock.json (LOCKED)                                      │
│       │                                                                 │
│       ▼                                                                 │
│   [E] Build Preflight Console                                           │
│       │                                                                 │
│       ▼                                                                 │
│   preflight-console.agenticverz.com                                     │
│       │                                                                 │
│       │  ┌─────────────────────────────────┐                           │
│       └──│   GOVERNANCE CHECKPOINT         │                           │
│          │   (All gates must PASS)         │                           │
│          └─────────────────────────────────┘                           │
│                      │                                                  │
│                      ▼                                                  │
│   [F] Promote to Production                                             │
│       │                                                                 │
│       ▼                                                                 │
│   console.agenticverz.com                                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Governance Gates

### Gate 1: Pipeline Integrity (BLOCKING)

**Requirement:** Projection lock must be generated by the pipeline, not manually edited.

**Validation:**
```bash
python3 scripts/ci/validate_projection_lock.py
```

**Pass Criteria:**
- Schema validation: PASS
- Integrity check (regenerate & compare): PASS

**Failure Response:**
```
GATE-1 BLOCKED: Projection lock integrity check failed.
Manual edits detected. Regenerate via pipeline.
```

---

### Gate 2: Preflight Build Success (BLOCKING)

**Requirement:** Preflight console must build without errors.

**Validation:**
```bash
./scripts/ops/build_preflight_console.sh
```

**Pass Criteria:**
- npm install: SUCCESS
- vite build: SUCCESS
- dist-preflight directory created

**Failure Response:**
```
GATE-2 BLOCKED: Preflight build failed.
Fix build errors before promotion.
```

---

### Gate 3: Preflight Accessibility (BLOCKING)

**Requirement:** Preflight console must be accessible and return 200.

**Validation:**
```bash
curl -s -o /dev/null -w "%{http_code}" https://preflight-console.agenticverz.com
```

**Pass Criteria:**
- HTTP status: 200
- Response contains expected content

**Failure Response:**
```
GATE-3 BLOCKED: Preflight console not accessible.
Check Apache config and DNS.
```

---

### Gate 4: Domain/Panel/Control Integrity (BLOCKING)

**Requirement:** All domains, panels, and controls from L2.1 must render.

**Validation:** Manual or automated visual regression test.

**Pass Criteria:**
- All 5 domains visible in sidebar
- Panel counts match projection lock
- No console errors

**Failure Response:**
```
GATE-4 BLOCKED: UI rendering mismatch.
Verify preflight console matches projection lock.
```

---

### Gate 5: Auth Flow Validation (BLOCKING)

**Requirement:** Authentication must work correctly.

**Validation:**
- Login with Clerk
- Verify user context
- Test protected routes

**Pass Criteria:**
- Login flow completes
- User context populated
- Protected routes accessible after auth

**Failure Response:**
```
GATE-5 BLOCKED: Auth validation failed.
Check Clerk configuration.
```

---

### Gate 6: Human Approval (BLOCKING)

**Requirement:** Founder or designated reviewer must explicitly approve promotion.

**Validation:** Manual approval in promotion script.

**Pass Criteria:**
- Explicit "yes" confirmation
- Reviewer name recorded

**Failure Response:**
```
GATE-6 BLOCKED: Human approval required.
Run promotion script interactively.
```

---

## Promotion Checklist

Before running `./scripts/ops/promote_to_production.sh`:

```
PREFLIGHT PROMOTION CHECKLIST

1. [ ] Pipeline ran successfully (all 4 stages)
2. [ ] Projection lock validation: PASS
3. [ ] Preflight build: SUCCESS
4. [ ] Preflight console accessible: YES
5. [ ] All domains render correctly: YES
6. [ ] All panels load without errors: YES
7. [ ] Auth flow tested: YES
8. [ ] No console errors: YES
9. [ ] Visual review completed: YES
10. [ ] Founder approval: YES

Reviewer: _______________
Date: _______________
```

---

## Rollback Procedure

If issues are discovered after promotion:

1. **Immediate:** Restore previous production build
   ```bash
   ./scripts/ops/promote_to_production.sh --rollback
   ```

2. **Investigation:** Check preflight for the issue

3. **Fix:** Update L2.1, regenerate pipeline, rebuild preflight

4. **Re-promote:** After gates pass again

---

## Anti-Patterns (FORBIDDEN)

| Action | Reason |
|--------|--------|
| Manual edit of ui_projection_lock.json | Bypasses validation |
| Direct copy to production without preflight | Skips testing |
| Promotion without human approval | Governance violation |
| Editing production dist directly | Unmaintainable |
| Skipping any gate | False confidence |

---

## References

- `scripts/tools/run_l2_pipeline.sh` - Full pipeline runner
- `scripts/ci/validate_projection_lock.py` - CI validation
- `scripts/ops/build_preflight_console.sh` - Preflight builder
- `scripts/ops/promote_to_production.sh` - Production promoter
- `design/l2_1/ui_contract/ui_projection_lock.json` - Source of truth
