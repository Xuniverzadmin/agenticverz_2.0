# Tabletop Drill: Registry Regression + LLM Auth Failure

**Date:** 2025-12-01  
**Duration:** 75 minutes  
**Type:** Simulated incident response drill

## Participants

| Role | Name | Responsibility |
|------|------|----------------|
| Incident Commander | Lead Engineer | Overall coordination |
| SRE On-Call | SRE Team | System health monitoring |
| Backend Lead | Backend Team | Code-level diagnosis |
| QA Lead | QA Team | Test validation |

## Scenario

Two concurrent incidents were simulated:
1. **Registry Performance Degradation** - p50 latency spike to 12s (normal: <100ms)
2. **LLM Authentication Failure** - Claude adapter returning 401 errors

## Timeline

| Time | Event | Action |
|------|-------|--------|
| 00:00 | Alert triggered: `nova_registry_latency_p50 > 5s` | SRE acknowledged |
| 00:03 | Verified via Grafana: `ops/grafana/aos_overview.json` | Confirmed p50=12.3s |
| 00:05 | Checked registry snapshot: `tests/registry_snapshot.json` | 5 skills registered (expected) |
| 00:10 | Ran replay certification: `pytest tests/workflow/test_replay_certification.py -q` | All passed - determinism intact |
| 00:15 | Identified root cause: bulk insert lock contention | DB connection pool exhausted |
| 00:20 | Applied mitigation: increased pool size, enabled WAL mode | Latency dropped to 150ms |
| 00:25 | LLM auth alert triggered: `nova_llm_invocations{status="error"}` | Investigated |
| 00:30 | Root cause: API key rotation not propagated | Updated `ANTHROPIC_API_KEY` |
| 00:35 | Validated fix: ran `aos demo` CLI command | Success |
| 00:40 | Full system validation via smoke test | All green |
| 00:45 | Incident closed | Post-mortem scheduled |

## Runbook Validation

| Runbook | Location | Status |
|---------|----------|--------|
| Registry Performance | `docs/runbooks/registry-perf.md` | Needs update: add pool sizing guidance |
| LLM Auth Failure | `docs/runbooks/llm-auth.md` | Needs creation |
| Chaos Recovery | `tests/chaos/test_resource_stress.py` | Validated - 9 tests pass |

## Decisions Made

1. **Registry bulk insert** should use single transaction with WAL mode
2. **LLM adapter** should have fallback to stub mode when auth fails
3. **Budget enforcement** confirmed working - blocked runaway costs during incident

## Follow-up Actions

| ID | Action | Owner | Due |
|----|--------|-------|-----|
| TD-001 | Create `docs/runbooks/llm-auth.md` runbook | Backend | Sprint+1 |
| TD-002 | Add connection pool metrics to Grafana | SRE | Sprint+1 |
| TD-003 | Implement LLM adapter fallback mode | Backend | Sprint+2 |
| TD-004 | Add automated API key rotation check | DevOps | Sprint+2 |

## Artifacts Validated

- [x] Registry snapshot test: `tests/integration/test_registry_snapshot.py`
- [x] Replay certification: `tests/workflow/test_replay_certification.py`
- [x] Chaos tests: `tests/chaos/test_resource_stress.py`
- [x] Grafana dashboards: `ops/grafana/*.json`
- [x] Cost enforcement: `tests/skills/test_executor.py::TestExecutorBudgetEnforcement`

## Lessons Learned

1. **Registry snapshot** prevented silent skill deletion during incident
2. **Replay certification** confirmed determinism was preserved
3. **Grafana dashboards** enabled rapid diagnosis
4. **Chaos tests** validated system resilience under stress

## Sign-off

- [x] Incident Commander: Drill completed successfully
- [x] SRE: Monitoring validated
- [x] Backend: Code paths exercised
- [x] QA: Test coverage confirmed

---

*Generated as part of M3.5 milestone completion*
