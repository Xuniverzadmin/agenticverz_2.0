# L2 Intent Declaration: Guard Policies
# Reference: PIN-300 (Semantic Promotion Gate)
# Surface: /guard/policies, /guard/policies/guardrails/{id}
#
# STATUS: DRAFT â€” Awaiting Founder Review
# RISK PROFILE: Tier-2 (constraint definition vs optimization/effectiveness boundary)

intent_id: L2-GUARD-POLICIES
status: DRAFT  # DRAFT | APPROVED | FROZEN
owner: governance
reviewed_by: []

# =============================================================================
# 1. SEMANTIC PURPOSE
# =============================================================================

question_answered: >
  Which policy constraints are defined for this tenant, and what is their
  current state?

  Specifically:
  - SUMMARY: What budget limits, rate limits, and guardrails exist?
  - DETAIL: What is the configuration of a specific guardrail?

non_goals:
  - effectiveness_measurement  # "Is this policy working?" is never answered
  - optimization_suggestion  # No "you should increase your limit"
  - causal_explanation  # "Why was this blocked?" is Incidents, not Policies
  - best_practices_guidance  # No "recommended settings"
  - threshold_exposure  # Internal trigger values are not customer-visible
  - cross_tenant_comparison  # No "your policy is stricter than average"
  - policy_creation  # Defining new policies is a separate control surface
  - policy_modification  # Changing policies is a separate control surface
  - incident_linkage  # No "this policy caused that incident"

# =============================================================================
# 2. DOMAIN PLACEMENT
# =============================================================================

domain: Policies  # Frozen domain per CUSTOMER_CONSOLE_V1_CONSTITUTION.md
subdomain: Policy Constraints
topic: Policy Constraint  # Singular - depth handled by Order, not topic naming

justification: >
  Policies represent defined constraints and protections. The domain answers
  "How is behavior defined?" per v1 constitution. It shows what exists, not
  what should exist or how well it works. Cannot be merged with Activity,
  Incidents, or Logs.

# =============================================================================
# 3. AUTHORITY SEMANTICS
# =============================================================================

authority_type: projection
mutates_state: false

human_action_required: false  # This surface is read-only

explicitly_forbidden:
  - mutation  # Policy creation/modification is separate control surface
  - threshold_exposure  # Internal trigger values are implementation detail
  - effectiveness_scoring  # No "policy health" or "coverage" metrics
  - optimization_advice  # No "you should..." recommendations
  - incident_correlation  # No linking policies to specific incidents
  - comparison  # No cross-tenant or cross-time policy comparison

endpoints:
  - path: GET /guard/policies
    authority: projection
    mutates: false
    explicitly_forbidden:
      - aggregation
      - effectiveness_metrics
      - optimization_recommendations
      - usage_trend_analysis

  - path: GET /guard/policies/guardrails/{id}
    authority: projection
    mutates: false
    explicitly_forbidden:
      - threshold_exposure
      - trigger_history
      - effectiveness_analysis
      - related_incident_suggestion

# =============================================================================
# 4. SOURCE OF TRUTH
# =============================================================================

primary_sources:
  - L4: CustomerPolicyReadService (constraints, guardrail_detail)
  - L6: Policy tables (via L4 only, no direct access)

secondary_sources:
  - AuditLog  # Supporting chronology only

derived: false  # Policy constraints are stored definitions, not computed

derivation_rules:
  - Constraints are stored definitions, not inferred
  - Usage counters are current state, not historical analysis
  - No effectiveness computation
  - No cross-policy correlation
  - No trending or forecasting

# =============================================================================
# 5. RBAC & VISIBILITY
# =============================================================================

visible_to_roles:
  viewer:
    access: read_only
    endpoints: [summary, detail]
  developer:
    access: read_only
    endpoints: [summary, detail]
    note: Can view constraints for debugging
  admin:
    access: read_only
    endpoints: [summary, detail]
  owner:
    access: read_only
    endpoints: [summary, detail]

hidden_from:
  - machine  # API tokens should not bulk-export policy definitions

cross_tenant: forbidden  # Customer sees only their own tenant's policies

tenant_isolation:
  enforced_by: L3 adapter (CustomerPoliciesAdapter)
  mechanism: tenant_id parameter required on all methods
  failure_mode: returns None/empty, never exposes other tenant data

# =============================================================================
# 6. L1 CONSUMPTION CONTRACT
# =============================================================================

ui_allowed:
  - O2_list  # Summary of budget, rate limits, guardrails
  - O3_detail  # Full guardrail configuration view
  - O5_proof  # Raw constraint values for audit

ui_forbidden:
  - effectiveness_dashboard  # No "policy health" or "coverage" visualizations
  - optimization_panel  # No "recommended adjustments" UI
  - trend_charts  # No "usage over time" graphs
  - comparison_view  # No "vs recommended" or "vs other tenants"
  - incident_linkage  # No "incidents triggered by this policy"
  - threshold_display  # Internal trigger values must not be shown
  - ranking  # No "most triggered" or "least effective"
  - forecasting  # No "you will hit limit in X days"
  - narrative_explanation  # No "this policy protects against..."
  - inferred_relationships  # No implicit linking between policies

vocabulary_rules:
  - Use "constraint" not "rule" (constraint is factual, rule implies authority)
  - Use "defined" not "configured" (defined is static, configured implies tuning)
  - Use "limit" not "threshold" (limit is visible boundary, threshold is internal)
  - Never use "effective" or "effectiveness" in policy context
  - Never use "recommended" or "optimal" in policy context
  - Never use "should" in policy descriptions

# =============================================================================
# 7. INVARIANTS & FORBIDDEN ASSUMPTIONS
# =============================================================================

forbidden_assumptions:
  - policy_explains_incident  # Policies define constraints, not explain events
  - policy_is_optimal  # No judgment on policy quality
  - policy_is_effective  # Effectiveness is not measurable here
  - higher_limit_is_better  # Limits have no quality gradient
  - triggered_is_bad  # A triggered guardrail is not inherently negative
  - usage_indicates_need  # High usage does not indicate need for adjustment
  - absence_is_risk  # Missing policy does not indicate vulnerability
  - policy_caused_failure  # Policies define constraints, not cause outcomes

invariants:
  - tenant_isolation_absolute  # Enforced at L3 adapter
  - constraints_are_definitions  # Policies show what is, not what should be
  - no_effectiveness_metrics  # No scoring or measurement of policy quality
  - no_threshold_exposure  # Internal trigger values never shown
  - no_incident_correlation  # Policies do not link to incidents
  - read_only_at_this_surface  # Mutation is separate control surface

# =============================================================================
# 8. PROMOTION DECISION
# =============================================================================

promotion_decision:
  approved: false
  approved_on: null
  approved_by: null
  notes: >
    DRAFT: Awaiting founder review.

    Evidence of readiness:
    - L3 adapter exists (CustomerPoliciesAdapter) and enforces tenant isolation
    - L4 service exists (CustomerPolicyReadService, read-only)
    - Customer-safe DTOs defined (no internal thresholds)
    - Wired in main.py

    Open questions for founder:
    1. percentage_used display: Show as fact or hide to prevent optimization mindset?
       (Recommend: SHOW as neutral fact, add vocabulary rule against "running low")
    2. action_on_trigger: Show (block/warn/log) or abstract to "protection level"?
       (Recommend: SHOW as fact - customer needs to know what happens)
    3. Policy CRUD: Separate surface or add to this intent later?
       (Recommend: SEPARATE surface - mutation has different authority semantics)

  once_approved:
    edits_require: new_intent_version
    frozen_fields:
      - question_answered
      - domain
      - authority_type
      - mutates_state
      - explicitly_forbidden
      - forbidden_assumptions
