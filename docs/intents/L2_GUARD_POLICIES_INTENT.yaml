# L2 Intent Declaration: Guard Policies
# Reference: PIN-300 (Semantic Promotion Gate)
# Surface: /guard/policies, /guard/policies/guardrails/{id}
#
# STATUS: APPROVED â€” Founder Reviewed 2026-01-05
# RISK PROFILE: Tier-2 (constraint definition vs optimization/effectiveness boundary)
#
# SCOPE NOTE: Prohibitions in this intent are SURFACE-SCOPED.
# Interpretation/analytics may exist in a separate domain (not here).

intent_id: L2-GUARD-POLICIES
status: APPROVED  # DRAFT | APPROVED | FROZEN
owner: governance
reviewed_by: [founder]

# =============================================================================
# 1. SEMANTIC PURPOSE
# =============================================================================

question_answered: >
  Which policy constraints are defined for this tenant, and what is their
  current state?

  Specifically:
  - SUMMARY: What budget limits, rate limits, and guardrails exist?
  - DETAIL: What is the configuration of a specific guardrail?

non_goals:
  # NOTE: These are non-goals FOR THIS SURFACE. Analytics domain may address some.
  - effectiveness_measurement  # Not answered HERE (may exist in Analytics)
  - optimization_suggestion  # Not provided HERE
  - causal_explanation  # "Why was this blocked?" is Incidents, not Policies
  - best_practices_guidance  # Not provided HERE
  - threshold_exposure  # Internal trigger values are not customer-visible
  - cross_tenant_comparison  # Not provided HERE
  - policy_creation  # Separate control surface
  - policy_modification  # Separate control surface
  - incident_linkage  # Not shown HERE (Analytics may correlate)

# =============================================================================
# 2. DOMAIN PLACEMENT
# =============================================================================

domain: Policies  # Frozen domain per CUSTOMER_CONSOLE_V1_CONSTITUTION.md
subdomain: Policy Constraints
topic: Policy Constraint  # Singular - depth handled by Order, not topic naming

justification: >
  Policies represent defined constraints and protections. The domain answers
  "How is behavior defined?" per v1 constitution. It shows what exists, not
  what should exist or how well it works. Cannot be merged with Activity,
  Incidents, or Logs.

# =============================================================================
# 3. AUTHORITY SEMANTICS
# =============================================================================

authority_type: projection
mutates_state: false

human_action_required: false  # This surface is read-only

explicitly_forbidden:
  # NOTE: Forbidden AT THIS SURFACE. Some may be permitted in Analytics domain.
  - mutation  # Policy creation/modification is separate control surface
  - threshold_exposure  # Internal trigger values are implementation detail
  - effectiveness_scoring  # Not at this surface (Analytics may provide)
  - optimization_advice  # Not at this surface
  - incident_correlation  # Not at this surface (Analytics may correlate)
  - comparison  # Not at this surface (Analytics may compare)

endpoints:
  - path: GET /guard/policies
    authority: projection
    mutates: false
    explicitly_forbidden:
      - aggregation
      - effectiveness_metrics
      - optimization_recommendations
      - usage_trend_analysis

  - path: GET /guard/policies/guardrails/{id}
    authority: projection
    mutates: false
    explicitly_forbidden:
      - threshold_exposure
      - trigger_history
      - effectiveness_analysis
      - related_incident_suggestion

# =============================================================================
# 4. SOURCE OF TRUTH
# =============================================================================

primary_sources:
  - L4: CustomerPolicyReadService (constraints, guardrail_detail)
  - L6: Policy tables (via L4 only, no direct access)

secondary_sources:
  - AuditLog  # Supporting chronology only

derived: false  # Policy constraints are stored definitions, not computed

derivation_rules:
  - Constraints are stored definitions, not inferred
  - Usage counters are current state, not historical analysis
  - No effectiveness computation
  - No cross-policy correlation
  - No trending or forecasting

# =============================================================================
# 5. RBAC & VISIBILITY
# =============================================================================

visible_to_roles:
  viewer:
    access: read_only
    endpoints: [summary, detail]
  developer:
    access: read_only
    endpoints: [summary, detail]
    note: Can view constraints for debugging
  admin:
    access: read_only
    endpoints: [summary, detail]
  owner:
    access: read_only
    endpoints: [summary, detail]

hidden_from:
  - machine  # API tokens should not bulk-export policy definitions

cross_tenant: forbidden  # Customer sees only their own tenant's policies

tenant_isolation:
  enforced_by: L3 adapter (CustomerPoliciesAdapter)
  mechanism: tenant_id parameter required on all methods
  failure_mode: returns None/empty, never exposes other tenant data

# =============================================================================
# 6. L1 CONSUMPTION CONTRACT
# =============================================================================

ui_allowed:
  - O2_list  # Summary of budget, rate limits, guardrails
  - O3_detail  # Full guardrail configuration view
  - O5_proof  # Raw constraint values for audit

ui_forbidden:
  # NOTE: Forbidden in L1 consumption of THIS surface. Analytics UI is separate.
  - effectiveness_dashboard  # Not here (Analytics may have)
  - optimization_panel  # Not here
  - trend_charts  # Not here (Analytics may have)
  - comparison_view  # Not here (Analytics may have)
  - incident_linkage  # Not here (Analytics may correlate)
  - threshold_display  # Internal trigger values must not be shown anywhere
  - ranking  # Not here (Analytics may rank)
  - forecasting  # Not here (Analytics may forecast)
  - narrative_explanation  # Not here
  - inferred_relationships  # Not here (Analytics may infer)

vocabulary_rules:
  # NOTE: These rules apply to THIS surface's L1 consumption only.
  - Use "constraint" not "rule" (constraint is factual, rule implies authority)
  - Use "defined" not "configured" (defined is static, configured implies tuning)
  - Use "limit" not "threshold" (limit is visible boundary, threshold is internal)
  - Avoid "effective" or "effectiveness" at this surface (Analytics may use)
  - Avoid "recommended" or "optimal" at this surface
  - Avoid "should" in policy descriptions at this surface

# =============================================================================
# 7. INVARIANTS & FORBIDDEN ASSUMPTIONS
# =============================================================================

forbidden_assumptions:
  # NOTE: Forbidden at THIS surface. Analytics may make some of these claims.
  - policy_explains_incident  # Not claimed here (Analytics may correlate)
  - policy_is_optimal  # Not claimed here (Analytics may advise)
  - policy_is_effective  # Not claimed here (Analytics may measure)
  - higher_limit_is_better  # Not claimed here
  - triggered_is_bad  # Not claimed here
  - usage_indicates_need  # Not claimed here (Analytics may interpret)
  - absence_is_risk  # Not claimed here
  - policy_caused_failure  # Not claimed here (Analytics may correlate)

invariants:
  # NOTE: These invariants apply to THIS surface.
  - tenant_isolation_absolute  # Enforced at L3 adapter (global)
  - constraints_are_definitions  # At this surface: what is, not what should be
  - no_effectiveness_metrics_here  # Not at this surface (Analytics may measure)
  - no_threshold_exposure  # Internal trigger values never shown (global)
  - no_incident_correlation_here  # Not at this surface (Analytics may correlate)
  - read_only_at_this_surface  # Mutation is separate control surface

# =============================================================================
# 8. PROMOTION DECISION
# =============================================================================

promotion_decision:
  approved: true
  approved_on: 2026-01-05
  approved_by: founder
  notes: >
    APPROVED: Founder reviewed and approved.

    Evidence of readiness:
    - L3 adapter exists (CustomerPoliciesAdapter) and enforces tenant isolation
    - L4 service exists (CustomerPolicyReadService, read-only)
    - Customer-safe DTOs defined (no internal thresholds)
    - Wired in main.py

    Founder decisions on open questions:
    1. percentage_used display: SHOW as neutral fact (freeze-safe)
    2. action_on_trigger: SHOW RAW (block/warn/log) - customer needs to know
    3. Policy CRUD: SEPARATE surface (non-negotiable - mutation has different
       authority semantics)

    SCOPE ACKNOWLEDGMENT:
    This intent explicitly allows Analytics domain to exist separately.
    Analytics may interpret, correlate, trend, and advise - but not HERE.
    Analytics will require its own intent declaration (ANALYTICS_INTENT.yaml).

  once_approved:
    edits_require: new_intent_version
    frozen_fields:
      - question_answered
      - domain
      - authority_type
      - mutates_state
      - explicitly_forbidden
      - forbidden_assumptions
