# DRIVER INVENTORY SCHEMA (PIN-468 / Phase-2.5A)
#
# Purpose: Single source of truth for persistence authority
# Rule: MUST consult before extracting any DB logic
# Enforcement: CI validation (future), manual review (now)
#
# DUPLICATION PREVENTION RULE:
# Before adding any new persistence method:
# 1. Search this inventory: grep -R "semantic:" driver_inventory.yaml
# 2. If existing method satisfies ≥70% of intent → REUSE or EXTEND
# 3. Do NOT create parallel methods or duplicate drivers

version: "1.0"
last_updated: "2026-01-24"
phase: "PIN-468 / Phase-2.5A"

# =============================================================================
# DRIVER REGISTRY
# =============================================================================

drivers:

  # ===========================================================================
  # INCIDENT WRITE DRIVER (Primary incident persistence)
  # ===========================================================================
  - driver_id: incident_write_driver
    location: hoc/cus/incidents/L6_drivers/incident_write_driver.py
    authority: INCIDENT_PERSISTENCE
    domains:
      - customer/incidents
    owns_tables:
      - incidents
      - incident_events
      - prevention_records
      - policy_proposals
      - runs (incident_count field only)
      - aos_traces (incident_id field only)
    methods:
      - name: insert_incident
        semantic: create new incident record with full metadata
        tables: [incidents]
        operation: INSERT
      - name: update_incident_acknowledged
        semantic: transition incident status to acknowledged
        tables: [incidents]
        operation: UPDATE
      - name: update_incident_resolved
        semantic: transition incident status to resolved
        tables: [incidents]
        operation: UPDATE
      - name: create_incident_event
        semantic: append incident lifecycle/timeline event
        tables: [incident_events]
        operation: INSERT
      - name: insert_prevention_record
        semantic: persist prevention decision (policy suppression)
        tables: [prevention_records]
        operation: INSERT
      - name: insert_policy_proposal
        semantic: create policy proposal artifact from incident
        tables: [policy_proposals]
        operation: INSERT
      - name: update_run_incident_count
        semantic: increment run incident counter
        tables: [runs]
        operation: UPDATE
      - name: update_trace_incident_id
        semantic: bind incident to trace for correlation
        tables: [aos_traces]
        operation: UPDATE
      - name: fetch_suppressing_policy
        semantic: check if active policy suppresses this error pattern
        tables: [policy_rules]
        operation: SELECT
      - name: fetch_incidents_by_run_id
        semantic: get all incidents linked to a run
        tables: [incidents]
        operation: SELECT
      - name: refresh_incident
        semantic: refresh incident from database after commit
        tables: [incidents]
        operation: REFRESH
      - name: commit
        semantic: commit transaction
        tables: []
        operation: TRANSACTION

  # ===========================================================================
  # LESSONS DRIVER (Lessons learned persistence)
  # ===========================================================================
  - driver_id: lessons_driver
    location: hoc/cus/incidents/L6_drivers/lessons_driver.py
    authority: LESSONS_PERSISTENCE
    domains:
      - customer/incidents
    owns_tables:
      - lessons_learned
      - policy_proposals (lesson conversion only)
    methods:
      - name: insert_lesson
        semantic: create lesson record from system event
        tables: [lessons_learned]
        operation: INSERT
      - name: fetch_lesson_by_id
        semantic: get single lesson with all fields
        tables: [lessons_learned]
        operation: SELECT
      - name: fetch_lessons_list
        semantic: list lessons with filters (tenant, status, type)
        tables: [lessons_learned]
        operation: SELECT
      - name: fetch_lesson_stats
        semantic: aggregate stats by type/status
        tables: [lessons_learned]
        operation: SELECT
      - name: update_lesson_deferred
        semantic: set deferred status with deferred_until timestamp
        tables: [lessons_learned]
        operation: UPDATE
      - name: update_lesson_dismissed
        semantic: set dismissed status with metadata
        tables: [lessons_learned]
        operation: UPDATE
      - name: update_lesson_converted
        semantic: set converted_to_draft status with proposal_id
        tables: [lessons_learned]
        operation: UPDATE
      - name: update_lesson_reactivated
        semantic: set pending status, clear deferred_until
        tables: [lessons_learned]
        operation: UPDATE
      - name: fetch_debounce_count
        semantic: check recent lessons for debounce decision
        tables: [lessons_learned]
        operation: SELECT
      - name: fetch_expired_deferred
        semantic: get deferred lessons past expiry for reactivation
        tables: [lessons_learned]
        operation: SELECT
      - name: insert_policy_proposal_from_lesson
        semantic: create draft proposal when lesson converts
        tables: [policy_proposals]
        operation: INSERT
      - name: commit
        semantic: commit transaction
        tables: []
        operation: TRANSACTION

  # ===========================================================================
  # POLICY VIOLATION DRIVER (Policy violation persistence - ASYNC)
  # ===========================================================================
  - driver_id: policy_violation_driver
    location: hoc/cus/incidents/L6_drivers/policy_violation_driver.py
    authority: POLICY_VIOLATION_PERSISTENCE
    domains:
      - customer/incidents
    owns_tables:
      - prevention_records (violation outcome records)
      - incident_events (evidence capture)
    shared_tables:
      - incidents (read-only for idempotency check)
      - policy_rules (read-only for policy enabled check)
    methods:
      - name: insert_violation_record
        semantic: create violation fact in prevention_records
        tables: [prevention_records]
        operation: INSERT
      - name: fetch_violation_exists
        semantic: check if violation record exists (idempotency)
        tables: [prevention_records]
        operation: SELECT
      - name: fetch_policy_enabled
        semantic: check if policy is active for tenant
        tables: [policy_rules]
        operation: SELECT
      - name: insert_evidence_event
        semantic: create evidence capture event for violation
        tables: [incident_events]
        operation: INSERT
      - name: fetch_incident_by_violation
        semantic: check for existing incident by violation pattern
        tables: [incidents]
        operation: SELECT
      - name: fetch_violation_truth_check
        semantic: get all data for S3 truth verification
        tables: [prevention_records, incidents, incident_events]
        operation: SELECT
      - name: insert_policy_evaluation
        semantic: create policy evaluation record (async)
        tables: [prevention_records]
        operation: INSERT
      - name: insert_policy_evaluation_sync
        semantic: create policy evaluation record (sync/psycopg2)
        tables: [prevention_records]
        operation: INSERT
      - name: commit
        semantic: commit async transaction
        tables: []
        operation: TRANSACTION

  # ===========================================================================
  # LLM FAILURE DRIVER (LLM failure persistence - ASYNC)
  # ===========================================================================
  - driver_id: llm_failure_driver
    location: hoc/cus/incidents/L6_drivers/llm_failure_driver.py
    authority: LLM_FAILURE_PERSISTENCE
    domains:
      - customer/incidents
    owns_tables:
      - run_failures
      - failure_evidence
      - worker_runs (status/error fields only)
    shared_tables:
      - cost_records (read-only for contamination check)
      - cost_anomalies (read-only for contamination check)
      - incidents (read-only for contamination check)
    methods:
      - name: insert_failure
        semantic: create failure fact in run_failures
        tables: [run_failures]
        operation: INSERT
      - name: insert_evidence
        semantic: create evidence record for failure
        tables: [failure_evidence]
        operation: INSERT
      - name: update_run_failed
        semantic: mark run as failed with error
        tables: [worker_runs]
        operation: UPDATE
      - name: fetch_failure_by_run_id
        semantic: get failure record by run ID
        tables: [run_failures]
        operation: SELECT
      - name: fetch_contamination_check
        semantic: verify no downstream artifacts created
        tables: [cost_records, cost_anomalies, incidents]
        operation: SELECT
      - name: commit
        semantic: commit async transaction
        tables: []
        operation: TRANSACTION

  # ===========================================================================
  # POSTMORTEM DRIVER (Post-mortem analytics - ASYNC, READ-ONLY)
  # ===========================================================================
  - driver_id: postmortem_driver
    location: hoc/cus/incidents/L6_drivers/postmortem_driver.py
    authority: POSTMORTEM_ANALYTICS
    domains:
      - customer/incidents
    shared_tables:
      - incidents (read-only for analytics)
      - incident_evidence (read-only for analytics)
    methods:
      - name: fetch_category_stats
        semantic: get incident counts and resolution times for category
        tables: [incidents]
        operation: SELECT
      - name: fetch_resolution_methods
        semantic: get common resolution methods for category
        tables: [incidents]
        operation: SELECT
      - name: fetch_recurrence_data
        semantic: get recurrence rate data for category
        tables: [incidents]
        operation: SELECT
      - name: fetch_resolution_summary
        semantic: get resolution summary for single incident
        tables: [incidents, incident_evidence]
        operation: SELECT
      - name: fetch_similar_incidents
        semantic: find similar resolved incidents
        tables: [incidents, incident_evidence]
        operation: SELECT

  # ===========================================================================
  # INCIDENT PATTERN DRIVER (Pattern detection - ASYNC, READ-ONLY)
  # ===========================================================================
  - driver_id: incident_pattern_driver
    location: hoc/cus/incidents/L6_drivers/incident_pattern_driver.py
    authority: INCIDENT_PATTERN_FACTS
    domains:
      - customer/incidents
    shared_tables:
      - incidents (read-only for pattern detection)
    methods:
      - name: fetch_incidents_count
        semantic: count incidents in time window
        tables: [incidents]
        operation: SELECT
      - name: fetch_category_clusters
        semantic: get incidents grouped by category
        tables: [incidents]
        operation: SELECT
      - name: fetch_severity_spikes
        semantic: get high/critical incidents in last hour
        tables: [incidents]
        operation: SELECT
      - name: fetch_cascade_failures
        semantic: get incidents grouped by source run
        tables: [incidents]
        operation: SELECT

  # ===========================================================================
  # POLICY LIMITS DRIVER (Policy limits CRUD - Phase-2.5A)
  # ===========================================================================
  - driver_id: policy_limits_driver
    location: hoc/cus/policies/L6_drivers/policy_limits_driver.py
    authority: LIMIT_PERSISTENCE
    domains:
      - customer/policies
    owns_tables:
      - limits
      - limit_integrity
    methods:
      - name: fetch_limit_by_id
        semantic: get limit by ID with tenant scope
        tables: [limits]
        operation: SELECT
      - name: add_limit
        semantic: add limit to session
        tables: [limits]
        operation: INSERT
      - name: add_integrity
        semantic: add integrity record to session
        tables: [limit_integrity]
        operation: INSERT
      - name: flush
        semantic: flush pending changes
        tables: []
        operation: TRANSACTION

  # ===========================================================================
  # POLICY RULES DRIVER (Policy rules CRUD - Phase-2.5A)
  # ===========================================================================
  - driver_id: policy_rules_driver
    location: hoc/cus/policies/L6_drivers/policy_rules_driver.py
    authority: RULE_PERSISTENCE
    domains:
      - customer/policies
    owns_tables:
      - policy_rules
      - policy_rule_integrity
    methods:
      - name: fetch_rule_by_id
        semantic: get rule by ID with tenant scope
        tables: [policy_rules]
        operation: SELECT
      - name: add_rule
        semantic: add rule to session
        tables: [policy_rules]
        operation: INSERT
      - name: add_integrity
        semantic: add integrity record to session
        tables: [policy_rule_integrity]
        operation: INSERT
      - name: flush
        semantic: flush pending changes
        tables: []
        operation: TRANSACTION

  # ===========================================================================
  # POLICY ENGINE DRIVER (Core PolicyEngine data access - Phase-2.5A)
  # ===========================================================================
  - driver_id: policy_engine_driver
    location: hoc/cus/policies/L6_drivers/policy_engine_driver.py
    authority: POLICY_ENGINE_PERSISTENCE
    domains:
      - customer/policies
    owns_tables:
      - policy.evaluations
      - policy.violations
      - policy.policy_versions
      - policy.policy_provenance
      - policy.policy_dependencies
      - policy.policy_conflicts
      - policy.temporal_policies
      - policy.temporal_metric_events
      - policy.temporal_metric_windows
    shared_tables:
      - policy.ethical_constraints (read-only)
      - policy.risk_ceilings (read/write)
      - policy.safety_rules (read/write)
      - policy.business_rules (read-only)
    methods:
      - name: fetch_ethical_constraints
        semantic: load active ethical constraints
        tables: [policy.ethical_constraints]
        operation: SELECT
      - name: fetch_risk_ceilings
        semantic: load active risk ceilings
        tables: [policy.risk_ceilings]
        operation: SELECT
      - name: fetch_safety_rules
        semantic: load active safety rules
        tables: [policy.safety_rules]
        operation: SELECT
      - name: fetch_business_rules
        semantic: load active business rules
        tables: [policy.business_rules]
        operation: SELECT
      - name: insert_evaluation
        semantic: persist policy evaluation record
        tables: [policy.evaluations]
        operation: INSERT
      - name: insert_violation
        semantic: persist policy violation record
        tables: [policy.violations]
        operation: INSERT
      - name: fetch_violations
        semantic: list violations with filters
        tables: [policy.violations]
        operation: SELECT
      - name: update_violation_acknowledged
        semantic: acknowledge a violation
        tables: [policy.violations]
        operation: UPDATE
      - name: update_risk_ceiling
        semantic: update risk ceiling values
        tables: [policy.risk_ceilings]
        operation: UPDATE
      - name: reset_risk_ceiling
        semantic: reset risk ceiling current value
        tables: [policy.risk_ceilings]
        operation: UPDATE
      - name: update_safety_rule
        semantic: update safety rule properties
        tables: [policy.safety_rules]
        operation: UPDATE
      - name: fetch_policy_versions
        semantic: list policy versions
        tables: [policy.policy_versions]
        operation: SELECT
      - name: insert_policy_version
        semantic: create new policy version
        tables: [policy.policy_versions]
        operation: INSERT
      - name: insert_provenance
        semantic: record policy change provenance
        tables: [policy.policy_provenance]
        operation: INSERT
      - name: fetch_dependencies
        semantic: list policy dependencies
        tables: [policy.policy_dependencies]
        operation: SELECT
      - name: insert_dependency
        semantic: create policy dependency
        tables: [policy.policy_dependencies]
        operation: INSERT
      - name: fetch_conflicts
        semantic: list policy conflicts
        tables: [policy.policy_conflicts]
        operation: SELECT
      - name: resolve_conflict
        semantic: resolve policy conflict
        tables: [policy.policy_conflicts]
        operation: UPDATE
      - name: fetch_temporal_policies
        semantic: list temporal policies
        tables: [policy.temporal_policies]
        operation: SELECT
      - name: insert_temporal_policy
        semantic: create temporal policy
        tables: [policy.temporal_policies]
        operation: INSERT
      - name: delete_old_temporal_events
        semantic: GC old temporal events
        tables: [policy.temporal_metric_events]
        operation: DELETE
      - name: compact_temporal_events
        semantic: compact events to hourly aggregates
        tables: [policy.temporal_metric_events, policy.temporal_metric_windows]
        operation: INSERT/DELETE

  # ===========================================================================
  # KEYS DRIVER (API Keys CRUD - Phase-2.5A RECLASSIFIED)
  # ===========================================================================
  - driver_id: keys_driver
    location: hoc/cus/policies/L6_drivers/keys_driver.py
    authority: KEY_PERSISTENCE
    domains:
      - customer/policies
    owns_tables:
      - api_keys
    shared_tables:
      - proxy_calls (read-only for usage stats)
    methods:
      - name: fetch_keys_paginated
        semantic: list API keys for tenant with pagination
        tables: [api_keys]
        operation: SELECT
      - name: fetch_key_by_id
        semantic: get single API key by ID with tenant isolation
        tables: [api_keys]
        operation: SELECT
      - name: fetch_key_usage_today
        semantic: get today's request count and spend for key
        tables: [proxy_calls]
        operation: SELECT
      - name: update_key_frozen
        semantic: set frozen status on API key
        tables: [api_keys]
        operation: UPDATE

# =============================================================================
# TABLE OWNERSHIP MATRIX
# =============================================================================
# Rule: Only one driver may WRITE to a table unless explicitly approved

table_ownership:
  incidents:
    write: incident_write_driver
    read: [incident_write_driver, policy_violation_driver, llm_failure_driver, postmortem_driver, incident_pattern_driver]
  incident_events:
    write: [incident_write_driver, policy_violation_driver]
    read: [incident_write_driver, policy_violation_driver]
    note: "Both create events - incident_write for lifecycle, policy_violation for evidence"
  incident_evidence:
    write: null
    read: [postmortem_driver]
    note: "Read-only for analytics (evidence counts, recovery status)"
  prevention_records:
    write: [incident_write_driver, policy_violation_driver]
    read: [incident_write_driver, policy_violation_driver]
    note: "incident_write for suppression, policy_violation for violations/evaluations"
  policy_proposals:
    write: [incident_write_driver, lessons_driver]
    read: []
    note: "incident_write from incidents, lessons_driver from lesson conversion"
  lessons_learned:
    write: lessons_driver
    read: lessons_driver
  runs:
    write: incident_write_driver
    read: []
    note: "Only incident_count field"
  aos_traces:
    write: incident_write_driver
    read: []
    note: "Only incident_id field"
  policy_rules:
    write: policy_rules_driver
    read: [incident_write_driver, policy_violation_driver, policy_rules_driver]
    note: "Policies domain writes, incidents domain reads for suppression/enabled checks"
  run_failures:
    write: llm_failure_driver
    read: llm_failure_driver
    note: "LLM failure facts"
  failure_evidence:
    write: llm_failure_driver
    read: llm_failure_driver
    note: "Evidence records for LLM failures"
  worker_runs:
    write: llm_failure_driver
    read: []
    note: "Only status/error fields for failure marking"
  cost_records:
    write: null
    read: [llm_failure_driver]
    note: "Read-only for contamination check"
  cost_anomalies:
    write: null
    read: [llm_failure_driver]
    note: "Read-only for contamination check"
  limits:
    write: policy_limits_driver
    read: [policy_limits_driver]
    note: "Policy limits CRUD - Phase-2.5A"
  limit_integrity:
    write: policy_limits_driver
    read: [policy_limits_driver]
    note: "Integrity records for limits - Phase-2.5A"
  policy_rule_integrity:
    write: policy_rules_driver
    read: [policy_rules_driver]
    note: "Integrity records for rules - Phase-2.5A"
  api_keys:
    write: keys_driver
    read: [keys_driver]
    note: "API keys CRUD - Phase-2.5A (RECLASSIFIED from L4)"
  proxy_calls:
    write: null
    read: [keys_driver]
    note: "Read-only for usage stats (keys_driver.fetch_key_usage_today)"

# =============================================================================
# CROSS-DOMAIN OWNERSHIP (PIN-468 Phase-2.5A Containment)
# =============================================================================
# Reference: POLICIES_CROSS_DOMAIN_OWNERSHIP.md
# Rule: A persistence authority must be owned by exactly one domain

cross_domain_ownership:
  lessons_driver:
    owner: incidents
    consumers: [policies]
    canonical_path: hoc/cus/incidents/L5_engines/lessons_engine.py
    note: "Lessons are created from failure events (incidents domain owns write)"

  policy_violation_driver:
    owner: incidents
    consumers: [policies]
    canonical_path: hoc/cus/incidents/L5_engines/policy_violation_service.py
    note: "Violations are facts about run failures (incidents domain owns write)"

  # Tables NOT owned by policies domain for writes:
  # - lessons_learned (owned by incidents/lessons_driver)
  # - prevention_records (owned by incidents/policy_violation_driver)
  #
  # Policies domain may READ from these tables via driver read methods.

# =============================================================================
# DUPLICATION ALERTS
# =============================================================================
# These patterns indicate potential duplication - MUST resolve before creating

duplication_alerts:
  - pattern: "insert.*incident"
    canonical: incident_write_driver.insert_incident
    note: "All incident creation goes through incident_write_driver"
  - pattern: "insert.*event"
    canonical: incident_write_driver.create_incident_event
    note: "Evidence events via policy_violation_driver.insert_evidence_event"
  - pattern: "insert.*prevention"
    canonical: incident_write_driver.insert_prevention_record
    note: "Violation records via policy_violation_driver.insert_violation_record"
  - pattern: "insert.*proposal"
    canonical: incident_write_driver.insert_policy_proposal
    note: "Lesson conversion via lessons_driver.insert_policy_proposal_from_lesson"

# =============================================================================
# EXTRACTION CHECKLIST (Per File)
# =============================================================================
# Before committing extraction:
# [ ] driver_inventory.yaml consulted
# [ ] No duplicate authority created
# [ ] No duplicate method semantics added
# [ ] Inventory updated if and only if new persistence truly introduced
# If any box unchecked → extraction is invalid

# =============================================================================
# FREEZE RULE
# =============================================================================
# Once llm_failure_service.py is complete:
# - Inventory becomes append-only
# - Renames allowed
# - Deletions forbidden without PIN approval
