# Sweep-03: Legacy Module Migration

**Status:** LOCKED (Pending Execution)
**Created:** 2026-01-25
**Depends On:** Sweep-02A (L4_RUNTIME_WIRING) — CLOSED

---

## Invariant

> **Any service module imported by ≥2 HOC engines must have an HOC equivalent in `hoc/cus/*/L5_engines/`.**

---

## Rationale

Sweep-02A identified 64 deferred imports across 32 legacy modules. These imports cannot be rewired because no HOC equivalent exists. This sweep migrates those modules to HOC, enabling future import consolidation.

---

## Metric

**LEGACY_MODULE_BLOCKER** — Count of HOC engine imports pointing to legacy modules with no HOC equivalent

Formula:
```bash
python scripts/ops/sweep_03_module_blocker.py --count
```

---

## CRITICAL EXCLUSION

### Models Stay in `app/models/` (FROZEN)

**L6 Drivers MAY import from:**
- `app/models/*`
- `app/services/*/models.py` (data structures only)

**Reason:** Models are L7 artifacts. L6 drivers legitimately access them. This is not a violation.

**What this means:**
- `app.services.audit.models` → NOT migrated (L6 access OK)
- `app.services.audit.store` → MIGRATE (business logic)
- `app.services.governance.runtime_switch` → MIGRATE (business logic)

---

## In Scope

| Category | Action |
|----------|--------|
| Service modules with business logic | Migrate to `hoc/cus/*/L5_engines/` |
| Import statements in HOC engines | Update after migration |
| Re-exports in L4_runtime | Add if cross-domain |

### Migration Rules

1. **File location:** `app/services/{module}.py` → `app/hoc/cus/{domain}/L5_engines/{module}.py`
2. **No logic changes** — Copy code as-is
3. **No refactors** — Same structure, different location
4. **Add HOC header** — Layer, AUDIENCE, Role declarations
5. **Update imports** — In calling HOC engines only

---

## Out of Scope (FROZEN)

| Category | Reason |
|----------|--------|
| `app/models/*` | L7 models stay where they are |
| `app/services/*/models.py` | Data structures, not business logic |
| L6 Driver imports | Legitimately access models |
| Business logic changes | Structural migration only |
| Raw SQL refactoring | Deferred to Sweep-02C |
| Time/UUID authorities | Deferred to Sweep-02B |
| API changes | No interface changes |

---

## Execution Rules

1. **One domain at a time** — Complete domain X before starting domain Y
2. **Script-driven** — Use `sweep_03_module_blocker.py` for tracking
3. **No business logic changes** — Copy, move, update imports
4. **Preserve behavior** — Same code, different path
5. **Record in progress log** — After each domain completion

---

## Migration Priority (Excluding Models)

Generated by `sweep_03_module_blocker.py --priority`:

| Priority | Module | Imports | Blocking Domains |
|----------|--------|---------|------------------|
| HIGH | `audit.store` | 6 | activity, incidents, logs, policies |
| HIGH | `governance.runtime_switch` | 5 | policies |
| HIGH | `policy_violation_service` | 4 | activity, incidents, policies |
| HIGH | `cost_anomaly_detector` | 4 | analytics, logs |
| MEDIUM | `policy.lessons_engine` | 3 | activity, incidents, policies |
| MEDIUM | `logs.audit_ledger_service_async` | 3 | policies |
| MEDIUM | `activity.*` (3 modules) | 6 | activity |
| MEDIUM | `soc2.control_registry` | 2 | incidents, policies |
| MEDIUM | `datasources.datasource_model` | 2 | integrations, logs |
| MEDIUM | `mediation.retrieval_mediator` | 2 | integrations, logs |
| MEDIUM | `connectors.connector_registry` | 2 | integrations, logs |
| MEDIUM | `replay_determinism` | 2 | logs, policies |
| LOW | 17 other modules | 17 | various |

**Total:** 31 modules, 58 blocking imports

**Note:** `audit.models` (6 imports) is EXCLUDED — it's a data structure module, L6 access OK.

---

## Domain Execution Order

| Order | Domain | Deferred Imports | Key Modules to Migrate |
|-------|--------|------------------|------------------------|
| 1 | policies | 17 | `governance.runtime_switch`, `logs.audit_ledger_service_async` |
| 2 | incidents | 15 | `policy_violation_service`, `recovery_*` |
| 3 | activity | 12 | `activity.*` services |
| 4 | logs | 12 | `cost_anomaly_detector` |
| 5 | integrations | 5 | `cus_*` services |
| 6 | analytics | 2 | (shares `cost_anomaly_detector` with logs) |
| 7 | general | 1 | `knowledge_lifecycle_manager` |

---

## Progress Log

| Timestamp | Domain | Before | After | Delta | Note |
|-----------|--------|--------|-------|-------|------|
| 2026-01-25T20:00 | — | 58 | — | — | Initial baseline (31 modules, 6 model imports excluded) |

### Baseline by Domain

| Domain | Blocked | Models (OK) | Status |
|--------|---------|-------------|--------|
| account | 0 | 0 | CLEAN |
| activity | 11 | 1 | BLOCKED |
| analytics | 2 | 0 | BLOCKED |
| api_keys | 0 | 0 | CLEAN |
| general | 1 | 0 | BLOCKED |
| incidents | 14 | 1 | BLOCKED |
| integrations | 5 | 0 | BLOCKED |
| logs | 9 | 3 | BLOCKED |
| overview | 0 | 0 | CLEAN |
| policies | 16 | 1 | BLOCKED |
| **TOTAL** | **58** | **6** | |

---

## Completion Criteria

- [ ] All HIGH priority modules migrated
- [ ] All MEDIUM priority modules migrated
- [ ] Each domain reaches CLEAN or CLEAN (models only)
- [ ] No regressions in functionality
- [ ] All HOC headers added to migrated files

---

## Validation Command

```bash
# Check current blocker count
python scripts/ops/sweep_03_module_blocker.py --count

# Show domain status
python scripts/ops/sweep_03_module_blocker.py --domains

# Show specific domain details
python scripts/ops/sweep_03_module_blocker.py --domain policies --verbose

# CI check (exits 1 if blockers remain)
python scripts/ops/sweep_03_module_blocker.py --ci
```

---

## References

- Sweep-01: `SWEEP_01_TRANSACTION_BYPASS_LOG.md` (CLOSED)
- Sweep-02A: `SWEEP_02A_L4_RUNTIME_WIRING.md` (CLOSED)
- HOC Topology: `HOC_LAYER_TOPOLOGY_V1.md`
