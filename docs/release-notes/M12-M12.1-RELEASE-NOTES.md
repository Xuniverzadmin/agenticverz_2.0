# Release Notes: M12 + M12.1

**Version:** M12.1
**Release Date:** 2025-12-13
**Status:** Staging Validated — Production Enablement Pending

---

## Overview

M12 + M12.1 delivers the **Multi-Agent Execution System** for AOS — a production-grade framework for running parallel jobs with coordinated agent workflows.

---

## What's New in M12

### Core Features

1. **Parallel Job Execution**
   - Create jobs with multiple items
   - Workers claim items concurrently using FOR UPDATE SKIP LOCKED
   - No duplicate claims under high concurrency

2. **Agent Skills**
   - `agent_spawn`: Start parallel worker workflows (5 credits)
   - `agent_invoke`: Request-response between agents (10 credits)
   - `blackboard_read/write/lock`: Shared state operations (1 credit each)

3. **Redis Blackboard**
   - Key-value storage with TTL
   - Atomic increment for counters
   - Distributed locks for coordination

4. **P2P Messaging**
   - Agent-to-agent messaging via PostgreSQL
   - LISTEN/NOTIFY for low-latency delivery
   - Message status tracking (pending, delivered, read)

5. **Agent Registry**
   - Register/deregister agent instances
   - Heartbeat monitoring
   - Stale agent detection

6. **Credit System**
   - Per-skill credit costs
   - Per-item billing for jobs
   - Credit reservation on job creation
   - Refunds on cancellation

---

## What's New in M12.1 (Stabilization)

### Bug Fixes

1. **Credit Ledger FK Ordering** — Fixed foreign key constraint violation
2. **Message Latency** — Implemented LISTEN/NOTIFY for sub-second delivery

### New Features

1. **Job Cancellation with Refunds**
   ```http
   POST /api/v1/jobs/{job_id}/cancel

   Response:
   {
     "job_id": "...",
     "status": "cancelled",
     "completed_items": 50,
     "cancelled_items": 50,
     "credits_refunded": 100.0
   }
   ```

2. **Pre-Execution Simulation**
   ```http
   POST /api/v1/jobs/simulate
   {
     "orchestrator_agent": "...",
     "worker_agent": "...",
     "task": "...",
     "items": [...],
     "parallelism": 10
   }

   Response:
   {
     "feasible": true,
     "estimated_credits": 205.0,
     "estimated_duration_seconds": 600,
     "budget_check": {"sufficient": true, ...},
     "risks": [],
     "warnings": []
   }
   ```

3. **Invoke Audit Trail**
   - Full audit logging for agent_invoke calls
   - Query by invoke_id, job_id, caller
   - Duration and credit tracking

### New Tables (Migration 026)

- `agents.invoke_audit` — Audit trail for invocations
- `agents.job_cancellations` — Cancellation history
- `agents.credit_balances` — Tenant credit tracking

---

## API Reference

### Job Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | /api/v1/jobs/simulate | Pre-execution simulation |
| POST | /api/v1/jobs | Create parallel job |
| GET | /api/v1/jobs/{id} | Get job status |
| POST | /api/v1/jobs/{id}/cancel | Cancel job |
| POST | /api/v1/jobs/{id}/claim | Worker claims item |
| POST | /api/v1/jobs/{id}/items/{item_id}/complete | Complete item |
| POST | /api/v1/jobs/{id}/items/{item_id}/fail | Fail item |

### Blackboard Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | /api/v1/blackboard/{key} | Read value |
| PUT | /api/v1/blackboard/{key} | Write value |
| POST | /api/v1/blackboard/{key}/increment | Atomic increment |
| POST | /api/v1/blackboard/{key}/lock | Lock operations |

### Agent Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | /api/v1/agents/register | Register agent |
| POST | /api/v1/agents/{id}/heartbeat | Send heartbeat |
| DELETE | /api/v1/agents/{id} | Deregister agent |
| GET | /api/v1/agents | List agents |
| POST | /api/v1/agents/{id}/messages | Send message |
| GET | /api/v1/agents/{id}/messages | Get inbox |

### Invocation Endpoint

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | /api/v1/invocations/respond | Respond to invoke |

---

## Credit Costs

| Skill | Cost |
|-------|------|
| agent_spawn | 5 credits |
| agent_invoke | 10 credits |
| blackboard_read | 1 credit |
| blackboard_write | 1 credit |
| blackboard_lock | 1 credit |
| job_item (processing) | 2 credits |

---

## Known Limitations

1. **Blackboard Scale** — Not validated beyond 1000 keys. Redis SCAN may degrade at 10K+ keys.

2. **Message Delivery** — At-most-once delivery. No dead letter queue for failed messages.

3. **No Hot Reload** — Agent skills must be registered at startup.

4. **Single Redis** — Blackboard uses single Redis instance. No clustering support.

---

## Database Migrations

### Migration 025: M12 Core Schema
- agents.instances
- agents.jobs
- agents.job_items
- agents.messages
- agents.invocations
- agents.credit_ledger

### Migration 026: M12.1 Stabilization
- agents.invoke_audit
- agents.job_cancellations
- agents.credit_balances
- Additional indexes

---

## Testing

### Validation Tests Passed

- 29 unit tests
- 13 integration tests
- 7 chaos tests (concurrency, worker death, lock contention)
- 1000×50 load test (configurable)
- Staging API validation

---

## Upgrade Path

1. Apply migration 026:
   ```bash
   DATABASE_URL="$PRODUCTION_URL" PYTHONPATH=. alembic upgrade head
   ```

2. Verify tables exist:
   ```sql
   SELECT table_name FROM information_schema.tables
   WHERE table_schema = 'agents';
   ```

3. Run validation script:
   ```bash
   python3 scripts/ops/m12_validation.py
   ```

---

## Related Documentation

- PIN-062: M12 Multi-Agent System
- PIN-063: M12.1 Stabilization
- PIN-064: M13 Boundary Checklist
- PIN-005: Machine-Native Architecture

---

## Contributors

- Claude Code (Implementation)
- Human Review (Validation)
