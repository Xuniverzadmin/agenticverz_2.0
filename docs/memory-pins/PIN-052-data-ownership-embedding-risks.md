# PIN-052: Data Ownership & Embedding Risks

**Status:** ACTIVE
**Date:** 2025-12-08
**Type:** Legal / Security

---

## Agent Output Ownership

### Ownership Layers

| Layer | Owner | Rights |
|-------|-------|--------|
| LLM Provider (Anthropic/OpenAI) | No claim | Usage subject to ToS |
| AOS Platform | Processing license | Store/analyze for service |
| User (Customer) | **Full ownership** | Responsible for use |

### Provider Terms (Current)

| Provider | Output Ownership | Train on Output? |
|----------|------------------|------------------|
| Anthropic | User owns | No (API) |
| OpenAI | User owns | No (API) |
| OpenAI Embeddings | User owns vectors | No |

### Recommended AOS Terms of Service

```
You retain all ownership of:
- Inputs you provide to AOS
- Outputs generated by agents on your behalf
- Data stored in your tenant

AOS retains a limited license to:
- Process your data to provide the service
- Store anonymized, aggregated patterns for improvement
- Generate embeddings for similarity matching

AOS does NOT:
- Claim ownership of your outputs
- Sell your data to third parties
- Train models on your specific data without consent
```

---

## Embedding Risks

### Risk Matrix

| Risk | Severity | Likelihood | Status |
|------|----------|------------|--------|
| Embedding reversal | HIGH | LOW | Acceptable |
| Secrets in embeddings | HIGH | HIGH | **MITIGATE** |
| Cross-tenant inference | MEDIUM | LOW | Mitigated |
| Provider data access | MEDIUM | LOW | Acceptable |

### Critical Risk: Secrets in Error Messages

**Problem:**
```python
# Raw error gets embedded
"Failed to connect with password=SuperSecret123"
# Stored in pgvector → searchable → exposable
```

**Solution: Sanitize Before Embedding**

```python
# app/services/sanitizer.py
import re

PATTERNS = [
    (r'sk_live_[a-zA-Z0-9]{20,}', '[STRIPE_KEY]'),
    (r'sk_test_[a-zA-Z0-9]{20,}', '[STRIPE_TEST_KEY]'),
    (r'Bearer\s+[a-zA-Z0-9._-]+', 'Bearer [TOKEN]'),
    (r'api[_-]?key[=:]\s*\S+', 'api_key=[REDACTED]'),
    (r'password[=:]\s*\S+', 'password=[REDACTED]'),
    (r'secret[=:]\s*\S+', 'secret=[REDACTED]'),
    (r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b', '[EMAIL]'),
]

def sanitize(text: str) -> str:
    for pattern, replacement in PATTERNS:
        text = re.sub(pattern, replacement, text, flags=re.I)
    return text
```

### Cross-Tenant Isolation

**Requirement:** Always filter by tenant_id

```python
# CRITICAL: Never cross tenant boundaries
results = db.execute("""
    SELECT * FROM failure_matches
    WHERE tenant_id = :tenant_id
      AND embedding <-> :query_vec < 0.3
    ORDER BY embedding <-> :query_vec
    LIMIT 5
""", {"tenant_id": tenant_id, "query_vec": embedding})
```

---

## Mitigations

### Before Beta (P1)

| Action | Effort | Status |
|--------|--------|--------|
| Add `sanitize_for_embedding()` function | 2 hours | Pending |
| Audit tenant_id enforcement on all queries | 2 hours | Pending |
| Draft data handling ToS section | 1 day | Pending |

### Future (Enterprise)

| Option | When | Benefit |
|--------|------|---------|
| Self-hosted embeddings | >1000 users | Full privacy |
| Encryption at rest | Enterprise tier | Compliance |
| Tenant-specific encryption keys | Enterprise | Isolation |

---

## Summary

| Question | Answer |
|----------|--------|
| Who owns output? | User owns. AOS has processing license. |
| Can embeddings be reversed? | Hard but not impossible. Defense-in-depth. |
| Biggest risk? | Secrets in error messages getting embedded. |
| Mitigation? | Sanitize before embedding + tenant isolation. |
| Provider risk? | Low with OpenAI API ToS. |

---

## References

- PIN-050: M10 Recovery Suggestion Engine
- PIN-051: Vision & Mission Assessment
- OpenAI API Data Usage Policy
- Anthropic API Terms of Service
