# PIN-004: Phase 4 & Phase 5 Completion

**Serial:** PIN-004
**Category:** Architecture / Milestone
**Status:** Active
**Created:** 2025-11-30
**Updated:** 2025-11-30

---

## Summary

Phase 4 (Multi-Step Execution & New Skills) and Phase 5 (Security Hardening) have been implemented. The platform now supports:

- Multi-step plan execution with step-level retries
- Plan safety validation before execution
- Budget deduction with accurate LLM cost tracking
- New skills: `json_transform`, `postgres_query`
- Budget Protection Layer (per-run, per-day, per-model limits)
- Prompt-Injection Safe Input Gate

---

## Phase 4 Deliverables

### F - Budget Deduction in Runner

**File:** `backend/app/worker/runner.py`

Implemented accurate Anthropic pricing and automatic budget deduction:

```python
# Anthropic pricing (cents per 1M tokens)
ANTHROPIC_PRICING = {
    "claude-sonnet-4-20250514": {"input": 300, "output": 1500},
    "claude-3-5-sonnet-20241022": {"input": 300, "output": 1500},
    "claude-3-opus-20240229": {"input": 1500, "output": 7500},
    "claude-3-haiku-20240307": {"input": 25, "output": 125},
}

def calculate_llm_cost_cents(model, input_tokens, output_tokens) -> int:
    # Returns cost in cents (minimum 1 cent)
```

**Flow:**
1. Plan generated by Claude planner
2. Token usage extracted from metadata
3. Cost calculated using accurate pricing
4. Cost recorded to `llm_costs` table
5. Cost deducted from agent's budget

### E - Plan Safety Inspector

**File:** `backend/app/utils/plan_inspector.py`

Validates plans before execution:

| Check | Description |
|-------|-------------|
| Step count | Max 25 steps per plan |
| Forbidden URLs | Blocks localhost, cloud metadata, private IPs |
| Unknown skills | Only whitelisted skills allowed |
| Budget check | Estimated cost vs agent budget |
| Circular dependencies | Detects dependency cycles |
| Loop limits | Max 10 iterations per loop |

**Whitelisted Skills:**
- `http_call`
- `calendar_write`
- `llm_invoke`
- `json_transform`
- `postgres_query`

### C - json_transform Skill

**File:** `backend/app/skills/json_transform.py`

Safe, deterministic JSON transformation using dot-path mapping:

```python
# Example usage
payload = {"data": {"user": {"name": "Alice", "age": 30}}}
mapping = {"user_name": "data.user.name", "user_age": "data.user.age"}

result, errors = transform_json(payload, mapping)
# result = {"user_name": "Alice", "user_age": 30}
```

**Features:**
- Dot notation: `data.user.name`
- Array indexing: `items[0]`, `items[-1]`
- Combined paths: `data.items[0].name`
- Default values for missing paths
- Error reporting for missing paths

### D - postgres_query Skill

**File:** `backend/app/skills/postgres_query.py`

Safe, parameterized PostgreSQL queries:

```python
# Example usage
params = {
    "query": "SELECT * FROM users WHERE id = %(user_id)s",
    "params": {"user_id": 123},
    "readonly": True,
    "max_rows": 100
}
```

**Safety Features:**
- Read-only by default (only SELECT/WITH/EXPLAIN)
- Parameterized queries (prevents SQL injection)
- Forbidden pattern blocking (DROP, TRUNCATE, ALTER, CREATE)
- Row limit enforcement (max 1000)
- Query timeout (30 seconds)

### B - Multi-Step E2E Tests

**File:** `backend/tests/test_phase4_e2e.py`

Comprehensive test suite with 20 tests:

| Test Class | Tests | Description |
|------------|-------|-------------|
| TestPlanInspector | 6 | Plan safety validation |
| TestJsonTransformSkill | 5 | JSON path extraction |
| TestPostgresQuerySkill | 4 | SQL safety checking |
| TestBudgetDeduction | 2 | Cost calculation |
| TestMultiStepExecution | 2 | Real HTTP execution |
| TestSkillRegistry | 1 | Skill registration |

---

## Phase 5 Deliverables

### A - Budget Protection Layer (BPL)

**File:** `backend/app/utils/budget_tracker.py`

Multi-layer budget enforcement:

| Layer | Limit | Default | Description |
|-------|-------|---------|-------------|
| Per-run | `PER_RUN_MAX_CENTS` | 500 ($5) | Max cost for single run |
| Per-day | `PER_DAY_MAX_CENTS` | 10000 ($100) | Rolling 24h limit |
| Per-model | `PER_MODEL_LIMITS` | Varies | Model-specific limits |
| Total | Agent budget | Configurable | Lifetime budget |

**Per-Model Limits:**
```python
PER_MODEL_LIMITS = {
    "claude-3-opus-20240229": 1000,  # $10 per run
    "gpt-4-turbo": 500,              # $5 per run
}
```

**Auto-Pause:**
When daily limit exceeded, agent is automatically paused (if `AUTO_PAUSE_ON_BREACH=true`).

**New API:**
```python
from app.utils.budget_tracker import enforce_budget, BudgetCheckResult

result: BudgetCheckResult = enforce_budget(
    agent_id="xxx",
    estimated_cost_cents=100,
    model="claude-sonnet-4-20250514"
)

if not result.allowed:
    print(f"Blocked: {result.reason}")
    print(f"Breach type: {result.breach_type}")
    print(f"Limit: {result.limit_cents}c, Current: {result.current_cents}c")
```

### B - Prompt-Injection Safe Input Gate

**File:** `backend/app/utils/input_sanitizer.py`

Detects and blocks prompt injection attempts:

| Pattern Category | Examples | Action |
|------------------|----------|--------|
| Instruction override | "ignore previous instructions" | Warn |
| Role hijacking | "you are now a...", "pretend to be" | Warn |
| Dangerous SQL | "drop table", "truncate" | Block |
| Code execution | "exec()", "subprocess.call" | Block |
| Credential extraction | "show me the API key" | Block |
| Bypass attempts | "skip validation" | Warn |
| Recursive plans | "create plan that creates plans" | Warn |

**URL Sanitization:**

Blocked hosts:
- `localhost`, `127.0.0.1`, `0.0.0.0`
- `169.254.169.254` (AWS metadata)
- `metadata.google.internal` (GCP metadata)
- Private IP ranges (`10.x.x.x`, `192.168.x.x`, `172.16-31.x.x`)

**API:**
```python
from app.utils.input_sanitizer import sanitize_goal

result = sanitize_goal("Fetch data from https://api.example.com")

if not result.is_safe:
    print(f"Blocked: {result.blocked_reason}")
else:
    use_goal = result.sanitized  # Cleaned goal
    if result.warnings:
        log_warnings(result.warnings)
```

### Integration in Goal Endpoint

**File:** `backend/app/main.py`

Updated `/agents/{agent_id}/goals` with 5-step validation:

1. **Idempotency check** - Return existing run if duplicate key
2. **Input sanitization** - Block dangerous patterns, sanitize URLs
3. **Rate limiting** - 100 req/min per tenant
4. **Concurrent runs** - Max 5 per agent
5. **Budget enforcement** - Per-run, per-day, per-model, total budget

---

## Test Results

### Phase 4 Tests
```
tests/test_phase4_e2e.py: 19 passed, 1 skipped
```

### Phase 5 Tests
```
tests/test_phase5_security.py: 20 passed, 1 skipped
```

### Full Suite
```
Total: 65 tests
Passed: 63 (97%)
Skipped: 2
Errors: 1 (pre-existing timeout)
```

---

## Configuration Reference

### Environment Variables

```bash
# Budget Protection Layer
PER_RUN_MAX_CENTS=500              # $5 per run
PER_DAY_MAX_CENTS=10000            # $100 per day
AUTO_PAUSE_ON_BREACH=true          # Auto-pause on breach
BUDGET_ALERT_THRESHOLD=0.8         # Alert at 80% usage

# Per-model limits
OPUS_MAX_CENTS_PER_RUN=1000        # $10 for Opus
GPT4_MAX_CENTS_PER_RUN=500         # $5 for GPT-4

# Input Sanitization
MAX_GOAL_LENGTH=10000              # Max goal characters
ENABLE_INJECTION_DETECTION=true   # Enable pattern detection
ENABLE_URL_SANITIZATION=true      # Enable URL checking

# Plan Inspector
MAX_PLAN_STEPS=25                  # Max steps per plan
MAX_LOOP_ITERATIONS=10             # Max loop iterations
MAX_ESTIMATED_COST_CENTS=10000     # $100 max estimated cost

# Postgres Query Skill
PG_QUERY_MAX_ROWS=1000             # Max rows returned
PG_QUERY_TIMEOUT=30                # Query timeout seconds
PG_ALLOW_WRITE=false               # Allow write queries
```

---

## Files Changed

### New Files
| File | Description |
|------|-------------|
| `app/utils/plan_inspector.py` | Plan safety validation |
| `app/utils/input_sanitizer.py` | Prompt injection protection |
| `app/skills/json_transform.py` | JSON transformation skill |
| `app/skills/postgres_query.py` | PostgreSQL query skill |
| `tests/test_phase4_e2e.py` | Phase 4 test suite |
| `tests/test_phase5_security.py` | Phase 5 test suite |

### Modified Files
| File | Changes |
|------|---------|
| `app/worker/runner.py` | Added budget deduction, plan validation |
| `app/utils/budget_tracker.py` | Added BPL enforcement |
| `app/skills/__init__.py` | Registered new skills |
| `app/main.py` | Added input sanitization, budget enforcement |

---

## Remaining Work

### Phase 5 Incomplete
| Item | Priority | Status |
|------|----------|--------|
| Fault-tolerant runner checkpointing | Medium | Not started |
| Run timeline observability | Low | Not started |
| Agent templates v1 | Low | Not started |

### Technical Debt
| Item | Priority |
|------|----------|
| Add `is_paused` column to agents table | Medium |
| Create `llm_costs` table migration | Medium |
| Migrate Pydantic validators to V2 | Low |
| Fix flaky integration test timeouts | Low |

---

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                        Goal Submission                          │
│  POST /agents/{id}/goals                                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: Idempotency Check                                      │
│  ├── Check Redis for existing idempotency_key                   │
│  └── Return existing run_id if found                            │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: Input Sanitization (NEW - Phase 5)                     │
│  ├── Detect injection patterns                                  │
│  ├── Block severe patterns (SQL, code exec, credentials)        │
│  ├── Sanitize unsafe URLs                                       │
│  └── Normalize whitespace                                       │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 3: Rate Limiting                                          │
│  └── Redis token bucket (100 req/min per tenant)                │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 4: Concurrent Runs                                        │
│  └── Redis semaphore (5 concurrent per agent)                   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 5: Budget Enforcement (NEW - Phase 5)                     │
│  ├── Check per-run limit ($5 default)                           │
│  ├── Check per-model limit (Opus: $10)                          │
│  ├── Check per-day limit ($100 default)                         │
│  └── Check total agent budget                                   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  Create Run → Queue to Worker                                   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  Worker: Plan Generation                                        │
│  ├── Retrieve memory context                                    │
│  ├── Call Claude planner                                        │
│  └── Validate plan safety (NEW - Phase 4)                       │
│      ├── Check step count                                       │
│      ├── Check forbidden URLs                                   │
│      ├── Check unknown skills                                   │
│      └── Check estimated cost vs budget                         │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  Worker: Execute Steps                                          │
│  ├── For each step:                                             │
│  │   ├── Execute skill (http_call, llm_invoke, json_transform)  │
│  │   ├── Retry on transient failures                            │
│  │   ├── Handle on_error policy (abort/continue)                │
│  │   └── Store result in context                                │
│  ├── Track LLM token usage                                      │
│  └── Calculate and record costs (NEW - Phase 4)                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  Worker: Finalize                                               │
│  ├── Deduct budget from agent (NEW - Phase 4)                   │
│  ├── Store provenance record                                    │
│  ├── Store memory for future runs                               │
│  └── Publish completion event                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## Changelog

| Date | Change |
|------|--------|
| 2025-11-30 | Initial creation - Phase 4 & 5 completion |

---

## Related PINs

- [PIN-001](PIN-001-aos-roadmap-status.md) - Original roadmap
- [PIN-002](PIN-002-critical-review.md) - Critical review
- [PIN-003](PIN-003-phase3-completion.md) - Phase 3 completion
