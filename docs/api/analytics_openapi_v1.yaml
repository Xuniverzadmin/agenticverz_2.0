# Analytics Facade API - OpenAPI 3.1 Specification
# Version: 1.0.0
# Status: LOCKED
# Reference: Analytics Domain Declaration v1
#
# GOVERNANCE NOTE:
# - Facade-only: no internal signal leakage
# - Console-safe: _status enables runtime capability checks
# - Export parity: CSV/JSON reuse the same contract
# - Governable: no write paths, no mutation ambiguity
# - Extensible: statistics.cost can slot in without breaking clients

openapi: 3.1.0
info:
  title: Analytics Facade API
  description: >
    Unified facade API for Analytics domain.
    Provides normalized, read-only access to usage statistics and exports.
    All data is aggregated from internal signals via adapters.
  version: "1.0.0"
  contact:
    name: Platform Architecture
servers:
  - url: /api/v1
    description: Primary API base

tags:
  - name: Analytics
    description: Analytics domain root
  - name: Statistics
    description: Statistical analytics (usage, cost, anomalies)

paths:

  /analytics/_status:
    get:
      tags: [Analytics]
      summary: Analytics domain capability probe
      description: Returns enabled subdomains, topics, and signal bindings.
      responses:
        "200":
          description: Domain status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnalyticsStatus"

  /analytics/statistics/usage:
    get:
      tags: [Statistics]
      summary: Get usage statistics
      description: >
        Returns aggregated usage metrics for the requested time window.
        This endpoint performs no computation beyond aggregation and normalization.
      parameters:
        - $ref: "#/components/parameters/From"
        - $ref: "#/components/parameters/To"
        - $ref: "#/components/parameters/Resolution"
        - $ref: "#/components/parameters/Scope"
      responses:
        "200":
          description: Usage statistics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UsageResponse"
        "400":
          description: Invalid request parameters
        "401":
          description: Unauthorized
        "429":
          description: Rate limited

  /analytics/statistics/usage/export.csv:
    get:
      tags: [Statistics]
      summary: Export usage statistics (CSV)
      description: >
        Exports usage statistics as CSV.
        Uses the same aggregation logic as the read API.
      parameters:
        - $ref: "#/components/parameters/From"
        - $ref: "#/components/parameters/To"
        - $ref: "#/components/parameters/Resolution"
        - $ref: "#/components/parameters/Scope"
      responses:
        "200":
          description: CSV export
          content:
            text/csv:
              schema:
                type: string
        "400":
          description: Invalid request parameters
        "401":
          description: Unauthorized

  /analytics/statistics/usage/export.json:
    get:
      tags: [Statistics]
      summary: Export usage statistics (JSON)
      description: >
        Exports usage statistics as JSON.
        Structure matches the standard usage response.
      parameters:
        - $ref: "#/components/parameters/From"
        - $ref: "#/components/parameters/To"
        - $ref: "#/components/parameters/Resolution"
        - $ref: "#/components/parameters/Scope"
      responses:
        "200":
          description: JSON export
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UsageResponse"
        "400":
          description: Invalid request parameters
        "401":
          description: Unauthorized

  /analytics/statistics/cost:
    get:
      tags: [Statistics]
      summary: Get cost statistics
      description: >
        Returns aggregated cost metrics for the requested time window.
        Includes time series, breakdown by model, and breakdown by feature.
      parameters:
        - $ref: "#/components/parameters/From"
        - $ref: "#/components/parameters/To"
        - $ref: "#/components/parameters/Resolution"
        - $ref: "#/components/parameters/Scope"
      responses:
        "200":
          description: Cost statistics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CostResponse"
        "400":
          description: Invalid request parameters
        "401":
          description: Unauthorized
        "429":
          description: Rate limited

  /analytics/statistics/cost/export.csv:
    get:
      tags: [Statistics]
      summary: Export cost statistics (CSV)
      description: >
        Exports cost statistics as CSV.
        Uses the same aggregation logic as the read API.
        Header: timestamp,spend_cents,requests,input_tokens,output_tokens
      parameters:
        - $ref: "#/components/parameters/From"
        - $ref: "#/components/parameters/To"
        - $ref: "#/components/parameters/Resolution"
        - $ref: "#/components/parameters/Scope"
      responses:
        "200":
          description: CSV export
          content:
            text/csv:
              schema:
                type: string
        "400":
          description: Invalid request parameters
        "401":
          description: Unauthorized

  /analytics/statistics/cost/export.json:
    get:
      tags: [Statistics]
      summary: Export cost statistics (JSON)
      description: >
        Exports cost statistics as JSON.
        Structure matches the standard cost response.
      parameters:
        - $ref: "#/components/parameters/From"
        - $ref: "#/components/parameters/To"
        - $ref: "#/components/parameters/Resolution"
        - $ref: "#/components/parameters/Scope"
      responses:
        "200":
          description: JSON export
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CostResponse"
        "400":
          description: Invalid request parameters
        "401":
          description: Unauthorized

components:

  parameters:
    From:
      name: from
      in: query
      required: true
      description: Start of time window (ISO-8601, UTC)
      schema:
        type: string
        format: date-time

    To:
      name: to
      in: query
      required: true
      description: End of time window (ISO-8601, UTC)
      schema:
        type: string
        format: date-time

    Resolution:
      name: resolution
      in: query
      required: false
      description: Aggregation resolution
      schema:
        type: string
        enum: [hour, day]
        default: day

    Scope:
      name: scope
      in: query
      required: false
      description: Aggregation scope
      schema:
        type: string
        enum: [org, project, env]
        default: org

  schemas:

    AnalyticsStatus:
      type: object
      required: [domain, subdomains, topics]
      properties:
        domain:
          type: string
          example: analytics
        subdomains:
          type: array
          items:
            type: string
          example: [statistics]
        topics:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/TopicStatus"

    TopicStatus:
      type: object
      required: [read, write, signals_bound]
      properties:
        read:
          type: boolean
        write:
          type: boolean
        signals_bound:
          type: integer
          minimum: 0

    UsageResponse:
      type: object
      required: [window, totals, series, signals]
      properties:
        window:
          $ref: "#/components/schemas/TimeWindow"
        totals:
          $ref: "#/components/schemas/UsageTotals"
        series:
          type: array
          items:
            $ref: "#/components/schemas/UsageSeriesPoint"
        signals:
          $ref: "#/components/schemas/SignalMetadata"

    TimeWindow:
      type: object
      required: [from, to, resolution]
      properties:
        from:
          type: string
          format: date-time
        to:
          type: string
          format: date-time
        resolution:
          type: string
          enum: [hour, day]

    UsageTotals:
      type: object
      required: [requests, compute_units, tokens]
      properties:
        requests:
          type: integer
          minimum: 0
        compute_units:
          type: integer
          minimum: 0
        tokens:
          type: integer
          minimum: 0

    UsageSeriesPoint:
      type: object
      required: [ts, requests, compute_units, tokens]
      properties:
        ts:
          type: string
          description: Timestamp bucket (UTC)
        requests:
          type: integer
          minimum: 0
        compute_units:
          type: integer
          minimum: 0
        tokens:
          type: integer
          minimum: 0

    SignalMetadata:
      type: object
      required: [sources, freshness_sec]
      properties:
        sources:
          type: array
          items:
            type: string
          example:
            - gateway.metrics
            - llm.usage
            - worker.execution
        freshness_sec:
          type: integer
          minimum: 0

    CostResponse:
      type: object
      required: [window, totals, series, by_model, by_feature, signals]
      properties:
        window:
          $ref: "#/components/schemas/TimeWindow"
        totals:
          $ref: "#/components/schemas/CostTotals"
        series:
          type: array
          items:
            $ref: "#/components/schemas/CostSeriesPoint"
        by_model:
          type: array
          items:
            $ref: "#/components/schemas/CostByModel"
        by_feature:
          type: array
          items:
            $ref: "#/components/schemas/CostByFeature"
        signals:
          $ref: "#/components/schemas/SignalMetadata"

    CostTotals:
      type: object
      required: [spend_cents, spend_usd, requests, input_tokens, output_tokens]
      properties:
        spend_cents:
          type: number
          minimum: 0
          description: Total spend in cents
        spend_usd:
          type: number
          minimum: 0
          description: Total spend in USD
        requests:
          type: integer
          minimum: 0
        input_tokens:
          type: integer
          minimum: 0
        output_tokens:
          type: integer
          minimum: 0

    CostSeriesPoint:
      type: object
      required: [ts, spend_cents, requests, input_tokens, output_tokens]
      properties:
        ts:
          type: string
          description: Timestamp bucket (UTC)
        spend_cents:
          type: number
          minimum: 0
        requests:
          type: integer
          minimum: 0
        input_tokens:
          type: integer
          minimum: 0
        output_tokens:
          type: integer
          minimum: 0

    CostByModel:
      type: object
      required: [model, spend_cents, requests, input_tokens, output_tokens, pct_of_total]
      properties:
        model:
          type: string
          description: Model name
        spend_cents:
          type: number
          minimum: 0
        requests:
          type: integer
          minimum: 0
        input_tokens:
          type: integer
          minimum: 0
        output_tokens:
          type: integer
          minimum: 0
        pct_of_total:
          type: number
          minimum: 0
          maximum: 100
          description: Percentage of total spend

    CostByFeature:
      type: object
      required: [feature_tag, spend_cents, requests, pct_of_total]
      properties:
        feature_tag:
          type: string
          description: Feature tag
        spend_cents:
          type: number
          minimum: 0
        requests:
          type: integer
          minimum: 0
        pct_of_total:
          type: number
          minimum: 0
          maximum: 100
          description: Percentage of total spend
