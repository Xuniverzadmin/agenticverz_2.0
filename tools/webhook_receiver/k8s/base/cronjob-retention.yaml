---
# CronJob for webhook retention cleanup
# Runs daily at 3:00 AM UTC to delete expired webhooks
apiVersion: batch/v1
kind: CronJob
metadata:
  name: webhook-retention
  namespace: aos-staging
  labels:
    app.kubernetes.io/name: webhook-receiver
    app.kubernetes.io/part-of: aos
    app.kubernetes.io/component: retention
spec:
  schedule: "0 3 * * *"  # Daily at 03:00 UTC
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 600
      template:
        metadata:
          labels:
            app.kubernetes.io/name: webhook-receiver
            app.kubernetes.io/component: retention
        spec:
          restartPolicy: OnFailure
          serviceAccountName: webhook-receiver
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
          containers:
            - name: cleanup
              image: curlimages/curl:8.5.0
              command:
                - /bin/sh
                - -c
                - |
                  echo "Starting webhook retention cleanup..."
                  RESPONSE=$(curl -sf -X DELETE \
                    -H "X-Webhook-Token: $WEBHOOK_TOKEN" \
                    "http://webhook-receiver.aos-staging.svc.cluster.local/webhooks/expired")
                  echo "Cleanup response: $RESPONSE"
                  DELETED=$(echo "$RESPONSE" | grep -o '"deleted":[0-9]*' | cut -d: -f2)
                  echo "Deleted $DELETED expired webhooks"
              env:
                - name: WEBHOOK_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: webhook-receiver-secret
                      key: WEBHOOK_TOKEN
              resources:
                requests:
                  cpu: 10m
                  memory: 16Mi
                limits:
                  cpu: 100m
                  memory: 64Mi
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                    - ALL
