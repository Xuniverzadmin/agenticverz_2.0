# Kustomize overlay for staging deployment
# Usage:
#   kubectl apply -k tools/webhook_receiver/k8s/overlay-staging/
#
# With custom image:
#   kustomize edit set image webhook-receiver=<registry>/webhook-receiver:<sha>
#   kubectl apply -k .
#
# Or use image-replace.yaml (generated by deploy-staging.sh)
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: aos-staging

resources:
- ../base

# Common labels for staging
commonLabels:
  app.kubernetes.io/instance: staging
  environment: staging

# Image configuration
# This will be patched by deploy-staging.sh or CI
images:
- name: ghcr.io/your-org/aos-webhook-receiver
  newName: ghcr.io/aos/webhook-receiver
  newTag: abc123def456
- name: webhook-receiver
  newName: ghcr.io/aos/webhook-receiver
  newTag: latest

# Patches for staging-specific config
  # Reduce replicas for staging

  # Add staging-specific environment variables
patches:
- patch: |
    - op: replace
      path: /spec/replicas
      value: 1
  target:
    kind: Deployment
    name: webhook-receiver
- patch: |
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: REDIS_URL
        valueFrom:
          secretKeyRef:
            name: webhook-secret
            key: REDIS_URL
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: ENVIRONMENT
        value: staging
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: LOG_LEVEL
        value: DEBUG
  target:
    kind: Deployment
    name: webhook-receiver

# ConfigMap generator for staging config
configMapGenerator:
- literals:
  - RATE_LIMIT_RPM=100
  - RETENTION_DAYS=7
  - MAX_BODY_SIZE=1048576
  name: webhook-receiver-staging-config
