<VirtualHost *:443>
    ServerName stagetest.agenticverz.com

    SSLEngine on
    SSLCertificateFile /etc/ssl/cf-origin/agenticverz_origin.crt
    SSLCertificateKeyFile /etc/ssl/cf-origin/agenticverz_origin.key

    # Stagetest Evidence Console (React SPA)
    DocumentRoot /root/agenticverz2.0/website/app-shell/dist
    <Directory /root/agenticverz2.0/website/app-shell/dist>
        AllowOverride All
        Require all granted
        Options FollowSymLinks
    </Directory>

    ProxyPreserveHost On

    # OpenAPI/docs must bypass SPA fallback and proxy to backend JSON/docs handlers.
    ProxyPass        /openapi.json http://127.0.0.1:8000/openapi.json
    ProxyPassReverse /openapi.json http://127.0.0.1:8000/openapi.json
    ProxyPass        /hoc/api/openapi.json http://127.0.0.1:8000/openapi.json
    ProxyPassReverse /hoc/api/openapi.json http://127.0.0.1:8000/openapi.json
    ProxyPass        /docs http://127.0.0.1:8000/docs
    ProxyPassReverse /docs http://127.0.0.1:8000/docs
    ProxyPass        /redoc http://127.0.0.1:8000/redoc
    ProxyPassReverse /redoc http://127.0.0.1:8000/redoc

    # Public evidence alias for API ledger.
    ProxyPass        /apis/ledger http://127.0.0.1:8000/hoc/api/stagetest/apis/ledger
    ProxyPassReverse /apis/ledger http://127.0.0.1:8000/hoc/api/stagetest/apis/ledger

    # Stagetest canonical API prefixes.
    ProxyPass        /hoc/api/stagetest http://127.0.0.1:8000/hoc/api/stagetest
    ProxyPassReverse /hoc/api/stagetest http://127.0.0.1:8000/hoc/api/stagetest
    ProxyPass        /hoc/api/cus http://127.0.0.1:8000/cus
    ProxyPassReverse /hoc/api/cus http://127.0.0.1:8000/cus

    # General API proxy (auth endpoints, health, etc.)
    ProxyPass        /api http://127.0.0.1:8000/api
    ProxyPassReverse /api http://127.0.0.1:8000/api

    # Health check
    ProxyPass        /healthz http://127.0.0.1:8000/health
    ProxyPassReverse /healthz http://127.0.0.1:8000/health

    RequestHeader set Authorization "%{HTTP:Authorization}e" env=HTTP_AUTHORIZATION

    # SPA fallback â€” serve index.html for all non-file routes.
    <Directory /root/agenticverz2.0/website/app-shell/dist>
        RewriteEngine On
        RewriteBase /
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # Security Headers
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options nosniff
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # Cache static assets
    <LocationMatch "^/assets/">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </LocationMatch>

    # No cache for HTML
    <LocationMatch "\.html$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </LocationMatch>

    # No cache for SPA routes
    <LocationMatch "^/(prefops|fops|login)">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </LocationMatch>

    ErrorLog /var/log/apache2/stagetest-agenticverz-error.log
    CustomLog /var/log/apache2/stagetest-agenticverz-access.log combined
</VirtualHost>

<VirtualHost *:80>
    ServerName stagetest.agenticverz.com

    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>
