<VirtualHost *:443>
    ServerName agenticverz.com
    ServerAlias www.agenticverz.com

    SSLEngine on
    SSLCertificateFile /etc/ssl/cf-origin/agenticverz_origin.crt
    SSLCertificateKeyFile /etc/ssl/cf-origin/agenticverz_origin.key

    # Marketing site (root)
    DocumentRoot /opt/agenticverz/apps/site/dist
    <Directory /opt/agenticverz/apps/site/dist>
        AllowOverride All
        Require all granted
    </Directory>

    # AOS Console (React SPA)
    Alias /console /opt/agenticverz/apps/console/dist
    <Directory /opt/agenticverz/apps/console/dist>
        Require all granted
        Options FollowSymLinks
    </Directory>

    # Proxy to FastAPI backend (port 8000)
    ProxyPreserveHost On
    ProxyPass        /api/v1 http://127.0.0.1:8000/api/v1
    ProxyPassReverse /api/v1 http://127.0.0.1:8000/api/v1

    # Health endpoints
    ProxyPass        /health http://127.0.0.1:8000/health
    ProxyPassReverse /health http://127.0.0.1:8000/health
    ProxyPass        /healthz http://127.0.0.1:8000/healthz
    ProxyPassReverse /healthz http://127.0.0.1:8000/healthz

    # SSE streaming (disable buffering)
    <Location /api/v1/events>
        ProxyPass http://127.0.0.1:8000/api/v1/events
        ProxyPassReverse http://127.0.0.1:8000/api/v1/events
        SetEnv proxy-sendchunked 1
        SetEnv proxy-initial-not-pooled 1
    </Location>

    # Forward Authorization header
    RequestHeader set Authorization "%{HTTP:Authorization}e" env=HTTP_AUTHORIZATION

    # SPA routing for /console/*
    <Location /console>
        RewriteEngine On
        RewriteBase /console
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /console/index.html [L]
    </Location>

    # Security Headers
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options nosniff
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # Cache static assets
    <LocationMatch "^/console/assets/">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </LocationMatch>

    # No cache for HTML
    <LocationMatch "\.html$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
    </LocationMatch>

    # Logs
    ErrorLog /var/log/apache2/agenticverz-error.log
    CustomLog /var/log/apache2/agenticverz-access.log combined
</VirtualHost>

# HTTP -> HTTPS redirect
<VirtualHost *:80>
    ServerName agenticverz.com
    ServerAlias www.agenticverz.com

    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>
