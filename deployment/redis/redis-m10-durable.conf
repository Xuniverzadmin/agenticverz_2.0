# Redis Durable Configuration for M10 Recovery
# ==============================================
#
# CRITICAL: This configuration ensures Redis Streams durability for the
# M10 Recovery Suggestion Engine. Without these settings, messages may
# be lost on restart or memory pressure.
#
# Apply by: redis-server /path/to/redis-m10-durable.conf
# Or in Docker: -v ./redis-m10-durable.conf:/usr/local/etc/redis/redis.conf
#
# For production, use Redis Sentinel or Redis Cluster for HA.

# =============================================================================
# PERSISTENCE - MANDATORY for Streams durability
# =============================================================================

# Enable AOF (Append Only File) - REQUIRED for stream durability
appendonly yes

# Fsync policy: everysec is the recommended balance of performance/durability
# - always: Maximum durability, lowest performance (fsync every write)
# - everysec: Good durability, good performance (fsync every second) [RECOMMENDED]
# - no: Rely on OS (fastest, but may lose up to 30s of data on crash)
appendfsync everysec

# Don't rewrite AOF during heavy traffic if fsync is slow
no-appendfsync-on-rewrite no

# Auto AOF rewrite when file grows too large
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF file location
appendfilename "appendonly.aof"
appenddirname "appendonlydir"

# Also enable RDB snapshots as backup (point-in-time recovery)
save 900 1    # Save if at least 1 key changed in 900 seconds
save 300 10   # Save if at least 10 keys changed in 300 seconds
save 60 10000 # Save if at least 10000 keys changed in 60 seconds

# RDB compression
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb

# Directory for data files (ensure this is persistent storage!)
dir /data

# =============================================================================
# MEMORY MANAGEMENT - CRITICAL for Streams
# =============================================================================

# Memory limit (adjust based on your deployment)
maxmemory 2gb

# Memory eviction policy - MUST be noeviction for Streams
# If set to any eviction policy, Redis may silently drop stream messages
# under memory pressure. noeviction returns OOM errors instead.
maxmemory-policy noeviction

# Stream-specific memory settings
# Maximum number of items in a stream before entries are trimmed
# Set high enough to avoid data loss
# stream-node-max-bytes 4096
# stream-node-max-entries 100

# =============================================================================
# NETWORK & CONNECTIONS
# =============================================================================

# Bind to all interfaces (adjust for security)
# bind 127.0.0.1 -::1
bind 0.0.0.0

# Port
port 6379

# Protected mode (disable if running in Docker with external access)
protected-mode no

# Connection limits
maxclients 10000

# TCP keepalive
tcp-keepalive 300

# Timeout (0 = never timeout idle clients)
timeout 0

# =============================================================================
# LOGGING
# =============================================================================

# Log level
loglevel notice

# Log file (empty = stdout)
logfile ""

# =============================================================================
# PERFORMANCE TUNING
# =============================================================================

# Active rehashing
activerehashing yes

# Client output buffer limits for normal, replica, pubsub clients
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Lazy free settings (background deletion)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# =============================================================================
# REPLICATION (for HA setup)
# =============================================================================

# Uncomment and configure for replica setup
# replicaof <masterip> <masterport>
# masterauth <master-password>

# Replica serve stale data during sync
replica-serve-stale-data yes

# Replica read-only
replica-read-only yes

# =============================================================================
# SECURITY
# =============================================================================

# Uncomment to require password
# requirepass your_strong_password_here

# Disable dangerous commands in production
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command DEBUG ""
# rename-command CONFIG ""

# =============================================================================
# SENTINEL (for HA)
# =============================================================================
# For production HA, deploy Redis Sentinel:
#
# 1. Set up 3+ Sentinel instances
# 2. Configure:
#    sentinel monitor m10-master <master-ip> 6379 2
#    sentinel down-after-milliseconds m10-master 5000
#    sentinel failover-timeout m10-master 60000
#    sentinel parallel-syncs m10-master 1
#
# 3. Connect application via Sentinel-aware client
# =============================================================================

# =============================================================================
# VERIFICATION COMMANDS
# =============================================================================
#
# After starting Redis with this config, verify:
#
# 1. Check persistence is enabled:
#    redis-cli CONFIG GET appendonly
#    # Should return: "appendonly" "yes"
#
# 2. Check memory policy:
#    redis-cli CONFIG GET maxmemory-policy
#    # Should return: "maxmemory-policy" "noeviction"
#
# 3. Test stream persistence:
#    redis-cli XADD test:stream "*" msg "test"
#    redis-cli SHUTDOWN SAVE
#    # Start Redis again
#    redis-cli XLEN test:stream
#    # Should return: 1
#
# 4. Check AOF file exists:
#    ls -la /data/appendonlydir/
#
# =============================================================================
