---
# PgBouncer Deployment for AOS Policy API
# Provides connection pooling to handle high concurrency
# Deploy with: kubectl apply -f k8s/pgbouncer-deployment.yaml

apiVersion: v1
kind: ConfigMap
metadata:
  name: pgbouncer-config
  namespace: aos
data:
  pgbouncer.ini: |
    [databases]
    # Target PostgreSQL database
    nova_aos = host=nova-db port=5432 dbname=nova_aos

    [pgbouncer]
    # Listen on all interfaces
    listen_addr = 0.0.0.0
    listen_port = 6432

    # Authentication
    auth_type = md5
    auth_file = /etc/pgbouncer/userlist.txt

    # Pool Mode: transaction = release connection after each transaction
    # Recommended for high-concurrency API workloads
    pool_mode = transaction

    # Pool Sizing
    # default_pool_size: connections per database/user pair
    # max_client_conn: max simultaneous client connections
    # reserve_pool_size: extra connections for superuser
    default_pool_size = 20
    max_client_conn = 200
    reserve_pool_size = 5
    reserve_pool_timeout = 3

    # Connection limits
    max_db_connections = 50
    max_user_connections = 50

    # Timeouts
    server_connect_timeout = 15
    server_idle_timeout = 600
    server_lifetime = 3600
    client_idle_timeout = 0
    client_login_timeout = 60
    query_timeout = 300
    query_wait_timeout = 120

    # DNS
    dns_max_ttl = 15
    dns_zone_check_period = 0

    # Logging
    log_connections = 0
    log_disconnections = 0
    log_pooler_errors = 1
    stats_period = 60
    verbose = 0

    # Admin
    admin_users = nova
    stats_users = nova,monitor

  # userlist.txt format: "user" "md5<md5(password+user)>" or "user" "password" (scram-sha-256 preferred)
  # For md5: echo -n "passworduser" | md5sum -> prefix with "md5"
  # Example: echo -n "novapassnova" | md5sum = e5f...
  # Using plaintext for simplicity - set auth_type = plain in pgbouncer.ini for dev
  # For production, use md5 or scram-sha-256
  userlist.txt: |
    "nova" "md54bb9797c81e6920bf07f2554ac77ed6a"
    "monitor" "md5d57f1f80c74b34f7f768ba56c7c7a38d"
---
apiVersion: v1
kind: Secret
metadata:
  name: pgbouncer-secrets
  namespace: aos
type: Opaque
stringData:
  # Override these in production
  POSTGRES_PASSWORD: "novapass"
  PGBOUNCER_ADMIN_PASSWORD: "adminpass"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pgbouncer
  namespace: aos
  labels:
    app: pgbouncer
    component: database
spec:
  replicas: 2
  selector:
    matchLabels:
      app: pgbouncer
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  template:
    metadata:
      labels:
        app: pgbouncer
        component: database
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9127"
    spec:
      containers:
      - name: pgbouncer
        image: edoburu/pgbouncer:1.21.0
        ports:
        - containerPort: 6432
          name: pgbouncer
          protocol: TCP
        env:
        - name: DATABASE_URL
          value: "postgresql://nova:novapass@nova-db:5432/nova_aos"
        - name: POOL_MODE
          value: "transaction"
        - name: MAX_CLIENT_CONN
          value: "200"
        - name: DEFAULT_POOL_SIZE
          value: "20"
        volumeMounts:
        - name: pgbouncer-config
          mountPath: /etc/pgbouncer/pgbouncer.ini
          subPath: pgbouncer.ini
        - name: pgbouncer-config
          mountPath: /etc/pgbouncer/userlist.txt
          subPath: userlist.txt
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          tcpSocket:
            port: 6432
          initialDelaySeconds: 10
          periodSeconds: 30
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - "pg_isready -h localhost -p 6432"
          initialDelaySeconds: 5
          periodSeconds: 10

      # PgBouncer Exporter for Prometheus
      - name: pgbouncer-exporter
        image: prometheuscommunity/pgbouncer-exporter:v0.7.0
        ports:
        - containerPort: 9127
          name: metrics
        env:
        - name: PGBOUNCER_EXPORTER_HOST
          value: "localhost"
        - name: PGBOUNCER_EXPORTER_PORT
          value: "6432"
        - name: PGBOUNCER_EXPORTER_USER
          value: "nova"
        - name: PGBOUNCER_EXPORTER_PASS
          valueFrom:
            secretKeyRef:
              name: pgbouncer-secrets
              key: POSTGRES_PASSWORD
        resources:
          requests:
            memory: "32Mi"
            cpu: "10m"
          limits:
            memory: "64Mi"
            cpu: "50m"

      volumes:
      - name: pgbouncer-config
        configMap:
          name: pgbouncer-config
---
apiVersion: v1
kind: Service
metadata:
  name: pgbouncer
  namespace: aos
  labels:
    app: pgbouncer
spec:
  type: ClusterIP
  ports:
  - port: 6432
    targetPort: 6432
    protocol: TCP
    name: pgbouncer
  - port: 9127
    targetPort: 9127
    protocol: TCP
    name: metrics
  selector:
    app: pgbouncer
---
# ServiceMonitor for Prometheus Operator
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: pgbouncer
  namespace: aos
  labels:
    app: pgbouncer
spec:
  selector:
    matchLabels:
      app: pgbouncer
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
---
# PodDisruptionBudget for HA
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: pgbouncer-pdb
  namespace: aos
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: pgbouncer
