apiVersion: batch/v1
kind: CronJob
metadata:
  name: aos-escalation-worker
  namespace: aos
  labels:
    app: aos
    component: escalation-worker
spec:
  # Run every minute
  schedule: "* * * * *"

  # Don't allow concurrent runs
  concurrencyPolicy: Forbid

  # Keep last 3 successful and 1 failed job for debugging
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1

  # Start deadline: if job can't start within 60s, skip it
  startingDeadlineSeconds: 60

  jobTemplate:
    spec:
      # Don't retry failed jobs (escalation is idempotent, next cron will pick up)
      backoffLimit: 0

      template:
        metadata:
          labels:
            app: aos
            component: escalation-worker
        spec:
          restartPolicy: Never

          containers:
            - name: escalation-worker
              image: nova_agent_manager:latest
              imagePullPolicy: IfNotPresent

              command:
                - python
                - scripts/run_escalation.py

              env:
                - name: DATABASE_URL
                  valueFrom:
                    secretKeyRef:
                      name: aos-secrets
                      key: database-url

                - name: REDIS_URL
                  valueFrom:
                    secretKeyRef:
                      name: aos-secrets
                      key: redis-url

                - name: LOG_LEVEL
                  value: "INFO"

              resources:
                requests:
                  cpu: "50m"
                  memory: "128Mi"
                limits:
                  cpu: "200m"
                  memory: "256Mi"

              # Health check: job should complete within 30s
              # If it takes longer, something is wrong
              securityContext:
                runAsNonRoot: true
                runAsUser: 1000
                readOnlyRootFilesystem: true
                allowPrivilegeEscalation: false

          # Service account with minimal permissions
          serviceAccountName: aos-worker

          # Node selector (optional - run on worker nodes)
          # nodeSelector:
          #   node-role: worker

          # Tolerations (optional - for dedicated nodes)
          # tolerations:
          #   - key: "dedicated"
          #     operator: "Equal"
          #     value: "aos-worker"
          #     effect: "NoSchedule"

---
# ServiceAccount for escalation worker
apiVersion: v1
kind: ServiceAccount
metadata:
  name: aos-worker
  namespace: aos
  labels:
    app: aos

---
# Role with minimal permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: aos-worker-role
  namespace: aos
rules: []  # No K8s API access needed

---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: aos-worker-rolebinding
  namespace: aos
subjects:
  - kind: ServiceAccount
    name: aos-worker
    namespace: aos
roleRef:
  kind: Role
  name: aos-worker-role
  apiGroup: rbac.authorization.k8s.io
