import{W as R,u as I,U as L,r as j,j as e,ab as E,I as o,R as F}from"./index-KppIquYQ.js";import{u as C}from"./useQuery-DRhwJCEf.js";import{u as N}from"./useMutation-Ckq5ZrwF.js";import{l as u}from"./consoleLogger-DP-nEyqn.js";import{C as c}from"./Card-B-aopADT.js";import{B as b}from"./Badge-DKjttL2F.js";import{M as w}from"./Modal-REvkbvop.js";import{i as d}from"./integration-Bk4tj2MI.js";const g=[{key:"incident_detected",label:"Incident",icon:"ðŸš¨"},{key:"pattern_matched",label:"Pattern",icon:"ðŸ”"},{key:"recovery_suggested",label:"Recovery",icon:"ðŸ’¡"},{key:"policy_generated",label:"Policy",icon:"ðŸ“‹"},{key:"routing_adjusted",label:"Routing",icon:"ðŸ”€"}],P={strong:{label:"Strong",color:"text-green-400",bgColor:"bg-green-500/20"},weak:{label:"Weak",color:"text-yellow-400",bgColor:"bg-yellow-500/20"},novel:{label:"Novel",color:"text-purple-400",bgColor:"bg-purple-500/20"}},q={match_failed:"No pattern match found - this is a novel incident",match_low_confidence:"Pattern match confidence below threshold",recovery_rejected:"Suggested recovery was rejected",recovery_needs_confirmation:"Recovery requires human confirmation",policy_low_confidence:"Generated policy has low confidence",policy_shadow_mode:"Policy is in shadow mode (observing only)",policy_rejected:"Generated policy was rejected",routing_guardrail_blocked:"Routing adjustment blocked by guardrail",routing_kpi_regression:"Routing rollback due to KPI regression",human_checkpoint_pending:"Waiting for human decision",human_checkpoint_rejected:"Human rejected the action"};function X(){const{incidentId:s}=R(),a=I(),t=L(),[i,n]=j.useState(null),[m,x]=j.useState(!1);j.useEffect(()=>(u.componentMount("LoopStatusPage"),()=>u.componentUnmount("LoopStatusPage")),[]);const{data:l,isLoading:h,error:p}=C({queryKey:["integration","loop",s],queryFn:()=>d.getLoopStatus(s),enabled:!!s,refetchInterval:5e3}),{data:y}=C({queryKey:["integration","narrative",s],queryFn:()=>d.getNarrative(s),enabled:!!s&&(l==null?void 0:l.is_complete)});j.useEffect(()=>{if(!s)return;const r=d.createLoopStream(s);return r.onmessage=f=>{const S=JSON.parse(f.data);t.setQueryData(["integration","loop",s],S)},r.onerror=()=>{r.close()},()=>r.close()},[s,t]);const _=N({mutationFn:r=>d.retryStage(s,r),onSuccess:()=>{t.invalidateQueries({queryKey:["integration","loop",s]})},onError:r=>{u.error("INTEGRATION","Failed to retry stage",r)}});N({mutationFn:r=>d.revertLoop(s,r),onSuccess:()=>{t.invalidateQueries({queryKey:["integration","loop",s]})},onError:r=>{u.error("INTEGRATION","Failed to revert loop",r)}});const k=N({mutationFn:({id:r,resolution:f})=>d.resolveCheckpoint(r,f),onSuccess:()=>{t.invalidateQueries({queryKey:["integration"]}),n(null)},onError:r=>{u.error("INTEGRATION","Failed to resolve checkpoint",r)}});return h?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx(E,{size:"lg"})}):p||!l?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-red-400 text-5xl mb-4",children:"âš ï¸"}),e.jsx("h3",{className:"text-lg font-medium text-gray-100",children:"Loop Not Found"}),e.jsx("p",{className:"text-gray-400 mt-2",children:"Unable to load integration loop status"}),e.jsx(o,{className:"mt-4",onClick:()=>a(-1),children:"Go Back"})]})}):e.jsxs("div",{className:"p-6 max-w-6xl mx-auto space-y-8",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-100",children:"Integration Loop"}),e.jsxs("p",{className:"text-gray-400 mt-1",children:["Incident: ",e.jsx("span",{className:"font-mono",children:s})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[l.is_complete&&e.jsx(o,{variant:"secondary",onClick:()=>x(!0),children:"View Narrative"}),e.jsx(G,{status:l})]})]}),e.jsxs(c,{className:"p-6 bg-slate-800/50 border-slate-700",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-100 mb-6",children:"Loop Progress"}),e.jsx(T,{loopStatus:l,onRetry:_.mutate})]}),l.failure_state&&e.jsx(B,{failureState:l.failure_state,onRetry:()=>{const r=W(l);r&&_.mutate(r)}}),l.pending_checkpoints.length>0&&e.jsxs(c,{className:"p-6 bg-amber-900/20 border-amber-600",children:[e.jsxs("h2",{className:"text-lg font-semibold text-amber-400 mb-4",children:["â³ Pending Human Decisions (",l.pending_checkpoints.length,")"]}),e.jsx("div",{className:"space-y-3",children:l.pending_checkpoints.map(r=>e.jsx(M,{checkpoint:r,onClick:()=>n(r)},r.id))})]}),e.jsxs(c,{className:"p-6 bg-slate-800/50 border-slate-700",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-100 mb-4",children:"Stage Details"}),e.jsx(O,{stages:l.stages})]}),e.jsx(A,{checkpoint:i,onClose:()=>n(null),onResolve:r=>{i&&k.mutate({id:i.id,resolution:r})},isLoading:k.isPending}),e.jsx(D,{open:m,onClose:()=>x(!1),narrative:y})]})}function G({status:s}){return s.is_complete?e.jsx(b,{variant:"success",className:"text-lg px-4 py-2",children:"âœ“ Loop Complete"}):s.is_blocked?e.jsx(b,{variant:"warning",className:"text-lg px-4 py-2",children:"â¸ Blocked"}):e.jsxs(b,{variant:"default",className:"text-lg px-4 py-2",children:[e.jsx("span",{className:"animate-pulse mr-2",children:"â—"})," In Progress"]})}function T({loopStatus:s,onRetry:a}){return e.jsx("div",{className:"flex items-center justify-between",children:g.map((t,i)=>{var p;const n=s.stages[t.key],m=(n==null?void 0:n.completed)??!1,x=s.current_stage===t.key,l=(n==null?void 0:n.failure_state)!=null,h=n==null?void 0:n.confidence_band;return e.jsxs(F.Fragment,{children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:`
                  w-16 h-16 rounded-full flex items-center justify-center text-2xl
                  border-2 transition-all
                  ${m?"bg-green-600 border-green-500":l?"bg-red-600 border-red-500":x?"bg-blue-600 border-blue-400 animate-pulse":"bg-slate-700 border-slate-600"}
                `,children:m?"âœ“":l?"âœ—":t.icon}),e.jsx("span",{className:`mt-2 text-sm font-medium ${m?"text-green-400":x?"text-blue-400":"text-gray-400"}`,children:t.label}),h&&e.jsx(v,{band:h}),l&&e.jsx(o,{size:"sm",variant:"secondary",className:"mt-2",onClick:()=>a(t.key),children:"Retry"})]}),i<g.length-1&&e.jsx("div",{className:`flex-1 h-1 mx-4 rounded ${(p=s.stages[g[i+1].key])!=null&&p.completed||g.findIndex(y=>y.key===s.current_stage)>i?"bg-green-500":"bg-slate-600"}`})]},t.key)})})}function v({band:s}){const a=P[s];return e.jsx("span",{className:`mt-1 px-2 py-0.5 rounded text-xs font-medium ${a.color} ${a.bgColor}`,children:a.label})}function B({failureState:s,onRetry:a}){const t=q[s]||"Unknown failure";return e.jsxs(c,{className:"p-4 bg-red-900/20 border-red-600 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-2xl",children:"âš ï¸"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-400",children:"Loop Blocked"}),e.jsx("p",{className:"text-sm text-red-300",children:t})]})]}),e.jsx(o,{variant:"secondary",onClick:a,children:"Retry Stage"})]})}function M({checkpoint:s,onClick:a}){return e.jsx("div",{className:"p-4 bg-slate-800 rounded-lg border border-amber-600/50 cursor-pointer hover:border-amber-500 transition-all",onClick:a,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-100",children:s.description}),e.jsxs("p",{className:"text-sm text-gray-400 mt-1",children:["Stage: ",s.stage," â€¢ Target: ",s.target_id]})]}),e.jsx(o,{size:"sm",variant:"primary",children:"Resolve"})]})})}function O({stages:s}){return e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:g.map(a=>{const t=s[a.key];return t?e.jsxs(c,{className:"p-4 bg-slate-700/50 border-slate-600",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{children:a.icon}),e.jsx("span",{className:"font-medium text-gray-100",children:a.label}),t.completed&&e.jsx(b,{variant:"success",children:"Complete"})]}),t.confidence_band&&e.jsx("div",{className:"mb-2",children:e.jsx(v,{band:t.confidence_band})}),t.timestamp&&e.jsx("p",{className:"text-xs text-gray-400",children:new Date(t.timestamp).toLocaleString()}),t.details&&Object.keys(t.details).length>0&&e.jsx("div",{className:"mt-2 text-xs text-gray-400",children:e.jsx("pre",{className:"bg-slate-800 p-2 rounded overflow-auto max-h-20",children:JSON.stringify(t.details,null,2)})})]},a.key):null})})}function A({checkpoint:s,onClose:a,onResolve:t,isLoading:i}){return s?e.jsx(w,{open:!!s,onClose:a,title:"Resolve Checkpoint",size:"lg",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:s.description}),e.jsxs("p",{className:"text-sm text-gray-400 mt-2",children:["Type: ",s.checkpoint_type," â€¢ Stage: ",s.stage]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"font-medium text-gray-700 dark:text-gray-200",children:"Choose an action:"}),s.options.map(n=>e.jsxs("button",{onClick:()=>t(n.action),disabled:i,className:`
                w-full p-3 text-left rounded-lg border transition-all
                ${n.is_destructive?"border-red-300 hover:border-red-500 hover:bg-red-50 dark:hover:bg-red-900/20":"border-gray-200 hover:border-blue-500 hover:bg-blue-50 dark:border-slate-600 dark:hover:bg-blue-900/20"}
              `,children:[e.jsx("p",{className:`font-medium ${n.is_destructive?"text-red-600":"text-gray-900 dark:text-gray-100"}`,children:n.label}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:n.description})]},n.action))]}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsx(o,{variant:"secondary",onClick:a,children:"Cancel"})})]})}):null}function D({open:s,onClose:a,narrative:t}){return t?e.jsx(w,{open:s,onClose:a,title:"Loop Narrative",size:"xl",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs(c,{className:"p-4 bg-blue-900/20 border-blue-600",children:[e.jsx("h4",{className:"font-medium text-blue-400 mb-2",children:"What Happened"}),e.jsx("p",{className:"text-sm text-gray-300",children:t.what_happened})]}),e.jsxs(c,{className:"p-4 bg-green-900/20 border-green-600",children:[e.jsx("h4",{className:"font-medium text-green-400 mb-2",children:"What We Learned"}),e.jsx("p",{className:"text-sm text-gray-300",children:t.what_we_learned})]}),e.jsxs(c,{className:"p-4 bg-purple-900/20 border-purple-600",children:[e.jsx("h4",{className:"font-medium text-purple-400 mb-2",children:"What We Changed"}),e.jsx("p",{className:"text-sm text-gray-300",children:t.what_we_changed})]})]}),e.jsxs(c,{className:"p-4 bg-slate-800",children:[e.jsx("h4",{className:"font-medium text-gray-200 mb-2",children:"Confidence Summary"}),e.jsx("p",{className:"text-sm text-gray-400",children:t.confidence_summary})]}),t.human_decisions.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-200 mb-2",children:"Human Decisions"}),e.jsx("ul",{className:"space-y-1",children:t.human_decisions.map((i,n)=>e.jsxs("li",{className:"text-sm text-gray-400 flex items-center gap-2",children:[e.jsx("span",{className:"text-amber-400",children:"ðŸ‘¤"})," ",i]},n))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-200 mb-3",children:"Timeline"}),e.jsx("div",{className:"space-y-2",children:t.timeline.map((i,n)=>e.jsxs("div",{className:`p-3 rounded-lg border ${i.requires_attention?"bg-amber-900/20 border-amber-600":"bg-slate-800 border-slate-700"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-200",children:i.description}),i.confidence_band&&e.jsx(v,{band:i.confidence_band})]}),e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:[new Date(i.timestamp).toLocaleString()," â€¢ ",i.stage]})]},n))})]}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsx(o,{variant:"primary",onClick:a,children:"Close"})})]})}):null}function W(s){const a=["incident_detected","pattern_matched","recovery_suggested","policy_generated","routing_adjusted"];for(const t of a){const i=s.stages[t];if(!(i!=null&&i.completed))return t}return null}export{X as LoopStatusPage,X as default};
