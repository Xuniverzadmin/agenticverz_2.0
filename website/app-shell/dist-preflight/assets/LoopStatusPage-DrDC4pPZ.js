import{j as e,a5 as L,a6 as I,a7 as E,a8 as F,A as P,a9 as T,aa as C,ab as O,ac as $,B as m,a1 as q,K as B,u as G,T as A,r as j,$ as D,R as M}from"./index-Cumb797X.js";import{u as w}from"./useQuery-CCaJ6Z3y.js";import{u as N}from"./useMutation-C_rcEF1p.js";import{l as g}from"./consoleLogger-DP-nEyqn.js";import{C as o}from"./Card-DdUMF1UP.js";import{B as b}from"./Badge-mYiKw2wq.js";import{i as x}from"./integration-CFX4Zlqo.js";import"./client-BT2DjEOZ.js";import"./index-B9ygI19o.js";function S({open:s,onClose:r,title:t,description:a,children:n,size:c="md",footer:d}){return e.jsx(L,{open:s,onOpenChange:i=>!i&&r(),children:e.jsxs(I,{children:[e.jsx(E,{className:"fixed inset-0 bg-black/50 z-50 animate-in fade-in"}),e.jsxs(F,{className:P("fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-50","bg-white dark:bg-gray-800 rounded-lg shadow-xl","animate-in fade-in zoom-in-95 duration-200","max-h-[90vh] overflow-hidden flex flex-col",{"w-[400px]":c==="sm","w-[560px]":c==="md","w-[720px]":c==="lg","w-[960px]":c==="xl"}),children:[!a&&e.jsx(T,{asChild:!0,children:e.jsx(C,{children:t?`${t} dialog`:"Modal dialog"})}),(t||a)&&e.jsxs("div",{className:"px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-start justify-between",children:[e.jsxs("div",{children:[t&&e.jsx(O,{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:t}),a&&e.jsx(C,{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:a})]}),e.jsx($,{asChild:!0,children:e.jsx(m,{variant:"ghost",size:"sm",className:"p-1",children:e.jsx(q,{size:18})})})]}),e.jsx("div",{className:"px-6 py-4 flex-1 overflow-y-auto max-h-[calc(90vh-120px)]",children:n}),d&&e.jsx("div",{className:"px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3",children:d})]})]})})}const u=[{key:"incident_detected",label:"Incident",icon:"ðŸš¨"},{key:"pattern_matched",label:"Pattern",icon:"ðŸ”"},{key:"recovery_suggested",label:"Recovery",icon:"ðŸ’¡"},{key:"policy_generated",label:"Policy",icon:"ðŸ“‹"},{key:"routing_adjusted",label:"Routing",icon:"ðŸ”€"}],z={strong:{label:"Strong",color:"text-green-400",bgColor:"bg-green-500/20"},weak:{label:"Weak",color:"text-yellow-400",bgColor:"bg-yellow-500/20"},novel:{label:"Novel",color:"text-purple-400",bgColor:"bg-purple-500/20"}},K={match_failed:"No pattern match found - this is a novel incident",match_low_confidence:"Pattern match confidence below threshold",recovery_rejected:"Suggested recovery was rejected",recovery_needs_confirmation:"Recovery requires human confirmation",policy_low_confidence:"Generated policy has low confidence",policy_shadow_mode:"Policy is in shadow mode (observing only)",policy_rejected:"Generated policy was rejected",routing_guardrail_blocked:"Routing adjustment blocked by guardrail",routing_kpi_regression:"Routing rollback due to KPI regression",human_checkpoint_pending:"Waiting for human decision",human_checkpoint_rejected:"Human rejected the action"};function ce(){const{incidentId:s}=B(),r=G(),t=A(),[a,n]=j.useState(null),[c,d]=j.useState(!1);j.useEffect(()=>(g.componentMount("LoopStatusPage"),()=>g.componentUnmount("LoopStatusPage")),[]);const{data:i,isLoading:h,error:p}=w({queryKey:["integration","loop",s],queryFn:()=>x.getLoopStatus(s),enabled:!!s,refetchInterval:5e3}),{data:y}=w({queryKey:["integration","narrative",s],queryFn:()=>x.getNarrative(s),enabled:!!s&&(i==null?void 0:i.is_complete)});j.useEffect(()=>{if(!s)return;const l=x.createLoopStream(s);return l.onmessage=f=>{const R=JSON.parse(f.data);t.setQueryData(["integration","loop",s],R)},l.onerror=()=>{l.close()},()=>l.close()},[s,t]);const _=N({mutationFn:l=>x.retryStage(s,l),onSuccess:()=>{t.invalidateQueries({queryKey:["integration","loop",s]})},onError:l=>{g.error("INTEGRATION","Failed to retry stage",l)}});N({mutationFn:l=>x.revertLoop(s,l),onSuccess:()=>{t.invalidateQueries({queryKey:["integration","loop",s]})},onError:l=>{g.error("INTEGRATION","Failed to revert loop",l)}});const k=N({mutationFn:({id:l,resolution:f})=>x.resolveCheckpoint(l,f),onSuccess:()=>{t.invalidateQueries({queryKey:["integration"]}),n(null)},onError:l=>{g.error("INTEGRATION","Failed to resolve checkpoint",l)}});return h?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx(D,{size:"lg"})}):p||!i?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-red-400 text-5xl mb-4",children:"âš ï¸"}),e.jsx("h3",{className:"text-lg font-medium text-gray-100",children:"Loop Not Found"}),e.jsx("p",{className:"text-gray-400 mt-2",children:"Unable to load integration loop status"}),e.jsx(m,{className:"mt-4",onClick:()=>r(-1),children:"Go Back"})]})}):e.jsxs("div",{className:"p-6 max-w-6xl mx-auto space-y-8",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-100",children:"Integration Loop"}),e.jsxs("p",{className:"text-gray-400 mt-1",children:["Incident: ",e.jsx("span",{className:"font-mono",children:s})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[i.is_complete&&e.jsx(m,{variant:"secondary",onClick:()=>d(!0),children:"View Narrative"}),e.jsx(W,{status:i})]})]}),e.jsxs(o,{className:"p-6 bg-slate-800/50 border-slate-700",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-100 mb-6",children:"Loop Progress"}),e.jsx(Q,{loopStatus:i,onRetry:_.mutate})]}),i.failure_state&&e.jsx(H,{failureState:i.failure_state,onRetry:()=>{const l=Y(i);l&&_.mutate(l)}}),i.pending_checkpoints.length>0&&e.jsxs(o,{className:"p-6 bg-amber-900/20 border-amber-600",children:[e.jsxs("h2",{className:"text-lg font-semibold text-amber-400 mb-4",children:["â³ Pending Human Decisions (",i.pending_checkpoints.length,")"]}),e.jsx("div",{className:"space-y-3",children:i.pending_checkpoints.map(l=>e.jsx(U,{checkpoint:l,onClick:()=>n(l)},l.id))})]}),e.jsxs(o,{className:"p-6 bg-slate-800/50 border-slate-700",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-100 mb-4",children:"Stage Details"}),e.jsx(J,{stages:i.stages})]}),e.jsx(V,{checkpoint:a,onClose:()=>n(null),onResolve:l=>{a&&k.mutate({id:a.id,resolution:l})},isLoading:k.isPending}),e.jsx(X,{open:c,onClose:()=>d(!1),narrative:y})]})}function W({status:s}){return s.is_complete?e.jsx(b,{variant:"success",className:"text-lg px-4 py-2",children:"âœ“ Loop Complete"}):s.is_blocked?e.jsx(b,{variant:"warning",className:"text-lg px-4 py-2",children:"â¸ Blocked"}):e.jsxs(b,{variant:"default",className:"text-lg px-4 py-2",children:[e.jsx("span",{className:"animate-pulse mr-2",children:"â—"})," In Progress"]})}function Q({loopStatus:s,onRetry:r}){return e.jsx("div",{className:"flex items-center justify-between",children:u.map((t,a)=>{var p;const n=s.stages[t.key],c=(n==null?void 0:n.completed)??!1,d=s.current_stage===t.key,i=(n==null?void 0:n.failure_state)!=null,h=n==null?void 0:n.confidence_band;return e.jsxs(M.Fragment,{children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:`
                  w-16 h-16 rounded-full flex items-center justify-center text-2xl
                  border-2 transition-all
                  ${c?"bg-green-600 border-green-500":i?"bg-red-600 border-red-500":d?"bg-blue-600 border-blue-400 animate-pulse":"bg-slate-700 border-slate-600"}
                `,children:c?"âœ“":i?"âœ—":t.icon}),e.jsx("span",{className:`mt-2 text-sm font-medium ${c?"text-green-400":d?"text-blue-400":"text-gray-400"}`,children:t.label}),h&&e.jsx(v,{band:h}),i&&e.jsx(m,{size:"sm",variant:"secondary",className:"mt-2",onClick:()=>r(t.key),children:"Retry"})]}),a<u.length-1&&e.jsx("div",{className:`flex-1 h-1 mx-4 rounded ${(p=s.stages[u[a+1].key])!=null&&p.completed||u.findIndex(y=>y.key===s.current_stage)>a?"bg-green-500":"bg-slate-600"}`})]},t.key)})})}function v({band:s}){const r=z[s];return e.jsx("span",{className:`mt-1 px-2 py-0.5 rounded text-xs font-medium ${r.color} ${r.bgColor}`,children:r.label})}function H({failureState:s,onRetry:r}){const t=K[s]||"Unknown failure";return e.jsxs(o,{className:"p-4 bg-red-900/20 border-red-600 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-2xl",children:"âš ï¸"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-400",children:"Loop Blocked"}),e.jsx("p",{className:"text-sm text-red-300",children:t})]})]}),e.jsx(m,{variant:"secondary",onClick:r,children:"Retry Stage"})]})}function U({checkpoint:s,onClick:r}){return e.jsx("div",{className:"p-4 bg-slate-800 rounded-lg border border-amber-600/50 cursor-pointer hover:border-amber-500 transition-all",onClick:r,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-100",children:s.description}),e.jsxs("p",{className:"text-sm text-gray-400 mt-1",children:["Stage: ",s.stage," â€¢ Target: ",s.target_id]})]}),e.jsx(m,{size:"sm",variant:"primary",children:"Resolve"})]})})}function J({stages:s}){return e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:u.map(r=>{const t=s[r.key];return t?e.jsxs(o,{className:"p-4 bg-slate-700/50 border-slate-600",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{children:r.icon}),e.jsx("span",{className:"font-medium text-gray-100",children:r.label}),t.completed&&e.jsx(b,{variant:"success",children:"Complete"})]}),t.confidence_band&&e.jsx("div",{className:"mb-2",children:e.jsx(v,{band:t.confidence_band})}),t.timestamp&&e.jsx("p",{className:"text-xs text-gray-400",children:new Date(t.timestamp).toLocaleString()}),t.details&&Object.keys(t.details).length>0&&e.jsx("div",{className:"mt-2 text-xs text-gray-400",children:e.jsx("pre",{className:"bg-slate-800 p-2 rounded overflow-auto max-h-20",children:JSON.stringify(t.details,null,2)})})]},r.key):null})})}function V({checkpoint:s,onClose:r,onResolve:t,isLoading:a}){return s?e.jsx(S,{open:!!s,onClose:r,title:"Resolve Checkpoint",size:"lg",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:s.description}),e.jsxs("p",{className:"text-sm text-gray-400 mt-2",children:["Type: ",s.checkpoint_type," â€¢ Stage: ",s.stage]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"font-medium text-gray-700 dark:text-gray-200",children:"Choose an action:"}),s.options.map(n=>e.jsxs("button",{onClick:()=>t(n.action),disabled:a,className:`
                w-full p-3 text-left rounded-lg border transition-all
                ${n.is_destructive?"border-red-300 hover:border-red-500 hover:bg-red-50 dark:hover:bg-red-900/20":"border-gray-200 hover:border-blue-500 hover:bg-blue-50 dark:border-slate-600 dark:hover:bg-blue-900/20"}
              `,children:[e.jsx("p",{className:`font-medium ${n.is_destructive?"text-red-600":"text-gray-900 dark:text-gray-100"}`,children:n.label}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:n.description})]},n.action))]}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsx(m,{variant:"secondary",onClick:r,children:"Cancel"})})]})}):null}function X({open:s,onClose:r,narrative:t}){return t?e.jsx(S,{open:s,onClose:r,title:"Loop Narrative",size:"xl",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs(o,{className:"p-4 bg-blue-900/20 border-blue-600",children:[e.jsx("h4",{className:"font-medium text-blue-400 mb-2",children:"What Happened"}),e.jsx("p",{className:"text-sm text-gray-300",children:t.what_happened})]}),e.jsxs(o,{className:"p-4 bg-green-900/20 border-green-600",children:[e.jsx("h4",{className:"font-medium text-green-400 mb-2",children:"What We Learned"}),e.jsx("p",{className:"text-sm text-gray-300",children:t.what_we_learned})]}),e.jsxs(o,{className:"p-4 bg-purple-900/20 border-purple-600",children:[e.jsx("h4",{className:"font-medium text-purple-400 mb-2",children:"What We Changed"}),e.jsx("p",{className:"text-sm text-gray-300",children:t.what_we_changed})]})]}),e.jsxs(o,{className:"p-4 bg-slate-800",children:[e.jsx("h4",{className:"font-medium text-gray-200 mb-2",children:"Confidence Summary"}),e.jsx("p",{className:"text-sm text-gray-400",children:t.confidence_summary})]}),t.human_decisions.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-200 mb-2",children:"Human Decisions"}),e.jsx("ul",{className:"space-y-1",children:t.human_decisions.map((a,n)=>e.jsxs("li",{className:"text-sm text-gray-400 flex items-center gap-2",children:[e.jsx("span",{className:"text-amber-400",children:"ðŸ‘¤"})," ",a]},n))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-200 mb-3",children:"Timeline"}),e.jsx("div",{className:"space-y-2",children:t.timeline.map((a,n)=>e.jsxs("div",{className:`p-3 rounded-lg border ${a.requires_attention?"bg-amber-900/20 border-amber-600":"bg-slate-800 border-slate-700"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-200",children:a.description}),a.confidence_band&&e.jsx(v,{band:a.confidence_band})]}),e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:[new Date(a.timestamp).toLocaleString()," â€¢ ",a.stage]})]},n))})]}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsx(m,{variant:"primary",onClick:r,children:"Close"})})]})}):null}function Y(s){const r=["incident_detected","pattern_matched","recovery_suggested","policy_generated","routing_adjusted"];for(const t of r){const a=s.stages[t];if(!(a!=null&&a.completed))return t}return null}export{ce as LoopStatusPage,ce as default};
