import{f as O,r as d,j as e,X as y,M as S,aa as q,G as U,W as H,u as K}from"./index-KppIquYQ.js";import{u as R}from"./useQuery-DRhwJCEf.js";import{A as z}from"./arrow-left-DrPQYbfI.js";import{B as A}from"./bell-CELpuU_2.js";import{D as W}from"./dollar-sign-DZIMmEsu.js";import{E as v}from"./eye-BJuEv1DK.js";import{G as F}from"./git-branch-CgHU0L2D.js";import{L as B}from"./loader-2-Bq2xiA3F.js";import{P as k}from"./play-BzuQk0kl.js";import{R as J}from"./refresh-cw-C5XbiSIu.js";import{b as _,f as X,c as M,g as Q,a as V,d as Y,e as Z,h as ee}from"./replay-BAbDgFb0.js";import{C as se}from"./chevron-right-D006Lv8J.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=O("Pause",[["rect",{width:"4",height:"16",x:"6",y:"4",key:"iffhe4"}],["rect",{width:"4",height:"16",x:"14",y:"4",key:"sjin7j"}]]);function G({category:s}){switch(s){case"input":return e.jsx(v,{className:"w-4 h-4"});case"decision":return e.jsx(F,{className:"w-4 h-4"});case"action":return e.jsx(k,{className:"w-4 h-4"});case"side_effect":return e.jsx(A,{className:"w-4 h-4"});default:return e.jsx(y,{className:"w-4 h-4"})}}function ae({item:s,isSelected:l,onClick:n,isHighlighted:a}){const[t,o]=d.useState(!1),h=_(s.category),r=g=>{g.stopPropagation(),o(!t)};return e.jsxs("div",{className:`
        border rounded-lg p-3 mb-2 cursor-pointer transition-all
        ${l?"border-blue-500 bg-blue-900/20":"border-navy-border hover:border-gray-600"}
        ${a?"ring-2 ring-blue-400 ring-opacity-50":""}
      `,onClick:n,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${h}`,children:e.jsx(G,{category:s.category})}),e.jsx("span",{className:"text-white font-medium",children:s.label})]}),e.jsxs("div",{className:"flex items-center gap-3 text-sm text-gray-400",children:[s.duration_ms&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(q,{className:"w-3 h-3"}),X(s.duration_ms)]}),s.cost_cents&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(W,{className:"w-3 h-3"}),M(s.cost_cents)]}),e.jsx("span",{className:"text-xs",children:new Date(s.timestamp).toLocaleTimeString()}),e.jsx("button",{onClick:r,className:"p-1 hover:bg-gray-700 rounded",children:t?e.jsx(U,{className:"w-4 h-4"}):e.jsx(se,{className:"w-4 h-4"})})]})]}),e.jsx("p",{className:"text-gray-400 text-sm mt-2",children:s.summary}),t&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-navy-border",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-2",children:"Details (READ-ONLY)"}),e.jsx("pre",{className:"text-xs text-gray-300 bg-gray-900/50 p-2 rounded overflow-x-auto max-h-48",children:JSON.stringify(s.data,null,2)})]})]})}function le({position:s,onSeek:l,isPlaying:n,onPlayPause:a,timelineStart:t,timelineEnd:o,items:h}){const r=d.useRef(null),g=p=>{if(!r.current)return;const x=r.current.getBoundingClientRect(),N=(p.clientX-x.left)/x.width;l(Math.max(0,Math.min(1,N)))},c=new Date(t).getTime(),j=new Date(o).getTime()-c,u=h.map(p=>{const x=new Date(p.timestamp).getTime();return{position:j>0?(x-c)/j:0,category:p.category}});return e.jsx("div",{className:"bg-gray-900/50 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:a,className:"p-2 bg-blue-600 hover:bg-blue-500 rounded-full transition-colors",children:n?e.jsx(te,{className:"w-5 h-5 text-white"}):e.jsx(k,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{ref:r,className:"relative h-8 bg-gray-800 rounded cursor-pointer",onClick:g,children:[u.map((p,x)=>e.jsx("div",{className:`absolute w-1 h-4 top-2 rounded ${_(p.category)}`,style:{left:`${p.position*100}%`}},x)),e.jsx("div",{className:"absolute top-0 left-0 h-full bg-blue-600/30 rounded-l",style:{width:`${s*100}%`}}),e.jsx("div",{className:"absolute top-0 w-1 h-full bg-blue-500",style:{left:`${s*100}%`}})]}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-500 mt-1",children:[e.jsx("span",{children:new Date(t).toLocaleTimeString()}),e.jsx("span",{children:new Date(o).toLocaleTimeString()})]})]})]})})}function ne({enabledCategories:s,onToggle:l,counts:n}){const a=["input","decision","action","side_effect"];return e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsx("span",{className:"text-gray-400 text-sm self-center",children:"Filter:"}),a.map(t=>e.jsxs("button",{onClick:()=>l(t),className:`
            px-3 py-1 rounded text-sm flex items-center gap-2 transition-colors
            ${s.has(t)?_(t):"bg-gray-800 text-gray-500 hover:bg-gray-700"}
          `,children:[e.jsx(G,{category:t}),e.jsx("span",{className:"capitalize",children:t.replace("_"," ")}),e.jsxs("span",{className:"text-xs opacity-70",children:["(",n[t]||0,")"]})]},t))]})}function re({items:s,timelineStart:l,timelineEnd:n,onItemClick:a,selectedItemId:t,isPlaying:o=!1,onPlayPause:h,currentTime:r=0,onSeek:g}){const[c,C]=d.useState(new Set(["input","decision","action","side_effect"])),[j,u]=d.useState(-1),p=d.useMemo(()=>{const i={input:0,decision:0,action:0,side_effect:0};return s.forEach(f=>{f.category in i&&i[f.category]++}),i},[s]),x=d.useMemo(()=>s.filter(i=>c.has(i.category)),[s,c]),N=d.useCallback(i=>{C(f=>{const m=new Set(f);return m.has(i)?m.delete(i):m.add(i),m})},[]);d.useEffect(()=>{if(!r||!s.length)return;const i=new Date(l).getTime(),m=new Date(n).getTime()-i,P=i+r*m;let T=-1,b=1/0;x.forEach((E,$)=>{const L=new Date(E.timestamp).getTime(),w=Math.abs(L-P);w<b&&(b=w,T=$)}),u(T)},[r,x,l,n,s.length]);const D=h||(()=>{}),I=g||(()=>{});return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"bg-blue-900/20 border border-blue-800 rounded-lg p-2 mb-4 flex items-center gap-2",children:[e.jsx(y,{className:"w-4 h-4 text-blue-400"}),e.jsx("span",{className:"text-blue-300 text-sm",children:"Timeline is read-only. No edits or annotations are possible."})]}),e.jsx(le,{position:r,onSeek:I,isPlaying:o,onPlayPause:D,timelineStart:l,timelineEnd:n,items:s}),e.jsx(ne,{enabledCategories:c,onToggle:N,counts:p}),e.jsxs("div",{className:"flex gap-4 mb-4 text-xs text-gray-500",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(v,{className:"w-3 h-3 text-blue-400"})," What agent saw"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(F,{className:"w-3 h-3 text-yellow-400"})," Why it decided"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(k,{className:"w-3 h-3 text-green-400"})," What it executed"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(A,{className:"w-3 h-3 text-purple-400"})," Side effects"]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:x.length===0?e.jsxs("div",{className:"text-center text-gray-500 py-8",children:[e.jsx(y,{className:"w-8 h-8 mx-auto mb-2"}),e.jsx("p",{children:"No items match the current filter."})]}):x.map((i,f)=>e.jsx(ae,{item:i,isSelected:i.id===t,isHighlighted:f===j,onClick:()=>a==null?void 0:a(i)},i.id))}),e.jsx("div",{className:"mt-4 pt-4 border-t border-navy-border text-sm text-gray-500",children:e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["Showing ",x.length," of ",s.length," events"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(S,{className:"w-4 h-4 text-yellow-500"}),"No edit controls available (immutable replay)"]})]})})]})}function ie({title:s,severity:l,status:n,triggerType:a,startedAt:t,endedAt:o,callsAffected:h,costDelta:r}){return e.jsxs("div",{className:"bg-gray-900/50 rounded-lg p-4 mb-4",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-white mb-2",children:s}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsx("span",{className:`px-2 py-1 rounded ${Q(l)}`,children:l.toUpperCase()}),e.jsx("span",{className:`${V(n)}`,children:n.charAt(0).toUpperCase()+n.slice(1)}),e.jsxs("span",{className:"text-gray-400",children:["Trigger: ",a.replace(/_/g," ")]})]})]}),e.jsxs("div",{className:"text-right text-sm",children:[e.jsxs("div",{className:"text-gray-400",children:["Started: ",new Date(t).toLocaleString()]}),o&&e.jsxs("div",{className:"text-gray-400",children:["Ended: ",new Date(o).toLocaleString()]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-navy-border",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(S,{className:"w-4 h-4 text-yellow-500"}),e.jsx("span",{className:"text-gray-400",children:"Calls Affected:"}),e.jsx("span",{className:"text-white font-medium",children:h})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{className:"w-4 h-4 text-green-500"}),e.jsx("span",{className:"text-gray-400",children:"Cost Impact:"}),e.jsx("span",{className:"text-white font-medium",children:M(r)})]})]})]})}function ce({incidentId:s,itemId:l,onClose:n}){const{data:a,isLoading:t,error:o}=R({queryKey:["replay-explanation",s,l],queryFn:()=>Y(s,l),enabled:!!l});return l?t?e.jsxs("div",{className:"bg-gray-900/50 rounded-lg p-4 text-center",children:[e.jsx(B,{className:"w-8 h-8 animate-spin mx-auto text-blue-500"}),e.jsx("p",{className:"text-gray-400 mt-2",children:"Loading explanation..."})]}):o||!a?e.jsxs("div",{className:"bg-red-900/20 border border-red-800 rounded-lg p-4 text-center",children:[e.jsx(S,{className:"w-8 h-8 mx-auto text-red-500"}),e.jsx("p",{className:"text-red-400 mt-2",children:"Failed to load explanation"})]}):e.jsxs("div",{className:"bg-gray-900/50 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-white font-medium",children:"Item Explanation"}),e.jsx("button",{onClick:n,className:"text-gray-400 hover:text-white text-sm",children:"Clear"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("span",{className:`px-2 py-1 rounded text-xs ${_(a.category)}`,children:a.category}),e.jsx("span",{className:"text-gray-400 text-sm",children:a.item_type==="proxy_call"?"API Call":"Incident Event"}),e.jsx("span",{className:"text-gray-500 text-xs",children:new Date(a.timestamp).toLocaleTimeString()})]}),e.jsx("div",{className:"space-y-4",children:Object.entries(a.explanation).map(([h,r])=>e.jsxs("div",{children:[e.jsx("h4",{className:"text-gray-400 text-sm mb-1 capitalize",children:h.replace(/_/g," ")}),typeof r=="string"?e.jsx("p",{className:"text-gray-300 text-sm",children:r}):e.jsx("pre",{className:"text-xs text-gray-300 bg-gray-800 p-2 rounded overflow-x-auto max-h-32",children:JSON.stringify(r,null,2)})]},h))}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-navy-border text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(y,{className:"w-3 h-3"}),"This data is immutable and cannot be modified"]})]}):e.jsxs("div",{className:"bg-gray-900/50 rounded-lg p-4 text-center text-gray-500",children:[e.jsx(v,{className:"w-8 h-8 mx-auto mb-2"}),e.jsx("p",{children:"Select an item from the timeline to see details"}),e.jsx("p",{className:"text-xs mt-2",children:"Learn what the agent saw, why it decided, and what it executed"})]})}function be(){const{incidentId:s}=H(),l=K(),[n,a]=d.useState(!1),[t,o]=d.useState(0),[h,r]=d.useState(null),g=d.useRef(null),{data:c,isLoading:C,error:j}=R({queryKey:["incident-summary",s],queryFn:()=>Z(s),enabled:!!s}),{data:u,isLoading:p,error:x,refetch:N}=R({queryKey:["replay-timeline",s],queryFn:()=>ee(s,200),enabled:!!s});d.useEffect(()=>{if(!n){g.current&&(cancelAnimationFrame(g.current),g.current=null);return}let m=performance.now(),P=t;const T=3e4,b=E=>{const L=(E-m)/T,w=P+L;if(w>=1){o(1),a(!1);return}o(w),g.current=requestAnimationFrame(b)};return g.current=requestAnimationFrame(b),()=>{g.current&&cancelAnimationFrame(g.current)}},[n,t]);const D=d.useCallback(()=>{a(m=>!m)},[]),I=d.useCallback(m=>{o(m),a(!1)},[]),i=d.useCallback(m=>{r(m.id)},[]),f=d.useCallback(()=>{r(null)},[]);return C||p?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx(B,{className:"w-8 h-8 animate-spin mx-auto text-blue-500"}),e.jsx("p",{className:"text-gray-400 mt-2",children:"Loading replay data..."})]})}):j||x||!c||!u?e.jsxs("div",{className:"bg-red-900/20 border border-red-800 rounded-lg p-8 text-center",children:[e.jsx(S,{className:"w-12 h-12 mx-auto text-red-500"}),e.jsx("h2",{className:"text-xl text-red-400 mt-4",children:"Failed to Load Replay"}),e.jsx("p",{className:"text-gray-400 mt-2",children:(j==null?void 0:j.message)||"Unknown error occurred"}),e.jsx("button",{onClick:()=>l(-1),className:"mt-4 px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded",children:"Go Back"})]}):!c.has_replay_data||u.items.length===0?e.jsxs("div",{className:"bg-yellow-900/20 border border-yellow-800 rounded-lg p-8 text-center",children:[e.jsx(y,{className:"w-12 h-12 mx-auto text-yellow-500"}),e.jsx("h2",{className:"text-xl text-yellow-400 mt-4",children:"No Replay Data Available"}),e.jsx("p",{className:"text-gray-400 mt-2",children:"This incident does not have associated replay data."}),e.jsx("button",{onClick:()=>l(-1),className:"mt-4 px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded",children:"Go Back"})]}):e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>l(-1),className:"p-2 hover:bg-gray-800 rounded",children:e.jsx(z,{className:"w-5 h-5 text-gray-400"})}),e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Incident Replay"}),e.jsxs("span",{className:"text-gray-500 text-sm",children:["ID: ",s]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{onClick:()=>N(),className:"p-2 hover:bg-gray-800 rounded text-gray-400 hover:text-white",title:"Refresh",children:e.jsx(J,{className:"w-5 h-5"})})})]}),e.jsxs("div",{className:"bg-blue-900/20 border border-blue-800 rounded-lg p-3 mb-4 flex items-center gap-3",children:[e.jsx(y,{className:"w-5 h-5 text-blue-400 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-300 font-medium",children:"Read-Only Replay"}),e.jsx("span",{className:"text-blue-400 ml-2 text-sm",children:"This view shows immutable historical data. No modifications are possible."})]})]}),e.jsx(ie,{title:c.title,severity:c.severity,status:c.status,triggerType:c.trigger_type,startedAt:c.started_at,endedAt:c.ended_at,callsAffected:c.calls_affected,costDelta:c.cost_delta_cents}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 flex-1 min-h-0",children:[e.jsxs("div",{className:"col-span-2 bg-gray-900/30 rounded-lg p-4 overflow-hidden flex flex-col",children:[e.jsxs("h3",{className:"text-white font-medium mb-4 flex items-center gap-2",children:[e.jsx(q,{className:"w-4 h-4"}),"Event Timeline",e.jsxs("span",{className:"text-gray-500 text-sm ml-2",children:["(",u.total_items," events)"]})]}),e.jsx(re,{items:u.items,timelineStart:u.timeline_start,timelineEnd:u.timeline_end,onItemClick:i,selectedItemId:h??void 0,isPlaying:n,onPlayPause:D,currentTime:t,onSeek:I})]}),e.jsxs("div",{className:"col-span-1 overflow-y-auto",children:[e.jsxs("h3",{className:"text-white font-medium mb-4 flex items-center gap-2",children:[e.jsx(v,{className:"w-4 h-4"}),"Explanation"]}),e.jsx(ce,{incidentId:s,itemId:h,onClose:f}),e.jsxs("div",{className:"mt-4 bg-gray-900/30 rounded-lg p-4",children:[e.jsx("h4",{className:"text-gray-400 text-sm mb-3",children:"Understanding the Timeline"}),e.jsxs("div",{className:"space-y-2 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 rounded bg-blue-900/30 text-blue-400",children:e.jsx(v,{className:"w-3 h-3 inline"})}),e.jsxs("span",{className:"text-gray-400",children:[e.jsx("strong",{children:"Inputs:"})," What the agent saw (requests, context)"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 rounded bg-yellow-900/30 text-yellow-400",children:e.jsx(F,{className:"w-3 h-3 inline"})}),e.jsxs("span",{className:"text-gray-400",children:[e.jsx("strong",{children:"Decisions:"})," Why it decided (guardrails, policies)"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 rounded bg-green-900/30 text-green-400",children:e.jsx(k,{className:"w-3 h-3 inline"})}),e.jsxs("span",{className:"text-gray-400",children:[e.jsx("strong",{children:"Actions:"})," What it executed (API calls)"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 rounded bg-purple-900/30 text-purple-400",children:e.jsx(A,{className:"w-3 h-3 inline"})}),e.jsxs("span",{className:"text-gray-400",children:[e.jsx("strong",{children:"Side Effects:"})," Notifications, logging"]})]})]})]})]})]})]})}export{be as default};
