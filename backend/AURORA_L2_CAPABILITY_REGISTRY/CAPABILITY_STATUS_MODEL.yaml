# AURORA_L2 Capability Status Model
# Status: LOCKED
# Version: 2.0
# Purpose: Defines capability lifecycle states (4-state model)
#
# Core Invariant:
#   Capabilities are not real because backend says so.
#   They are real only when the system demonstrates them.

version: "2.0.0"
status: LOCKED

# =============================================================================
# CAPABILITY LIFECYCLE (4-State Model)
# =============================================================================
#
# DISCOVERED  →  DECLARED  →  OBSERVED  →  TRUSTED
#
# - DISCOVERED: Action name exists in intent surface (auto-seeded)
# - DECLARED:   Backend claims it exists (YAML filled, no trust yet)
# - OBSERVED:   UI + SDSR confirm real behavior (system truth)
# - TRUSTED:    Fully governed, CI-enforced
#
# Key Rule: Backend YAML is a claim, not truth.
#           Truth emerges only when system demonstrates behavior.

statuses:
  DISCOVERED:
    description: "Auto-seeded from intent store, action name exists"
    binding_gate_result: DRAFT
    ui_behavior:
      visible: true
      enabled: false
      tooltip: "Action discovered, not yet declared by backend"
    can_transition_to: [DECLARED]
    who_can_transition: backend_team
    notes:
      - "Generated by AURORA_L2_seed_capability_registry.py"
      - "No assumptions about implementation"

  DECLARED:
    description: "Backend filled YAML, claims implementation exists"
    binding_gate_result: DRAFT
    ui_behavior:
      visible: true
      enabled: false
      tooltip: "Backend declared, awaiting system verification"
    can_transition_to: [OBSERVED]
    who_can_transition: system_only
    declaration_requirements:
      - "implementation.endpoint filled"
      - "implementation.method filled"
      - "implementation.handler filled"
      - "auth.roles or auth.permissions filled"
      - "metadata.declared_by filled"
      - "metadata.declared_on filled"
    notes:
      - "YAML is a claim, not truth"
      - "Button remains disabled"
      - "Backend cannot self-promote to OBSERVED"

  OBSERVED:
    description: "UI + SDSR confirmed real behavior"
    binding_gate_result: BOUND
    ui_behavior:
      visible: true
      enabled: true
      tooltip: null
    can_transition_to: [TRUSTED]
    who_can_transition: system_only
    observation_requirements:
      - "SDSR scenario executed successfully"
      - "UI invoked action"
      - "Expected state transition observed"
      - "metadata.observed_by filled (SDSR scenario ID)"
      - "metadata.observed_on filled"
      - "metadata.observed_effects documented"
    notes:
      - "Only system observation can reach this state"
      - "Button becomes enabled"
      - "Backend cannot write observation metadata"

  TRUSTED:
    description: "Fully governed, CI-enforced"
    binding_gate_result: BOUND
    ui_behavior:
      visible: true
      enabled: true
      tooltip: null
    can_transition_to: []
    who_can_transition: governance_approval
    trust_requirements:
      - "OBSERVED state verified"
      - "Governance review completed"
      - "CI enforcement enabled"
      - "metadata.trusted_by filled"
      - "metadata.trusted_on filled"
    notes:
      - "Final state"
      - "CI will fail if capability regresses"
      - "Requires explicit governance approval"

# =============================================================================
# BINDING GATE MAPPING
# =============================================================================
#
# Status       → Binding  → UI Enabled
# DISCOVERED   → DRAFT    → No
# DECLARED     → DRAFT    → No  (claim ≠ truth)
# OBSERVED     → BOUND    → Yes (system verified)
# TRUSTED      → BOUND    → Yes (CI enforced)
# (missing)    → UNBOUND  → Hidden

binding_gate_rules:
  DISCOVERED: DRAFT
  DECLARED: DRAFT
  OBSERVED: BOUND
  TRUSTED: BOUND
  missing_capability: UNBOUND
  unknown_status: UNBOUND

# =============================================================================
# TRANSITION PROTOCOLS
# =============================================================================

transitions:
  discovered_to_declared:
    from: DISCOVERED
    to: DECLARED
    who: backend_team
    how: "Edit capability YAML, fill implementation details"
    effect: "None - button stays disabled"

  declared_to_observed:
    from: DECLARED
    to: OBSERVED
    who: system_only
    how: "SDSR scenario + UI verification"
    effect: "Button becomes enabled"
    blockers:
      - "Backend cannot self-promote"
      - "Manual edits to observation metadata are invalid"

  observed_to_trusted:
    from: OBSERVED
    to: TRUSTED
    who: governance_approval
    how: "Explicit governance review"
    effect: "CI enforcement enabled"

# =============================================================================
# METADATA SCHEMA
# =============================================================================

metadata_schema:
  # Set by seeding script
  generated_by: string
  generated_on: date

  # Set by backend (DECLARED)
  declared_by: string
  declared_on: date

  # Set by system only (OBSERVED)
  observed_by: string      # SDSR scenario ID, e.g., "SDSR_E2E_017"
  observed_on: date
  observed_effects: list   # What state changes were verified

  # Set by governance (TRUSTED)
  trusted_by: string
  trusted_on: date

# =============================================================================
# GOVERNANCE RULES
# =============================================================================

rules:
  core_invariant: |
    Capabilities are not real because backend says so.
    They are real only when the system demonstrates them.

  discovery:
    - "Seeding script runs once, then archived"
    - "Never overwrites existing capability files"
    - "Never infers implementation"

  declaration:
    - "Backend fills YAML = claim, not truth"
    - "DECLARED does NOT enable button"
    - "Backend cannot skip to OBSERVED"

  observation:
    - "Only SDSR/system can write observation metadata"
    - "Manual observation edits are governance violations"
    - "OBSERVED enables button"

  trust:
    - "TRUSTED requires governance approval"
    - "CI enforcement only at TRUSTED level"
    - "Regression from TRUSTED fails CI"

# =============================================================================
# SDSR → AURORA_L2 OBSERVATION BRIDGE
# =============================================================================
#
# This section defines the mechanical connection between SDSR and AURORA_L2.
# SDSR acceptance = mechanical state transition in AURORA_L2
#
# Rule: Only SDSR may move a capability from DECLARED → OBSERVED.
#       And it must do so via a single, explicit write operation.

observation_bridge:
  description: |
    The mechanical connection between SDSR scenario execution and
    AURORA_L2 capability state advancement.

  core_rule: |
    Only SDSR may move a capability from DECLARED → OBSERVED.
    And it must do so via a single, explicit write operation.
    No other path is allowed.

  artifacts:
    observation_dir: sdsr/observations/
    observation_schema: sdsr/SDSR_OBSERVATION_SCHEMA.json
    observation_applier: scripts/tools/AURORA_L2_apply_sdsr_observations.py

  flow:
    - step: 1
      name: "SDSR Scenario Execution"
      description: "SDSR scenario executes against real system"
      actor: system
      output: "Scenario execution results"

    - step: 2
      name: "Observation Emission"
      description: "On success, SDSR emits SDSR_OBSERVATION_*.json"
      actor: system
      output: "sdsr/observations/SDSR_OBSERVATION_<scenario_id>.json"

    - step: 3
      name: "Observation Application"
      description: "Applier script advances capability state"
      actor: system
      command: "python3 scripts/tools/AURORA_L2_apply_sdsr_observations.py --observation <file>"
      output: "Capability YAML updated: status = OBSERVED"

    - step: 4
      name: "Pipeline Recompilation"
      description: "AURORA_L2 compiler recomputes binding status"
      actor: system
      command: "./scripts/tools/run_aurora_l2_pipeline.sh"
      output: "binding_status: DRAFT → BOUND"

    - step: 5
      name: "UI Enables Button"
      description: "Projection rules enable button for BOUND panels"
      actor: ui
      output: "Action button enabled"

  observation_contract:
    required_fields:
      - scenario_id
      - status (must be PASSED)
      - observed_at
      - capabilities_observed
    capability_fields:
      - capability_id
      - ui_panel
      - endpoint
      - method
      - observed_effects

  forbidden:
    - "Backend cannot run observation applier"
    - "UI cannot emit observations"
    - "Manual editing of observation metadata"
    - "Skipping observation file (direct YAML edit)"
    - "Observation applier writing TRUSTED status"

  guarantees:
    - "Backend cannot self-approve"
    - "UI cannot guess"
    - "SDSR cannot overreach"
    - "Compiler never infers"
    - "Truth moves only when real scenario caused real effect"

# =============================================================================
# TRIGGER AUTHORITY MAP
# =============================================================================

trigger_authority:
  description: |
    Explicit triggers that may advance capability state.
    No other path is allowed.

  triggers:
    - trigger: "Capability YAML edited"
      owner: backend_team
      effect: "DISCOVERED → DECLARED"

    - trigger: "SDSR observation file written + applier run"
      owner: system
      effect: "DECLARED → OBSERVED"

    - trigger: "Governance approval"
      owner: governance
      effect: "OBSERVED → TRUSTED"

    - trigger: "Compiler run"
      owner: system
      effect: "Recomputes binding status"

    - trigger: "UI render"
      owner: ui
      effect: "Reflects binding status"

  invariant: |
    Nothing else moves state.
    Intent defines permission.
    Capability YAML defines claims.
    SDSR defines truth.
    AURORA_L2 reflects truth.
