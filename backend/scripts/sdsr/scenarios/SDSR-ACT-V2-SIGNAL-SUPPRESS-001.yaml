# SDSR Scenario: Signal Suppression
# Reference: Attention Feedback Loop Implementation Plan
# Invariants Tested:
#   - SIGNAL-SUPPRESS-001: Temporary suppression (15-1440 minutes)
#   - SIGNAL-SCOPE-001: Tenant-scoped suppression
#   - SIGNAL-ID-001: Canonical fingerprint derivation

scenario_id: SDSR-ACT-V2-SIGNAL-SUPPRESS-001
domain: ACTIVITY
capability: activity.signal_suppress
status: DECLARED

metadata:
  title: "Signal Suppression"
  description: "Validates that signal suppression creates audit entry with TTL, removes from attention queue, and reappears after expiry"
  author: "Claude Opus 4.5"
  created: "2026-01-19"
  version: "1.0"

# Prerequisites
prerequisites:
  - type: run_with_signal
    description: "A run with TIME_RISK signal must exist"
    state: LIVE
    risk_level: AT_RISK
    evaluation_outcome: NEAR_THRESHOLD

# Synthetic data injection
injection:
  tenant:
    id: "tenant-sdsr-suppress-001"
    name: "SDSR Signal Suppress Test Tenant"

  run:
    id: "run-sdsr-suppress-001"
    state: LIVE
    status: running
    risk_level: AT_RISK
    evaluation_outcome: NEAR_THRESHOLD
    risk_type: TIME
    started_at: "2026-01-19T11:00:00Z"

# Actions to execute
actions:
  - action: api_call
    order: 1
    description: "Get attention queue to verify signal exists"
    endpoint: "GET /api/v1/activity/attention-queue"
    headers:
      Authorization: "Bearer {test_jwt}"
    expected:
      status_code: 200
      body:
        queue:
          - run_id: "run-sdsr-suppress-001"
            suppressed_until: null

  - action: api_call
    order: 2
    description: "Suppress the signal for 60 minutes"
    endpoint: "POST /api/v1/activity/signals/{signal_fingerprint}/suppress"
    headers:
      Authorization: "Bearer {test_jwt}"
    body:
      run_id: "run-sdsr-suppress-001"
      signal_type: "TIME_RISK"
      risk_type: "TIME"
      duration_minutes: 60
      reason: "Known issue, suppressing for SDSR testing"
    expected:
      status_code: 200
      body:
        suppressed_until: "{computed_expiry}"

  - action: db_verify
    order: 3
    description: "Verify audit_ledger entry with suppress_until"
    query: |
      SELECT event_type, entity_type, after_state
      FROM audit_ledger
      WHERE tenant_id = 'tenant-sdsr-suppress-001'
        AND entity_type = 'SIGNAL'
      ORDER BY created_at DESC
      LIMIT 1
    expected:
      event_type: "SignalSuppressed"
      entity_type: "SIGNAL"
      after_state_has: "suppress_until"

  - action: api_call
    order: 4
    description: "Verify signal NOT in attention queue"
    endpoint: "GET /api/v1/activity/attention-queue"
    headers:
      Authorization: "Bearer {test_jwt}"
    expected:
      status_code: 200
      body:
        queue: []  # Empty because signal is suppressed

  - action: api_call
    order: 5
    description: "Verify signal still in signals list with feedback"
    endpoint: "GET /api/v1/activity/signals"
    headers:
      Authorization: "Bearer {test_jwt}"
    expected:
      status_code: 200
      body:
        signals:
          - signal_type: "TIME_RISK"
            feedback:
              suppressed_until: "{computed_expiry}"

  - action: api_call
    order: 6
    description: "Test invalid duration (too short)"
    endpoint: "POST /api/v1/activity/signals/{signal_fingerprint}/suppress"
    headers:
      Authorization: "Bearer {test_jwt}"
    body:
      run_id: "run-sdsr-suppress-001"
      signal_type: "TIME_RISK"
      risk_type: "TIME"
      duration_minutes: 5  # Invalid: less than 15
      reason: "Should fail"
    expected:
      status_code: 400
      body:
        error: "invalid_duration"
        constraint: "SIGNAL-SUPPRESS-001"

  - action: api_call
    order: 7
    description: "Test invalid duration (too long)"
    endpoint: "POST /api/v1/activity/signals/{signal_fingerprint}/suppress"
    headers:
      Authorization: "Bearer {test_jwt}"
    body:
      run_id: "run-sdsr-suppress-001"
      signal_type: "TIME_RISK"
      risk_type: "TIME"
      duration_minutes: 1500  # Invalid: more than 1440
      reason: "Should fail"
    expected:
      status_code: 400
      body:
        error: "invalid_duration"
        constraint: "SIGNAL-SUPPRESS-001"

# Assertions
assertions:
  - assert: signal_removed_from_attention_queue
    description: "Suppressed signal must not appear in attention queue"
    condition: "attention_queue.length == 0"

  - assert: signal_visible_in_signals_list
    description: "Suppressed signal still visible in signals list with feedback"
    condition: "signals[0].feedback.suppressed_until != null"

  - assert: audit_entry_has_suppress_until
    description: "Audit entry must have suppress_until in after_state"
    condition: "audit_ledger.after_state.suppress_until != null"

  - assert: duration_constraint_enforced
    description: "Duration must be validated (15-1440 minutes)"
    condition: "invalid_short_duration_rejected AND invalid_long_duration_rejected"

  - assert: tenant_scoped
    description: "Suppression applies to entire tenant (SIGNAL-SCOPE-001)"
    condition: "audit_ledger.tenant_id == 'tenant-sdsr-suppress-001'"

# Cleanup
cleanup:
  - type: delete_audit_entries
    tenant_id: "tenant-sdsr-suppress-001"
  - type: delete_run
    run_id: "run-sdsr-suppress-001"
  - type: delete_tenant
    tenant_id: "tenant-sdsr-suppress-001"
