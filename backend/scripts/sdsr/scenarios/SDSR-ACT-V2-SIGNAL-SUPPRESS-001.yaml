# SDSR Verification Scenario
# Scenario: SDSR-ACT-V2-SIGNAL-SUPPRESS-001
# Generated: 2026-01-19
#
# PURPOSE:
#   Verifies the Signal Suppression capability:
#   1. Suppress a signal via POST /activity/signals/{fp}/suppress
#   2. Verify audit_ledger entry created with suppress_until
#   3. Verify signal NOT in attention-queue while suppressed
#   4. Verify signal reappears after TTL expires
#
# INVARIANTS:
#   - SIGNAL-ID-001: Fingerprint validated server-side
#   - SIGNAL-SUPPRESS-001: Suppression is temporary (15-1440 min)
#   - SIGNAL-SCOPE-001: Suppression is tenant-scoped
#
# EXECUTION:
#   python aurora_sdsr_runner.py --scenario SDSR-ACT-V2-SIGNAL-SUPPRESS-001
#
scenario_id: SDSR-ACT-V2-SIGNAL-SUPPRESS-001
version: 1.0.0
name: Verify Signal Suppression
description: SDSR verification for signal suppression feedback loop
capability: activity.signals.suppress
panel_id: ACT-V2-SIGNAL-FEEDBACK
domain: ACTIVITY
auth:
  mode: MUTATE  # Writes to audit_ledger
metadata:
  generated_by: manual
  generated_at: '2026-01-19T00:00:00.000000+00:00'
  reference: Attention Feedback Loop Implementation Plan
  invariants:
    - SIGNAL-ID-001
    - SIGNAL-SUPPRESS-001
    - SIGNAL-SCOPE-001

# Prerequisites: Create a run with a signal first
setup:
  - type: create_synthetic_run
    params:
      state: LIVE
      risk_level: AT_RISK
      evaluation_outcome: NEAR_THRESHOLD
      risk_type: COST
    capture:
      run_id: created_run_id

inject:
  type: api_call
  endpoint: /api/v1/activity/signals/{signal_fingerprint}/suppress
  method: POST
  headers:
    Content-Type: application/json
  path_params:
    signal_fingerprint: "{{computed_fingerprint}}"
  body:
    run_id: "{{created_run_id}}"
    signal_type: COST_RISK
    risk_type: COST
    duration_minutes: 15  # Minimum allowed
    reason: "Suppressed via SDSR scenario"

expect:
  status_code: 200
  response_type: json
  response_shape:
    signal_fingerprint:
      type: string
      pattern: "^sig-[a-f0-9]{16}$"
    suppressed_until:
      type: datetime
      not_null: true

invariants:
  - id: INV-001
    name: response_success
    description: API returns 200 OK
    assertion: status_code == 200

  - id: INV-002
    name: fingerprint_format
    description: Fingerprint matches canonical format (SIGNAL-ID-001)
    assertion: response.signal_fingerprint matches "^sig-[a-f0-9]{16}$"

  - id: INV-003
    name: suppress_until_set
    description: suppressed_until is set to future time
    assertion: response.suppressed_until > NOW()

  - id: INV-004
    name: audit_entry_created
    description: Audit ledger entry exists with suppress_until
    assertion: |
      SELECT COUNT(*) FROM audit_ledger
      WHERE entity_type = 'SIGNAL'
        AND event_type = 'SignalSuppressed'
        AND entity_id = response.signal_fingerprint
        AND after_state->>'suppress_until' IS NOT NULL
      > 0

  - id: INV-005
    name: signal_not_in_attention_queue
    description: Suppressed signal excluded from attention queue
    assertion: |
      GET /api/v1/activity/attention-queue does NOT include suppressed signal
      (unless include_suppressed=true)

  - id: INV-006
    name: duration_constraints
    description: Duration validated (SIGNAL-SUPPRESS-001)
    assertion: |
      POST with duration_minutes < 15 returns 400
      POST with duration_minutes > 1440 returns 400

  - id: INV-007
    name: tenant_scoped
    description: Suppression applies to entire tenant (SIGNAL-SCOPE-001)
    assertion: |
      Signal hidden for all tenant users, not just suppressing actor

cleanup:
  required: true
  note: Remove synthetic run after verification
  steps:
    - type: delete_synthetic_run
      params:
        run_id: "{{created_run_id}}"

on_success:
  update_capability_status: OBSERVED
  emit_observation: true

on_failure:
  update_capability_status: null
  emit_observation: true
  failure_taxonomy:
    endpoint_missing: Backend route does not exist
    auth_failed: Authentication/authorization issue
    schema_mismatch: Response shape does not match contract
    invariant_violated: One or more invariants failed
    signal_still_visible: Signal not correctly hidden after suppression
    duration_not_enforced: Duration constraints not enforced
