# SDSR Verification Scenario
# Scenario: SDSR-ACT-V2-SIGNAL-ACK-001
# Generated: 2026-01-19
#
# PURPOSE:
#   Verifies the Signal Acknowledgment capability:
#   1. Acknowledge a signal via POST /activity/signals/{fp}/ack
#   2. Verify audit_ledger entry created
#   3. Verify signal still visible with feedback.acknowledged = true
#   4. Verify attention score dampening (0.6x) applied
#
# INVARIANTS:
#   - SIGNAL-ID-001: Fingerprint validated server-side
#   - SIGNAL-ACK-001: Acknowledgment records responsibility
#   - ATTN-DAMP-001: Dampening is idempotent (0.6x)
#
# EXECUTION:
#   python aurora_sdsr_runner.py --scenario SDSR-ACT-V2-SIGNAL-ACK-001
#
scenario_id: SDSR-ACT-V2-SIGNAL-ACK-001
version: 1.0.0
name: Verify Signal Acknowledgment
description: SDSR verification for signal acknowledgment feedback loop
capability: activity.signals.ack
panel_id: ACT-V2-SIGNAL-FEEDBACK
domain: ACTIVITY
auth:
  mode: MUTATE  # Writes to audit_ledger
metadata:
  generated_by: manual
  generated_at: '2026-01-19T00:00:00.000000+00:00'
  reference: Attention Feedback Loop Implementation Plan
  invariants:
    - SIGNAL-ID-001
    - SIGNAL-ACK-001
    - ATTN-DAMP-001

# Prerequisites: Create a run with a signal first
setup:
  - type: create_synthetic_run
    params:
      state: LIVE
      risk_level: AT_RISK
      evaluation_outcome: NEAR_THRESHOLD
      risk_type: COST
    capture:
      run_id: created_run_id

inject:
  type: api_call
  endpoint: /api/v1/activity/signals/{signal_fingerprint}/ack
  method: POST
  headers:
    Content-Type: application/json
  path_params:
    signal_fingerprint: "{{computed_fingerprint}}"
  body:
    run_id: "{{created_run_id}}"
    signal_type: COST_RISK
    risk_type: COST
    comment: "Acknowledged via SDSR scenario"

expect:
  status_code: 200
  response_type: json
  response_shape:
    signal_fingerprint:
      type: string
      pattern: "^sig-[a-f0-9]{16}$"
    acknowledged:
      type: boolean
      value: true
    acknowledged_by:
      type: string
      not_null: true
    acknowledged_at:
      type: datetime
      not_null: true

invariants:
  - id: INV-001
    name: response_success
    description: API returns 200 OK
    assertion: status_code == 200

  - id: INV-002
    name: fingerprint_format
    description: Fingerprint matches canonical format (SIGNAL-ID-001)
    assertion: response.signal_fingerprint matches "^sig-[a-f0-9]{16}$"

  - id: INV-003
    name: acknowledged_true
    description: Acknowledged flag is true (SIGNAL-ACK-001)
    assertion: response.acknowledged == true

  - id: INV-004
    name: audit_entry_created
    description: Audit ledger entry exists for acknowledgment
    assertion: |
      SELECT COUNT(*) FROM audit_ledger
      WHERE entity_type = 'SIGNAL'
        AND event_type = 'SignalAcknowledged'
        AND entity_id = response.signal_fingerprint
      > 0

  - id: INV-005
    name: signal_still_visible
    description: Acknowledged signal remains visible (SIGNAL-ACK-001)
    assertion: |
      GET /api/v1/activity/signals returns signal with feedback.acknowledged = true

  - id: INV-006
    name: dampening_applied
    description: Attention score dampened by 0.6x (ATTN-DAMP-001)
    assertion: |
      Attention queue effective_score = base_score * 0.6 for acknowledged signals

cleanup:
  required: true
  note: Remove synthetic run after verification
  steps:
    - type: delete_synthetic_run
      params:
        run_id: "{{created_run_id}}"

on_success:
  update_capability_status: OBSERVED
  emit_observation: true

on_failure:
  update_capability_status: null
  emit_observation: true
  failure_taxonomy:
    endpoint_missing: Backend route does not exist
    auth_failed: Authentication/authorization issue
    schema_mismatch: Response shape does not match contract
    invariant_violated: One or more invariants failed
    signal_not_visible: Signal was incorrectly hidden after acknowledgment
    dampening_not_applied: Attention score not dampened
