# Layer: L8 â€” Catalyst / Meta
# Product: system-wide
# Temporal:
#   Trigger: manual | CI
#   Execution: async
# Role: SDSR scenario to observe Incidents Summary capability
# Reference: PIN-417 (HIL v1 Phase 4)
#
# PURPOSE:
# Prove the /api/v1/incidents/summary endpoint works correctly
# and advances summary.incidents capability to OBSERVED.
#
# SDSR observes CAPABILITIES, not panels.
# Panels light up later via AURORA compilation.
#
# MACHINE QUALITY LAYERS:
# 1. Schema validation (contract shape)
# 2. Semantic invariants (self-consistency)
# 3. Registry validation (no free strings)
# 4. Failure taxonomy (structured diagnostics)

scenario_id: SDSR-HIL-INC-SUM-001
name: Observe Incidents Summary Capability
domain: Incidents
version: "1.0"

capabilities:
  - summary.incidents

# Layer 1: Schema contract (pre-check)
schema_validation:
  response_schema: backend/contracts/incidents_summary.schema.json
  fail_fast: true  # Schema failure = immediate abort

steps:
  - step_id: call_incidents_summary
    action: http_call
    request:
      method: GET
      endpoint: /api/v1/incidents/summary
      params:
        window: "24h"
    # Scenario-level expected values (no hardcoded literals in invariants)
    expected:
      window: "24h"

    # Layer 1: Shape validation
    expect:
      http_status: 200
      fields_exist:
        - window
        - incidents.total
        - incidents.by_lifecycle_state.active
        - incidents.by_lifecycle_state.acked
        - incidents.by_lifecycle_state.resolved
        - attention.count
        - attention.reasons
        - provenance.derived_from
        - provenance.aggregation
        - provenance.generated_at

    # Layer 2: Semantic invariants
    invariants:
      # Reconciliation: lifecycle states must sum to total
      - id: INV-001
        name: lifecycle_sum_reconciliation
        expression: "incidents.by_lifecycle_state.active + incidents.by_lifecycle_state.acked + incidents.by_lifecycle_state.resolved == incidents.total"
        failure_type: INVARIANT_VIOLATION
        severity: BLOCKING

      # Attention count matches active incidents (attention = unresolved)
      - id: INV-002
        name: attention_count_matches_active
        expression: "attention.count == incidents.by_lifecycle_state.active"
        failure_type: INVARIANT_VIOLATION
        severity: BLOCKING

      # Window echoed correctly (references scenario expected value, not literal)
      - id: INV-003
        name: window_echo
        expression: "window == expected.window"
        failure_type: CONTRACT_VIOLATION
        severity: BLOCKING

      # Attention consistency: reasons present implies count > 0
      - id: INV-004
        name: attention_reasons_imply_count
        expression: "len(attention.reasons) > 0 implies attention.count > 0"
        failure_type: SEMANTIC_VIOLATION
        severity: BLOCKING

      # Attention consistency inverse: zero count implies zero reasons
      - id: INV-004b
        name: attention_zero_count_zero_reasons
        expression: "attention.count == 0 implies len(attention.reasons) == 0"
        failure_type: SEMANTIC_VIOLATION
        severity: BLOCKING

      # Provenance always present
      - id: INV-005
        name: provenance_present
        expression: "len(provenance.derived_from) > 0"
        failure_type: CONTRACT_VIOLATION
        severity: BLOCKING

      # Timestamp sanity
      - id: INV-006
        name: timestamp_not_future
        expression: "parse_iso(provenance.generated_at) <= now()"
        failure_type: TEMPORAL_VIOLATION
        severity: WARNING

      # Aggregation type locked
      - id: INV-007
        name: aggregation_type_locked
        expression: "provenance.aggregation == 'STATUS_BREAKDOWN'"
        failure_type: CONTRACT_VIOLATION
        severity: BLOCKING

    # Layer 3: Registry validation
    registry_checks:
      - id: REG-001
        name: attention_reasons_registry
        field: attention.reasons
        registry: backend/aurora_l2/registries/incidents_attention_reasons.yaml
        registry_path: reasons
        rule: subset
        failure_type: REGISTRY_VIOLATION
        severity: BLOCKING

# Layer 4: Failure taxonomy
failure_taxonomy:
  categories:
    SCHEMA_VIOLATION:
      description: Response shape does not match contract
      action: Fix backend serialization
      blocks_advancement: true

    INVARIANT_VIOLATION:
      description: Response is internally inconsistent
      action: Fix backend computation logic
      blocks_advancement: true

    CONTRACT_VIOLATION:
      description: Response violates API contract
      action: Fix endpoint implementation
      blocks_advancement: true

    SEMANTIC_VIOLATION:
      description: Response has illogical meaning
      action: Review business logic
      blocks_advancement: true

    REGISTRY_VIOLATION:
      description: Response contains unregistered values
      action: Update registry or fix emission
      blocks_advancement: true

    TEMPORAL_VIOLATION:
      description: Timestamp constraints violated
      action: Review clock/timezone handling
      blocks_advancement: false  # Warning only

  output_format:
    type: structured_json
    fields:
      - failure_id
      - failure_type
      - field_path
      - expected
      - observed
      - severity
      - action

on_success:
  advance_capabilities:
    summary.incidents: OBSERVED

on_failure:
  emit_diagnostics: true
  block_advancement: true
  log_structured_failure: true
