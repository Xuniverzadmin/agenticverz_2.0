# SDSR Loop Assertion Scenario
# Scenario: SDSR-POL-LOOP-004
# Created: 2026-01-19
# Reference: PIN-447, POLICY_DOMAIN_V2_DESIGN.md
#
# PURPOSE:
#   LOOP INVARIANT: Activity resilience
#
#   This scenario verifies that:
#   1. Activity domain can read policy_context via V2 facade
#   2. Thresholds endpoint returns cacheable data
#   3. Activity can function with cached data if Policy unavailable
#
# RESILIENCE RULE:
#   Activity MUST continue with cached policy_context when
#   Policy facade is unavailable. Activity completes normally.
#
# EXECUTION:
#   python aurora_sdsr_runner.py --scenario SDSR-POL-LOOP-004
#
scenario_id: SDSR-POL-LOOP-004
version: 1.0.0
name: Activity resilience (Loop Invariant)
description: >
  Verifies the SDSR loop invariant that Activity domain can
  access policy_context via the V2 facade endpoints. Validates
  that threshold data is cacheable for resilience.

capability: policy.thresholds
panel_id: POL-FACADE-THRESHOLDS-O2
domain: POLICIES
subdomain: LIMITS
topic: THRESHOLDS

auth:
  mode: OBSERVER

metadata:
  generated_by: manual-pin447
  generated_at: '2026-01-19'
  loop_invariant: ACTIVITY_RESILIENCE
  cross_domain_rule: Activity caches policy_context
  contract_ref: CROSS_DOMAIN_POLICY_CONTRACT.md Section 7.1

# Step 1: Query thresholds (what Activity needs for policy_context)
inject:
  type: api_call
  endpoint: /api/v1/policy/thresholds
  method: GET
  headers:
    Content-Type: application/json
  params:
    status: ACTIVE
    limit: 10

expect:
  status_code: 200
  response_type: json
  response_shape:
    items: list
    total: int
    has_more: bool

invariants:
- id: INV-LOOP-001
  name: threshold_has_facade_ref
  description: Every threshold has facade_ref for cross-domain navigation
  assertion: >
    all('facade_ref' in t for t in response.get('items', []))
    or len(response.get('items', [])) == 0
  severity: BLOCKING

- id: INV-LOOP-002
  name: threshold_has_enforcement
  description: Every threshold has enforcement mode
  assertion: >
    all('enforcement' in t for t in response.get('items', []))
    or len(response.get('items', [])) == 0
  severity: BLOCKING

- id: INV-LOOP-003
  name: threshold_has_max_value
  description: Every threshold has max_value (cacheable limit)
  assertion: >
    all('max_value' in t for t in response.get('items', []))
    or len(response.get('items', [])) == 0
  severity: BLOCKING

- id: INV-LOOP-004
  name: threshold_is_cacheable
  description: Response is deterministic and cacheable
  assertion: >
    'items' in response and
    'total' in response and
    isinstance(response.get('items'), list)
  severity: BLOCKING

- id: INV-LOOP-005
  name: thresholds_endpoint_exists
  description: V2 facade thresholds endpoint is functional
  assertion: status_code == 200
  severity: BLOCKING

# Additional check: Active policies endpoint (also needed for policy_context)
chain_scenarios:
- scenario_id: SDSR-POL-LOOP-004-ACTIVE
  description: Verify active policies endpoint is functional (part of resilience)
  inject:
    type: api_call
    endpoint: /api/v1/policy/active
    method: GET
  expect:
    status_code: 200
  invariants:
  - id: INV-ACTIVE-001
    name: active_policies_cacheable
    description: Active policies response is cacheable
    assertion: "'items' in response"

cleanup:
  required: false
  note: Read-only observation, no cleanup needed

on_success:
  update_capability_status: OBSERVED
  emit_observation: true
  loop_assertion_passed: ACTIVITY_RESILIENCE

on_failure:
  update_capability_status: null
  emit_observation: true
  failure_taxonomy:
    loop_invariant_violated: Activity-resilience contract broken
    endpoint_missing: V2 facade endpoint not available
    auth_failed: Authentication/authorization issue
    caching_broken: Response not suitable for caching
