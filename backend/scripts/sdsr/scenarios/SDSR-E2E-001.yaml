scenario_id: SDSR-E2E-001
name: Failed Activity propagates to Incident, Policy Proposal, and Logs
domain: CROSS_DOMAIN

# -----------------------------------------
# CERTIFICATION STATUS
# -----------------------------------------
# REVOKED: 2026-01-10
# Previous certification was INVALID - used WORKER_EXECUTION path, not STATE_INJECTION.
# Observed: severity=MEDIUM, error_code=UNKNOWN, policy_proposals=0
# Expected: severity=HIGH, error_code=EXECUTION_TIMEOUT, policy_proposals=1
# Root cause: failure_code forced status=queued, worker executed with SKILL_NOT_FOUND
# This revision corrects to true STATE_INJECTION mode.

# -----------------------------------------
# SCENARIO CLASSIFICATION (MANDATORY)
# -----------------------------------------
scenario_class: STATE_INJECTION
execution_mode: non_executable

# This scenario injects a failed run state directly.
# Engine propagation (Incident, Policy) is verified, but traces are injected.

coverage:
  engine_propagation: true
  worker_execution: false
  trace_generation: false  # Traces are expectation, not generated
  ui_observation: true

purpose: >
  Validate full backend-first causality via state injection:
  Activity failure → Incident Engine → Policy Proposal Engine → Logs,
  with UI rendering via projection only.

  NOTE: This scenario injects failure state directly. It verifies that
  engines react correctly to failure, but does not validate worker
  execution or trace creation. See SDSR-E2E-005 for execution path.

tags:
  - e2e
  - cross-domain
  - sdsr
  - state-injection
  - baseline

synthetic:
  enabled: true
  cleanup_required: true

# ─────────────────────────────────────────────
# Preconditions (Must exist or be created here)
# ─────────────────────────────────────────────
preconditions:
  tenant:
    create: true
    tenant_id: sdsr-tenant-e2e
  api_key:
    create: true
    scopes: [activity:write, incidents:read, policies:read]
  agent:
    create: true
    agent_id: sdsr-agent-e2e

# ─────────────────────────────────────────────
# Scenario Steps (CAUSE only)
# ─────────────────────────────────────────────
steps:

  - step_id: ACTIVITY-FAIL
    description: Inject failed run state with HIGH severity error
    action: create_run
    data:
      # run_id auto-generated per RG-SDSR-01
      agent_id: sdsr-agent-e2e
      status: failed  # STATE_INJECTION: Direct failed state
      goal: "SDSR E2E-001: Failed activity propagation test"
      failure_message: "EXECUTION_TIMEOUT: Execution timed out during step execution"
    expectations:
      db:
        table: runs
        conditions:
          status: failed
          is_synthetic: true
          synthetic_scenario_id: SDSR-E2E-001
          # STATE_INJECTION marker: started_at should be NULL (no worker execution)

# ─────────────────────────────────────────────
# Expected Backend Propagation (ENGINES ONLY)
# ─────────────────────────────────────────────
expected_propagation:

  - from: runs
    via: IncidentEngine
    creates:
      table: incidents
      conditions:
        severity: HIGH  # EXECUTION_TIMEOUT maps to HIGH
        status: OPEN
        is_synthetic: true
        synthetic_scenario_id: SDSR-E2E-001

  - from: incidents
    via: PolicyProposalEngine
    creates:
      table: policy_proposals
      conditions:
        status: draft
        is_synthetic: true
        synthetic_scenario_id: SDSR-E2E-001

# NOTE: STATE_INJECTION mode does NOT create traces.
# Trace expectations are commented out for this mode.
# See SDSR-E2E-005 for WORKER_EXECUTION trace validation.
#
#  - from: runs
#    via: ExecutionEngine
#    creates:
#      table: aos_traces
#      ...
#
#  - from: aos_traces
#    via: ExecutionEngine
#    creates:
#      table: aos_trace_steps
#      ...

# ─────────────────────────────────────────────
# Expected UI Observation (READ ONLY)
# ─────────────────────────────────────────────
expected_ui:

  activity:
    panel_id: ACT-EX-AR-O2
    observes:
      table: runs
      conditions:
        status: failed
        has_sdsr_badge: true

  incidents:
    panel_id: INC-AI-OI-O2
    observes:
      table: incidents
      conditions:
        severity: HIGH
        has_sdsr_badge: true

  policies:
    panel_id: POL-PR-PP-O2
    observes:
      table: policy_proposals
      conditions:
        status: draft
        has_approve_reject_controls: true
        has_sdsr_badge: true

  # NOTE: Logs panel not applicable in STATE_INJECTION mode
  # (no traces created). See SDSR-E2E-005 for log validation.

# ─────────────────────────────────────────────
# Non-Goals (Enforced)
# ─────────────────────────────────────────────
forbidden:
  - directly_create_incidents
  - directly_create_policy_rules
  - directly_write_logs
  - directly_create_traces  # STATE_INJECTION does not create traces
  - bypass_engines
  - simulate_ui_state

non_goals:
  - test_worker_execution  # Covered by E2E-005
  - test_trace_generation  # Covered by E2E-005

# ─────────────────────────────────────────────
# Cleanup (MANDATORY)
# ─────────────────────────────────────────────
cleanup:
  order:
    - policy_proposals
    - policy_rules
    - prevention_records
    - incidents
    # NOTE: Traces are expected to be zero in STATE_INJECTION mode.
    # Archival logic applies if any exist (S6 immutability contract).
    - aos_trace_steps
    - aos_traces
    - runs
    - agents
    - api_keys
    - tenants
  where:
    synthetic_scenario_id: SDSR-E2E-001
  archive_traces: true
  record_metrics_before_cleanup: true
  note: >
    Traces are expected to be zero; archival logic applies if any exist.
    This aligns with S6 immutability semantics.
